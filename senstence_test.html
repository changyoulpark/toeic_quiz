

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì˜ì–´ í•™ìŠµ ë„ìš°ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        button { min-height: 44px !important; min-width: 44px; padding: 0.5rem 1rem; }
        .dashboard-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; min-height: 44px; min-width: 44px; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .feedback-correct { background-color: #dcfce7; border-left-color: #22c55e; }
        .feedback-incorrect { background-color: #fee2e2; border-left-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="container mx-auto p-4 max-w-5xl">
        <header class="text-center my-8">
            <div class="flex justify-between items-center mb-6">
                <button onclick="window.location.href='index.html'" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg text-sm transition duration-300" style="min-height: 44px;">
                    â† ê¸°ë³¸ í€´ì¦ˆë¡œ
                </button>
                <div></div>
            </div>
            <h1 class="text-4xl font-bold text-indigo-700">ìŠ¤ë§ˆíŠ¸ ì˜ì–´ í•™ìŠµ ë„ìš°ë¯¸</h1>
            <p class="text-slate-600 mt-2">ì˜¤ëŠ˜ë„ ëª©í‘œë¥¼ í–¥í•´ í•¨ê»˜ ë‚˜ì•„ê°€ìš”!</p>
        </header>

        <main id="app-container">
            <!-- í•™ìŠµ ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
            <div id="dashboard-screen">
                <!-- Plan Mode: Today's Plan -->
                <div class="mb-8 border-2 border-indigo-200 bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-6">
                    <h2 class="text-3xl font-bold mb-4 flex items-center text-indigo-700">
                        <span class="text-4xl mr-3">ğŸ“…</span> ì˜¤ëŠ˜ì˜ ê³„íš (Plan ëª¨ë“œ)
                    </h2>
                    <div id="daily-plan-summary" class="mb-4">
                        <!-- Daily plan summary will be inserted here -->
                    </div>
                    <div class="flex gap-4 mb-4">
                        <button id="start-daily-plan-btn" class="btn btn-primary text-lg px-6 py-3">
                            ğŸ“š ì˜¤ëŠ˜ í•™ìŠµ ì‹œì‘
                        </button>
                        <button id="plan-settings-btn" class="btn btn-secondary">
                            âš™ï¸ ê³„íš ì„¤ì •
                        </button>
                    </div>
                    
                    <!-- Review Timeline Widget -->
                    <div class="mt-6 border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-indigo-700">ğŸ“‹ ë³µìŠµ íƒ€ì„ë¼ì¸</h3>
                            <div class="flex gap-2 text-sm">
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded">ë³µìŠµ <span id="review-now-count">0</span></span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">ì˜ˆì • <span id="upcoming-count">0</span></span>
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded">ì‹ ê·œ <span id="new-items-count">0</span></span>
                            </div>
                        </div>
                        <div id="timeline-container" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar bg-white rounded-lg p-3 border border-indigo-200">
                            <!-- Timeline items will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Drill Mode: Free Study -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-slate-700">
                        <span class="text-3xl mr-3">ğŸ¯</span> ììœ  í•™ìŠµ (Drill ëª¨ë“œ)
                    </h2>
                    <div class="text-sm text-slate-500 mb-4">
                        ì›í•˜ëŠ” ë‚´ìš©ì„ ììœ ë¡­ê²Œ íƒìƒ‰í•˜ë©° í•™ìŠµí•˜ì„¸ìš”. ê¸°ë³¸ì ìœ¼ë¡œ ë£¨í‹´ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </div>
                </div>
                
                <!-- Legacy Review Card (now part of Drill mode) -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-3 flex items-center"><span class="text-2xl mr-2">ğŸ§ </span> ë³µìŠµ ì—°ìŠµ</h3>
                    <div id="review-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                        <h3 class="font-semibold text-lg text-indigo-800">ê°„ê²© ë³µìŠµ ì—°ìŠµ</h3>
                        <p class="text-slate-600 mt-1">í•™ìŠµí•œ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ë³µìŠµí•´ë³´ì„¸ìš”. í˜„ì¬ ë³µìŠµ ê°€ëŠ¥í•œ í•­ëª©ì´ <span id="review-count" class="font-bold text-indigo-500"></span>ê°œ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">ğŸ“š</span> ìƒˆë¡œìš´ í•™ìŠµ</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div id="cheonilmun-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-sky-800">[Input] ì²œì¼ë¬¸ êµ¬ì¡° ë¶„ì„</h3>
                            <p class="text-slate-600 mt-1">ë¬¸ë²• ê°œë…ì„ ì´í•´í•˜ê³ , ë¬¸ì¥ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ë©° ë…í•´ì˜ ê¸°ë³¸ê¸°ë¥¼ ë‹¤ì§‘ë‹ˆë‹¤.</p>
                        </div>
                        <div id="pattern-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-emerald-800">[Output] ìƒí™œì˜ì–´ íŒ¨í„´ ì²´í™”</h3>
                            <p class="text-slate-600 mt-1">í•µì‹¬ íšŒí™” íŒ¨í„´ì„ ì‘ìš© ì‘ë¬¸í•˜ë©° ë§í•˜ê¸°ì™€ ì“°ê¸° ìˆœë°œë ¥ì„ ê¸°ë¦…ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">ğŸ”¬</span> ë‚˜ì˜ ë¬¸ì¥</h2>
                        <div id="academic-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-amber-800">ë…¼ë¬¸/ì›ì„œ ë¬¸ì¥ ì¶”ê°€í•˜ê¸°</h3>
                            <p class="text-slate-600 mt-1">ì‹¤ì œ ì ‘í•˜ëŠ” ë¬¸ì¥ì„ ë¶„ì„í•˜ê³ , ê°œì¸í™”ëœ ë³µìŠµ í€´ì¦ˆë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">ğŸ—‚ï¸</span> ì „ì²´ ìë£Œì‹¤</h2>
                        <div id="library-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-slate-800">í•™ìŠµ ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒìƒ‰</h3>
                            <p class="text-slate-600 mt-1">ì§€ê¸ˆê¹Œì§€ í•™ìŠµí•œ ëª¨ë“  ë‚´ìš©ì„ ììœ ë¡­ê²Œ ê²€ìƒ‰í•˜ê³  ë³µìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ìŠµ ëª¨ë“ˆ í™”ë©´ (ë™ì  ìƒì„±) -->
            <div id="module-screen" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 id="module-title" class="text-3xl font-bold"></h2>
                    <button id="back-to-dashboard-btn" class="btn btn-secondary">ëŒ€ì‹œë³´ë“œë¡œ</button>
                </div>
                <div id="module-content" class="bg-white p-6 rounded-lg shadow-lg min-h-[60vh]">
                    <!-- ê° ëª¨ë“ˆì˜ ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </main>
    </div>

    <!-- Plan Settings Modal -->
    <div id="plan-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">ğŸ“‹ ì˜¤ëŠ˜ì˜ ê³„íš ì„¤ì •</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ì¼ì¼ ë³µìŠµ ëª©í‘œ (ê°œ)
                    </label>
                    <input type="number" id="daily-review-cap" min="5" max="50" value="10" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ì¼ì¼ ì‹ ê·œ í•™ìŠµ ëª©í‘œ (ê°œ)
                    </label>
                    <input type="number" id="daily-new-limit" min="2" max="20" value="5" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="drill-affects-routine" class="mr-2">
                        <span class="text-sm">ë“œë¦´ í•™ìŠµë„ ì‹ ê·œ í•™ìŠµìœ¼ë¡œ ë“±ë¡</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="save-plan-settings" class="btn btn-primary flex-1">ì €ì¥</button>
                <button id="cancel-plan-settings" class="btn btn-secondary flex-1">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // --- ë°ì´í„°ë² ì´ìŠ¤ (masterData) ---
        const masterData = {
            cheonilmun: [],
            patterns: [],
            academic: []
        };

        // --- ì›ë³¸ í•™ìŠµ ìë£Œ (ì‚­ì œ ë°©ì§€ìš©) ---
        const originalData = {
            cheonilmun: [],
            patterns: []
        };

        // --- ì•± ìƒíƒœ ê´€ë¦¬ ---
        let sessionState = {
            queue: [],
            currentIndex: 0,
        };
        
        // ë°ì´í„° ë¡œë”© ìƒíƒœ ê´€ë¦¬
        let dataLoaded = false;

        // --- ê°„ê²© ë³µìŠµ ì‹œìŠ¤í…œ ---
        const SPACED_REPETITION_INTERVALS = [
            1,    // 1ì¼ í›„
            3,    // 3ì¼ í›„  
            7,    // 1ì£¼ì¼ í›„
            14,   // 2ì£¼ì¼ í›„
            30,   // 1ê°œì›” í›„
            60,   // 2ê°œì›” í›„
            120   // 4ê°œì›” í›„
        ];

        // --- Gemini API Integration ---
        // API key should be configured securely - using fallback mode for security
        const GEMINI_API_KEY = null; // Removed for security - implement server-side proxy
        
        async function callGemini(prompt, isJson = true) {
            // Security check - API key removed for client-side security
            if (!GEMINI_API_KEY) {
                console.warn("Gemini API key not configured - using fallback mode");
                return null;
            }
            
            const generationConfig = isJson ? { 
                "responseMimeType": "application/json", 
                "temperature": 0.6 
            } : { 
                "temperature": 0.4 
            };
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }], 
                generationConfig 
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (responseText) {
                    return isJson ? JSON.parse(responseText) : responseText;
                } else { 
                    throw new Error("Invalid response structure from API"); 
                }
            } catch (error) { 
                console.error("Gemini API call failed:", error); 
                return null; 
            }
        }

        async function generatePatternTaskWithGemini(pattern, patternKo) {
            const prompt = `You are an English learning assistant for Korean students. For the pattern "${pattern}" (${patternKo}), create a flexible learning task. 

IMPORTANT: You must return a valid JSON object with ALL required fields. Do not include any markdown formatting or extra text.

Return exactly this JSON structure:
{
  "task_type": "creation",
  "instruction": "Korean instruction explaining what to do",
  "example_input": "Example scenario or context (optional, can be empty string)",
  "sample_answer": "Good example sentence using the pattern",
  "evaluation_criteria": "Korean criteria for good answers",
  "hints": ["Korean hint 1", "Korean hint 2", "Korean hint 3"]
}

Requirements:
- instruction: Must be clear Korean instructions (required)
- example_input: A specific situation or context (can be empty string if not needed)
- sample_answer: Must demonstrate correct usage of "${pattern}"
- hints: Exactly 3 helpful tips in Korean
- Make the task engaging and practical

Example for "${pattern}": Focus on real-life situations where this pattern is commonly used.`;

            return await callGemini(prompt);
        }

        async function evaluatePatternAnswerWithGemini(pattern, patternKo, userAnswer, taskType) {
            const prompt = `You are evaluating a Korean student's use of the English pattern "${pattern}" (${patternKo}). 

Student's answer: "${userAnswer}"
Task type: ${taskType}

Provide constructive feedback with detailed comparison analysis. Return exactly this JSON structure:
{
  "is_correct": true,
  "feedback": "Korean encouraging feedback",
  "suggestions": ["Korean improvement tip 1", "Korean improvement tip 2"],
  "score": 4,
  "corrected_version": "Improved version if needed",
  "detailed_comparison": {
    "grammar_analysis": "Korean explanation of grammar differences",
    "tone_analysis": "Korean explanation of tone/nuance differences", 
    "usage_analysis": "Korean explanation of usage appropriateness"
  }
}

Requirements:
- is_correct: boolean indicating proper pattern usage
- feedback: Encouraging feedback in Korean (required)
- suggestions: Array of 1-2 specific improvements in Korean
- score: Number 1-5 indicating quality (required)
- corrected_version: Better version if applicable (empty string if not needed)
- detailed_comparison: Must include grammar, tone, and usage analysis in Korean

Be encouraging but provide specific detailed analysis comparing the student's answer with optimal usage. Focus on explaining WHY differences matter for natural English communication.`;

            return await callGemini(prompt);
        }

        // Handle pattern items in review mode with AI evaluation
        async function handlePatternReviewAnswer(item, userAnswer, alreadyProcessed) {
            const itemId = String(getItemId(item));
            
            // Show loading feedback first
            let feedbackHtml = `
                <div class="p-4 border-l-4 rounded-md feedback-correct">
                    <div class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="font-bold">AIê°€ íŒ¨í„´ ì‚¬ìš©ì„ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    </div>
                </div>
            `;
            
            document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
            
            try {
                // Evaluate with Gemini AI
                const evaluation = await evaluatePatternAnswerWithGemini(item.pattern, item.pattern_ko, userAnswer, 'review');
                
                let grade = 3; // Default: good
                let isCorrect = true;
                let result = null;
                
                if (evaluation && typeof evaluation === 'object') {
                    // Use AI evaluation to determine correctness and grade
                    isCorrect = evaluation.is_correct || false;
                    
                    // Convert AI score (1-5) to SM-2 grade (0-4)
                    const aiScore = evaluation.score || 3;
                    if (!userAnswer || userAnswer.trim() === '') {
                        grade = 0; // No answer
                        isCorrect = false;
                    } else if (isCorrect && aiScore >= 4) {
                        grade = 4; // Easy/correct
                    } else if (isCorrect && aiScore >= 3) {
                        grade = 3; // Good
                    } else if (aiScore >= 2) {
                        grade = 2; // Hard but acceptable
                    } else {
                        grade = 1; // Wrong
                        isCorrect = false;
                    }
                } else {
                    // Fallback: assume they tried
                    grade = 3;
                    isCorrect = true;
                }
                
                // Update SM-2 schedule only if not already processed
                if (!alreadyProcessed) {
                    result = calculateNextReview(item, grade);
                    
                    // Remove from today queue if this was a first exposure
                    if (isTodayQueueItem(itemId)) {
                        removeFromTodayQueue(itemId);
                    }
                    
                    // Record result in plan session
                    planSession.results[planSession.phase].items.push({
                        ...item,
                        grade,
                        isCorrect,
                        userAnswer
                    });
                    
                    if (isCorrect) {
                        planSession.results[planSession.phase].correct++;
                    }
                } else {
                    // For already processed items, get current progress for display
                    const progress = loadPlanProgress();
                    const currentProgress = progress[itemId];
                    if (currentProgress) {
                        result = {
                            ...currentProgress,
                            intervalDays: Math.round((currentProgress.next - currentProgress.last) / (24 * 60 * 60 * 1000))
                        };
                    }
                    console.log('Item already processed in this session, not updating review schedule');
                }
                
                // Show AI-powered feedback
                if (evaluation && typeof evaluation === 'object') {
                    const nextDate = result ? new Date(result.next).toLocaleDateString('ko-KR') : 'ê³„ì‚° ì¤‘';
                    
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                            <p class="font-bold">${evaluation.is_correct ? 'í›Œë¥­í•©ë‹ˆë‹¤! ğŸ‰' : 'ì¢‹ì€ ì‹œë„ì…ë‹ˆë‹¤! ğŸ’ª'}</p>
                            <div class="mt-3 space-y-3">
                                <div class="bg-white p-3 rounded-lg">
                                    <p class="font-medium text-gray-800">AI í”¼ë“œë°±:</p>
                                    <p class="text-gray-700">${evaluation.feedback || 'ì¢‹ì€ ì‹œë„ì˜€ìŠµë‹ˆë‹¤!'}</p>
                                </div>
                                
                                ${evaluation.corrected_version && evaluation.corrected_version.trim() ? `
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <p class="font-medium text-blue-800">ê°œì„ ëœ ë‹µì•ˆ:</p>
                                        <p class="text-blue-700">${evaluation.corrected_version}</p>
                                    </div>
                                ` : ''}
                                
                                ${evaluation.suggestions && Array.isArray(evaluation.suggestions) && evaluation.suggestions.length > 0 ? `
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <p class="font-medium text-yellow-800">ê°œì„  ì œì•ˆ:</p>
                                        <ul class="text-yellow-700 list-disc list-inside space-y-1">
                                            ${evaluation.suggestions.filter(s => s && typeof s === 'string').map(suggestion => `<li>${suggestion}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <div class="mt-2 text-sm text-slate-600">
                                    <p>ğŸ“Š AI í‰ê°€ ì ìˆ˜: ${evaluation.score || 3}/5</p>
                                    <p>ë‹¤ìŒ ë³µìŠµ: ${nextDate}${result ? ` (${result.intervalDays}ì¼ í›„)` : ''}</p>
                                    ${result ? `<p>EF: ${result.ef.toFixed(1)}, ë‹¨ê³„: ${result.stage + 1}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Enhanced fallback feedback
                    const nextDate = result ? new Date(result.next).toLocaleDateString('ko-KR') : 'ê³„ì‚° ì¤‘';
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md feedback-correct">
                            <p class="font-bold">íŒ¨í„´ ë³µìŠµ ì™„ë£Œ! âœï¸</p>
                            <div class="mt-3 space-y-3">
                                <div class="bg-white p-3 rounded-lg">
                                    <p class="font-medium text-gray-800">ì‘ì„±í•˜ì‹  ë‹µë³€:</p>
                                    <p class="text-gray-700">"${userAnswer}"</p>
                                </div>
                                
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <p class="font-medium text-blue-800">ë³µìŠµí•œ íŒ¨í„´:</p>
                                    <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                                </div>
                                
                                <div class="mt-2 text-sm text-slate-600">
                                    <p>ë‹¤ìŒ ë³µìŠµ: ${nextDate}${result ? ` (${result.intervalDays}ì¼ í›„)` : ''}</p>
                                    ${result ? `<p>EF: ${result.ef.toFixed(1)}, ë‹¨ê³„: ${result.stage + 1}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                
                // Add next button
                const nextButton = `<button id="next-plan-btn" class="btn btn-primary">ë‹¤ìŒ â†’</button>`;
                document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                
                document.getElementById('next-plan-btn').addEventListener('click', () => {
                    planSession.currentIndex++;
                    renderQuiz('plan');
                });
                
            } catch (error) {
                console.error('Pattern evaluation failed:', error);
                
                // Fallback with basic processing
                let grade = 3; // Default: good
                let isCorrect = true;
                let result = null;
                
                // Update SM-2 schedule only if not already processed
                if (!alreadyProcessed) {
                    result = calculateNextReview(item, grade);
                    
                    // Remove from today queue if this was a first exposure
                    if (isTodayQueueItem(itemId)) {
                        removeFromTodayQueue(itemId);
                    }
                    
                    // Record result in plan session
                    planSession.results[planSession.phase].items.push({
                        ...item,
                        grade,
                        isCorrect,
                        userAnswer
                    });
                    
                    if (isCorrect) {
                        planSession.results[planSession.phase].correct++;
                    }
                }
                
                // Show fallback feedback
                const nextDate = result ? new Date(result.next).toLocaleDateString('ko-KR') : 'ê³„ì‚° ì¤‘';
                feedbackHtml = `
                    <div class="p-4 border-l-4 rounded-md feedback-correct">
                        <p class="font-bold">íŒ¨í„´ ë³µìŠµ ì™„ë£Œ! âœï¸</p>
                        <div class="mt-3 space-y-3">
                            <div class="bg-white p-3 rounded-lg">
                                <p class="font-medium text-gray-800">ì‘ì„±í•˜ì‹  ë‹µë³€:</p>
                                <p class="text-gray-700">"${userAnswer}"</p>
                            </div>
                            
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <p class="font-medium text-blue-800">ë³µìŠµí•œ íŒ¨í„´:</p>
                                <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                            </div>
                            
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <p class="font-medium text-yellow-800">ğŸ’¡ ì°¸ê³ :</p>
                                <p class="text-yellow-700 text-sm">AI í‰ê°€ê°€ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ ê¸°ë³¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            </div>
                            
                            <div class="mt-2 text-sm text-slate-600">
                                <p>ë‹¤ìŒ ë³µìŠµ: ${nextDate}${result ? ` (${result.intervalDays}ì¼ í›„)` : ''}</p>
                                ${result ? `<p>EF: ${result.ef.toFixed(1)}, ë‹¨ê³„: ${result.stage + 1}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                
                // Add next button
                const nextButton = `<button id="next-plan-btn" class="btn btn-primary">ë‹¤ìŒ â†’</button>`;
                document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                
                document.getElementById('next-plan-btn').addEventListener('click', () => {
                    planSession.currentIndex++;
                    renderQuiz('plan');
                });
            }
        }

        // --- Plan Mode: New interval progression system ---
        const BASE_INTERVALS_HOURS = [6, 12]; // 6h, 12h
        const BASE_INTERVALS_DAYS = [1, 3, 7, 14, 30, 60, 120]; // 1d, 3d, 7d, 14d, 30d, 60d, 120d
        const INITIAL_EF = 2.5;
        const MIN_EF = 1.3;
        const MAX_EF = 2.8; // Updated max as per requirement

        // --- Plan Mode: Settings ---
        const DEFAULT_SETTINGS = {
            dailyReviewCap: 10,      // 60-70% of daily goal
            dailyNewLimit: 5,        // 20-30% of daily goal
            drillAffectsRoutine: false,
            mode: 'plan'             // 'plan' or 'drill'
        };

        // --- Data structure migration and management ---
        function migrateToNewDataStructure() {
            const oldProgress = loadReviewProgress();
            const newProgress = loadPlanProgress();
            
            // Check if migration is needed
            if (Object.keys(oldProgress).length > 0 && Object.keys(newProgress).length === 0) {
                console.log('Migrating data to new structure...');
                const migrated = {};
                
                for (const [itemId, oldData] of Object.entries(oldProgress)) {
                    migrated[itemId] = {
                        reps: oldData.correctCount || 0,
                        lapses: oldData.totalAttempts ? (oldData.totalAttempts - oldData.correctCount) : 0,
                        ef: INITIAL_EF,
                        stage: Math.max(0, oldData.reviewLevel || 0),
                        last: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() - (SPACED_REPETITION_INTERVALS[oldData.reviewLevel || 0] * 24 * 60 * 60 * 1000) : null,
                        next: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() : null,
                        source: 'legacy'
                    };
                }
                
                savePlanProgress(migrated);
                console.log(`Migrated ${Object.keys(migrated).length} items to new structure`);
            }
        }

        // --- Today Queue Management ---
        function loadTodayQueue() {
            try {
                const today = new Date().toDateString();
                const saved = localStorage.getItem('eng.todayQueue.v1');
                const data = saved ? JSON.parse(saved) : {};
                
                // Check if it's a new day - reset if so
                if (data.date !== today) {
                    const newQueue = { date: today, items: [] };
                    saveTodayQueue(newQueue);
                    return newQueue;
                }
                
                return data;
            } catch (error) {
                console.error('Failed to load today queue:', error);
                const today = new Date().toDateString();
                return { date: today, items: [] };
            }
        }

        function saveTodayQueue(queueData) {
            try {
                localStorage.setItem('eng.todayQueue.v1', JSON.stringify(queueData));
                // Trigger storage event for cross-tab sync
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'eng.todayQueue.v1',
                    newValue: JSON.stringify(queueData),
                    storageArea: localStorage
                }));
            } catch (error) {
                console.error('Failed to save today queue:', error);
            }
        }

        function addToTodayQueue(itemId) {
            const queue = loadTodayQueue();
            const strId = String(itemId);
            if (!queue.items.includes(strId)) {
                queue.items.push(strId);
                saveTodayQueue(queue);
            }
        }

        function removeFromTodayQueue(itemId) {
            const queue = loadTodayQueue();
            const strId = String(itemId);
            const index = queue.items.indexOf(strId);
            if (index > -1) {
                queue.items.splice(index, 1);
                saveTodayQueue(queue);
            }
        }

        function isTodayQueueItem(itemId) {
            const queue = loadTodayQueue();
            return queue.items.includes(String(itemId));
        }

        // --- Data Consolidation System ---
        function loadProgressMerged() {
            try {
                const newProgress = loadPlanProgress();
                const oldProgress = loadReviewProgress();
                const merged = { ...newProgress };
                
                // Merge legacy data if not already present in new system
                for (const [itemId, oldData] of Object.entries(oldProgress)) {
                    const strId = String(itemId);
                    if (!merged[strId]) {
                        merged[strId] = {
                            reps: oldData.correctCount || 0,
                            lapses: oldData.totalAttempts ? (oldData.totalAttempts - oldData.correctCount) : 0,
                            ef: INITIAL_EF,
                            stage: Math.max(0, oldData.reviewLevel || 0),
                            last: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() - (oldData.reviewLevel * 24 * 60 * 60 * 1000) : null,
                            next: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() : null,
                            source: 'legacy'
                        };
                    }
                }
                
                return merged;
            } catch (error) {
                console.error('Failed to load merged progress:', error);
                return {};
            }
        }

        // --- Timeline Calculation Engine ---
        function getCountdown(nextISO) {
            const now = Date.now();
            const nextTime = nextISO ? new Date(nextISO).getTime() : null;
            
            if (!nextTime || isNaN(nextTime)) {
                return { status: 'later', label: 'â€”', deltaMs: Infinity };
            }
            
            const deltaMs = nextTime - now;
            
            if (deltaMs < 0) {
                // Overdue
                return { status: 'overdue', label: `+${formatDuration(-deltaMs)}`, deltaMs };
            } else if (deltaMs === 0) {
                // Due now
                return { status: 'due', label: '00:00', deltaMs: 0 };
            } else if (deltaMs <= 86400000) {
                // Within 24 hours
                return { status: 'upcoming', label: `ë‚¨ì€ ${formatDuration(deltaMs)}`, deltaMs };
            } else {
                // Later than 24 hours
                return { status: 'later', label: formatDateTime(nextTime), deltaMs };
            }
        }

        function formatDuration(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}ì‹œê°„ ${minutes.toString().padStart(2, '0')}ë¶„`;
            } else {
                return `${minutes}ë¶„`;
            }
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) {
                return `ì˜¤ëŠ˜ ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return `ë‚´ì¼ ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            } else {
                return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
        }

        // Utility function to remove duplicates by ID
        function dedupeById(items) {
            const seen = new Set();
            return items.filter(item => {
                const id = getItemId(item);
                if (seen.has(id)) {
                    return false;
                }
                seen.add(id);
                return true;
            });
        }

        function calculateReviewCounts() {
            try {
                const progress = loadProgressMerged();
                const todayQueue = loadTodayQueue();
                const now = Date.now();
                const todayEnd = new Date().setHours(23, 59, 59, 999);
                const tomorrowEnd = todayEnd + 86400000;
                
                const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
                
                // Get items with their timeline status
                const itemsWithStatus = allItems.map(item => {
                    const itemId = String(getItemId(item));
                    const itemProgress = progress[itemId];
                    const inTodayQueue = todayQueue.items.includes(itemId);
                    
                    let status = 'new';
                    let next = null;
                    let countdown = { status: 'later', label: 'â€”', deltaMs: Infinity };
                    
                    if (inTodayQueue) {
                        status = 'todayQueue';
                        countdown = { status: 'due', label: '00:00', deltaMs: 0 };
                    } else if (itemProgress && itemProgress.next && itemProgress.stage >= 0) {
                        next = itemProgress.next;
                        countdown = getCountdown(new Date(next).toISOString());
                        
                        if (next <= now) {
                            status = 'overdue';
                        } else if (next <= todayEnd) {
                            status = 'due';
                        } else if (next <= tomorrowEnd) {
                            status = 'upcoming';
                        } else {
                            status = 'later';
                        }
                    }
                    
                    return {
                        item,
                        itemId,
                        status,
                        next,
                        countdown,
                        progress: itemProgress
                    };
                });
                
                // Categorize for timeline
                const reviewNow = itemsWithStatus.filter(x => 
                    x.status === 'overdue' || x.status === 'due' || x.status === 'todayQueue'
                );
                const upcoming = itemsWithStatus.filter(x => x.status === 'upcoming');
                const later = itemsWithStatus.filter(x => 
                    x.status === 'later' && x.progress && x.progress.stage >= 0
                );
                const newItems = itemsWithStatus.filter(x => x.status === 'new');
                
                return {
                    reviewNow: dedupeById(reviewNow.map(x => x.item)),
                    upcoming: dedupeById(upcoming.map(x => x.item)),
                    later: dedupeById(later.map(x => x.item)),
                    newItems: dedupeById(newItems.map(x => x.item)),
                    timeline: itemsWithStatus.filter(x => x.progress || x.status === 'todayQueue'),
                    counts: {
                        reviewNow: reviewNow.length,
                        upcoming: upcoming.length,
                        later: later.length,
                        new: newItems.length
                    }
                };
            } catch (error) {
                console.error('Failed to calculate review counts:', error);
                return {
                    reviewNow: [],
                    upcoming: [],
                    later: [],
                    newItems: [],
                    timeline: [],
                    counts: { reviewNow: 0, upcoming: 0, later: 0, new: 0 }
                };
            }
        }

        // --- Timeline Widget Rendering ---
        function renderTimeline() {
            console.log('renderTimeline called');
            const timelineContainer = document.getElementById('timeline-container');
            const reviewNowCountEl = document.getElementById('review-now-count');
            const upcomingCountEl = document.getElementById('upcoming-count');
            const newItemsCountEl = document.getElementById('new-items-count');
            
            if (!timelineContainer) {
                console.log('Timeline container not found');
                return;
            }
            
            try {
                const reviewData = calculateReviewCounts();
                const counts = reviewData.counts;
                
                // Update count badges
                if (reviewNowCountEl) reviewNowCountEl.textContent = counts.reviewNow;
                if (upcomingCountEl) upcomingCountEl.textContent = counts.upcoming;
                if (newItemsCountEl) newItemsCountEl.textContent = counts.new;
                
                // Simple message for now
                timelineContainer.innerHTML = '<div class="text-center text-slate-500 py-4"><p>ğŸ“ íƒ€ì„ë¼ì¸ ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤</p><p class="text-sm">ë³µìŠµ: ' + counts.reviewNow + ' | ì˜ˆì •: ' + counts.upcoming + ' | ì‹ ê·œ: ' + counts.new + '</p></div>';
                
                console.log('Timeline rendered successfully:', counts);
                
            } catch (error) {
                console.error('Failed to render timeline:', error);
                timelineContainer.innerHTML = '<div class="text-center text-red-500 py-4"><p>âš ï¸ íƒ€ì„ë¼ì¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
            }
        }

        function getItemDisplayName(item) {
            if (item.ko && item.en) {
                // Truncate long sentences
                const ko = item.ko.length > 30 ? item.ko.substring(0, 30) + '...' : item.ko;
                return ko;
            } else if (item.pattern_ko) {
                return item.pattern_ko;
            } else if (item.pattern) {
                return item.pattern;
            } else {
                return 'Unknown Item';
            }
        }

        function getItemSource(item) {
            if (masterData.cheonilmun && masterData.cheonilmun.includes(item)) return 'ì²œì¼ë¬¸';
            if (masterData.patterns && masterData.patterns.includes(item)) return 'íŒ¨í„´';
            if (masterData.academic && masterData.academic.includes(item)) return 'ë…¼ë¬¸';
            return item.type || 'ê¸°íƒ€';
        }

        function pullForwardReview(itemId) {
            try {
                const progress = loadPlanProgress();
                const strId = String(itemId);
                
                if (progress[strId]) {
                    // Update next review time to now
                    progress[strId].next = Date.now();
                    savePlanProgress(progress);
                }
                
                // Add to today queue for immediate availability
                addToTodayQueue(strId);
                
                // Refresh timeline
                renderTimeline();
                updateDailyPlanSummary();
                
                console.log('Pulled forward item for review:', strId);
            } catch (error) {
                console.error('Error pulling forward review:', error);
            }
        }

        // --- Real-time Update System ---
        let countdownInterval = null;
        let updateFrequency = 60000; // 1 minute default

        function startRealTimeUpdates() {
            stopRealTimeUpdates(); // Clear any existing interval
            
            function updateCountdowns() {
                const countdownElements = document.querySelectorAll('.timeline-countdown[data-next]');
                let hasChanges = false;
                
                countdownElements.forEach(element => {
                    const nextTime = element.dataset.next;
                    if (nextTime) {
                        const countdown = getCountdown(new Date(parseInt(nextTime)).toISOString());
                        const newLabel = countdown.label;
                        
                        if (element.textContent !== newLabel) {
                            element.textContent = newLabel;
                            hasChanges = true;
                            
                            // Update color based on status change
                            element.className = element.className.replace(/text-\w+-\d+/g, '');
                            const countdownColors = {
                                'overdue': 'text-red-600 font-semibold',
                                'due': 'text-orange-600 font-semibold', 
                                'upcoming': 'text-blue-600',
                                'later': 'text-gray-500'
                            };
                            element.className += ` ${countdownColors[countdown.status] || countdownColors['later']}`;
                        }
                    }
                });
                
                // If status boundaries were crossed, re-render timeline
                if (hasChanges) {
                    const now = Date.now();
                    const shouldRerender = Array.from(countdownElements).some(element => {
                        const nextTime = parseInt(element.dataset.next);
                        const timeDiff = nextTime - now;
                        // Check if we crossed major boundaries (due/upcoming/later)
                        return Math.abs(timeDiff) < updateFrequency;
                    });
                    
                    if (shouldRerender) {
                        renderTimeline();
                    }
                }
            }
            
            // Initial update
            updateCountdowns();
            
            // Set up recurring updates
            countdownInterval = setInterval(updateCountdowns, updateFrequency);
        }

        function stopRealTimeUpdates() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // Page Visibility API for performance optimization
        function handleVisibilityChange() {
            if (document.hidden) {
                // Tab became inactive - reduce update frequency
                updateFrequency = 300000; // 5 minutes
                if (countdownInterval) {
                    stopRealTimeUpdates();
                    startRealTimeUpdates();
                }
            } else {
                // Tab became active - restore normal frequency and update immediately
                updateFrequency = 60000; // 1 minute
                renderTimeline(); // Full refresh when tab becomes active
                startRealTimeUpdates();
            }
        }

        // Cross-tab synchronization
        function setupCrossTabSync() {
            window.addEventListener('storage', (e) => {
                if (e.key === 'eng.progress.v1' || e.key === 'eng.todayQueue.v1') {
                    console.log('Storage changed in another tab, refreshing timeline');
                    renderTimeline();
                    updateDailyPlanSummary();
                }
            });
        }

        // Page Visibility API for performance optimization  
        function handleVisibilityChange() {
            if (document.hidden) {
                console.log('Tab became inactive');
            } else {
                console.log('Tab became active');
            }
        }

        // --- Plan Mode: Data management ---
        function loadPlanProgress() {
            const saved = localStorage.getItem('eng.progress.v1');
            return saved ? JSON.parse(saved) : {};
        }

        function savePlanProgress(progress) {
            localStorage.setItem('eng.progress.v1', JSON.stringify(progress));
        }

        function loadPlanSettings() {
            const saved = localStorage.getItem('eng.settings.v1');
            return saved ? { ...DEFAULT_SETTINGS, ...JSON.parse(saved) } : DEFAULT_SETTINGS;
        }

        function savePlanSettings(settings) {
            localStorage.setItem('eng.settings.v1', JSON.stringify(settings));
        }

        function loadPlanHistory() {
            const saved = localStorage.getItem('eng.history.v1');
            return saved ? JSON.parse(saved) : {};
        }

        function savePlanHistory(history) {
            localStorage.setItem('eng.history.v1', JSON.stringify(history));
        }

        // --- Plan Mode: Enhanced Scheduler with 6h start ---
        function calculateNextReview(item, grade) {
            // grade: 0-1=wrong, 2=hard, 3=good, 4-5=easy
            const progress = loadPlanProgress();
            const itemId = getItemId(item);
            const strId = String(itemId);
            const current = progress[strId] || {
                reps: 0,
                lapses: 0,
                ef: INITIAL_EF,
                stage: -1,  // -1 = new, 0+ = learning stages
                last: null,
                next: null,
                source: item.type || 'unknown'
            };

            const now = Date.now();
            let newEf = current.ef;
            let newStage = current.stage;
            let intervalMs;

            if (grade <= 1) {
                // Grade 0-1: Wrong answer - back to 6h, reduce EF, add to session requeue
                current.lapses++;
                newEf = Math.max(MIN_EF, current.ef - 0.15);
                newStage = Math.max(0, current.stage); // Don't go below stage 0
                intervalMs = 6 * 60 * 60 * 1000; // 6 hours
                // Note: Session re-queue should be handled by the session manager
            } else if (grade === 2) {
                // Grade 2: Hard - reduce interval to 70% of current, reduce EF slightly
                newEf = Math.max(MIN_EF, current.ef - 0.05);
                if (current.stage === -1) {
                    intervalMs = 6 * 60 * 60 * 1000; // First time: 6h
                } else if (current.stage < BASE_INTERVALS_HOURS.length) {
                    // Still in hour-based intervals
                    const baseHours = BASE_INTERVALS_HOURS[current.stage];
                    intervalMs = Math.max(6 * 60 * 60 * 1000, Math.round(baseHours * 0.7 * 60 * 60 * 1000));
                } else {
                    // Day-based intervals
                    const dayStage = current.stage - BASE_INTERVALS_HOURS.length;
                    const baseDays = BASE_INTERVALS_DAYS[Math.min(dayStage, BASE_INTERVALS_DAYS.length - 1)];
                    intervalMs = Math.max(6 * 60 * 60 * 1000, Math.round(baseDays * 0.7 * 24 * 60 * 60 * 1000));
                }
            } else if (grade === 3) {
                // Grade 3: Good - normal progression, maintain scheduled intervals
                current.reps++;
                if (current.stage === -1) {
                    // First completion: start with 6h interval
                    newStage = 0;
                    intervalMs = BASE_INTERVALS_HOURS[0] * 60 * 60 * 1000; // 6h
                } else {
                    // Advance to next stage
                    newStage = current.stage + 1;
                    if (newStage < BASE_INTERVALS_HOURS.length) {
                        // Still in hour-based intervals (6h, 12h)
                        intervalMs = BASE_INTERVALS_HOURS[newStage] * 60 * 60 * 1000;
                    } else {
                        // Move to day-based intervals (1d, 3d, 7d, ...)
                        const dayStage = newStage - BASE_INTERVALS_HOURS.length;
                        const dayInterval = BASE_INTERVALS_DAYS[Math.min(dayStage, BASE_INTERVALS_DAYS.length - 1)];
                        intervalMs = dayInterval * 24 * 60 * 60 * 1000;
                    }
                }
            } else {
                // Grade 4-5: Easy - advance stage and apply EF multiplier
                current.reps++;
                newEf = Math.min(MAX_EF, current.ef + 0.1);
                
                if (current.stage === -1) {
                    // First completion with easy: start with 6h but boost slightly
                    newStage = 0;
                    intervalMs = BASE_INTERVALS_HOURS[0] * 60 * 60 * 1000; // Still 6h for first
                } else {
                    newStage = current.stage + 1;
                    let baseIntervalMs;
                    
                    if (newStage < BASE_INTERVALS_HOURS.length) {
                        // Hour-based intervals
                        baseIntervalMs = BASE_INTERVALS_HOURS[newStage] * 60 * 60 * 1000;
                    } else {
                        // Day-based intervals
                        const dayStage = newStage - BASE_INTERVALS_HOURS.length;
                        const dayInterval = BASE_INTERVALS_DAYS[Math.min(dayStage, BASE_INTERVALS_DAYS.length - 1)];
                        baseIntervalMs = dayInterval * 24 * 60 * 60 * 1000;
                    }
                    
                    // Apply EF multiplier only to day-based intervals
                    if (newStage >= BASE_INTERVALS_HOURS.length) {
                        intervalMs = Math.round(baseIntervalMs * newEf);
                    } else {
                        intervalMs = baseIntervalMs;
                    }
                }
            }

            const nextReviewDate = now + intervalMs;

            const updated = {
                ...current,
                ef: newEf,
                stage: newStage,
                last: now,
                next: nextReviewDate
            };

            progress[strId] = updated;
            savePlanProgress(progress);

            // Add to today queue if newly completed (stage was -1)
            if (current.stage === -1) {
                addToTodayQueue(strId);
            }

            return {
                ...updated,
                intervalMs,
                intervalDays: Math.round(intervalMs / (24 * 60 * 60 * 1000)),
                grade
            };
        }

        // --- Plan Mode: Queue Generation ---
        function generateDailyPlan() {
            const settings = loadPlanSettings();
            const progress = loadPlanProgress();
            const now = Date.now();
            const todayEnd = new Date().setHours(23, 59, 59, 999);

            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            // Get due items (review queue)
            const dueItems = allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                return itemProgress && itemProgress.next && itemProgress.next <= todayEnd && itemProgress.stage >= 0;
            }).slice(0, settings.dailyReviewCap);

            // Get new items (never studied before)
            const newItems = allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                return !itemProgress || itemProgress.stage === -1;
            });

            // Select new items by source
            const newCheonilmun = newItems.filter(item => item.type === 'grammar' || masterData.cheonilmun.includes(item))
                .slice(0, Math.ceil(settings.dailyNewLimit * 0.7));
            const newPatterns = newItems.filter(item => item.type === 'pattern' || masterData.patterns.includes(item))
                .slice(0, Math.floor(settings.dailyNewLimit * 0.3));

            const selectedNew = [...newCheonilmun, ...newPatterns].slice(0, settings.dailyNewLimit);

            return {
                review: dueItems,
                new: selectedNew,
                summary: {
                    reviewCount: dueItems.length,
                    newCount: selectedNew.length,
                    cheonilmunNew: newCheonilmun.length,
                    patternNew: newPatterns.length,
                    estimatedMinutes: Math.ceil((dueItems.length + selectedNew.length) * 1.2) // ~1.2 min per item
                }
            };
        }

        // --- Plan Mode: UI Updates ---
        function updateDailyPlanSummary() {
            const plan = generateDailyPlan();
            const summaryElement = document.getElementById('daily-plan-summary');
            
            if (summaryElement) {
                const { summary } = plan;
                summaryElement.innerHTML = `
                    <div class="bg-white rounded-lg p-4 border border-indigo-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-lg font-semibold text-indigo-700">ì˜¤ëŠ˜ì˜ í•™ìŠµ ê³„íš</span>
                            <span class="text-sm text-slate-500">ì˜ˆìƒ ${summary.estimatedMinutes}ë¶„</span>
                        </div>
                        <div class="flex gap-4 text-sm">
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-red-400 rounded-full mr-2"></span>
                                <span>ë³µìŠµ ${summary.reviewCount}ê°œ</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>
                                <span>ì‹ ê·œ ${summary.newCount}ê°œ</span>
                                ${summary.cheonilmunNew > 0 ? `<span class="text-slate-500 ml-1">(ì²œì¼ë¬¸ ${summary.cheonilmunNew})</span>` : ''}
                                ${summary.patternNew > 0 ? `<span class="text-slate-500 ml-1">(íšŒí™” ${summary.patternNew})</span>` : ''}
                            </div>
                            ${summary.newCount > 0 ? '<div class="flex items-center"><span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span><span>ë³€í˜• 1ê°œ</span></div>' : ''}
                        </div>
                        ${summary.reviewCount === 0 && summary.newCount === 0 ? 
                            '<div class="mt-2 text-slate-500 text-sm">ğŸ‰ ì˜¤ëŠ˜ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤! ë“œë¦´ ëª¨ë“œë¡œ ììœ  í•™ìŠµì„ í•´ë³´ì„¸ìš”.</div>' : ''}
                    </div>
                `;
            }
        }

        // í•™ìŠµ ì§„í–‰ ìƒí™©ì„ localStorageì—ì„œ ë¡œë“œ
        function loadReviewProgress() {
            const saved = localStorage.getItem('reviewProgress');
            return saved ? JSON.parse(saved) : {};
        }

        // í•™ìŠµ ì§„í–‰ ìƒí™©ì„ localStorageì— ì €ì¥
        function saveReviewProgress(progress) {
            localStorage.setItem('reviewProgress', JSON.stringify(progress));
        }

        // í•­ëª©ì˜ ê³ ìœ  ID ìƒì„±
        function getItemId(item) {
            if (item.id) return String(item.id);
            if (item.type === 'pattern' && item.pattern) return `pattern_${item.pattern}`;
            if (item.type === 'academic') return item.id;
            return `item_${item.en ? item.en.substring(0, 50) : Math.random()}`;
        }

        // ë‹¤ìŒ ë³µìŠµ ë‚ ì§œ ê³„ì‚°
        function calculateNextReviewDate(currentLevel, isCorrect) {
            const now = new Date();
            let nextLevel = currentLevel;
            
            // Use current level's interval for scheduling, then update level
            const daysToAdd = SPACED_REPETITION_INTERVALS[currentLevel];
            const nextDate = new Date(now.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            
            if (isCorrect) {
                nextLevel = Math.min(currentLevel + 1, SPACED_REPETITION_INTERVALS.length - 1);
            } else {
                // í‹€ë ¸ìœ¼ë©´ ë ˆë²¨ì„ ë’¤ë¡œ ì´ë™ (ìµœì†Œ 0)
                nextLevel = Math.max(0, currentLevel - 1);
            }
            
            return {
                nextReviewDate: nextDate,
                reviewLevel: nextLevel
            };
        }

        // ì˜¤ëŠ˜ ë³µìŠµí•  í•­ëª© í•„í„°ë§ (Plan ëª¨ë“œìš© - ê¸°ì¡´ ë¡œì§)
        function getItemsDueForReview() {
            const progress = loadReviewProgress();
            const today = new Date();
            today.setHours(23, 59, 59, 999); // ì˜¤ëŠ˜ ëê¹Œì§€
            
            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            return allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                
                // ì•„ì§ í•™ìŠµí•˜ì§€ ì•Šì€ í•­ëª©ì€ ë³µìŠµ ëŒ€ìƒì´ ì•„ë‹˜
                if (!itemProgress) {
                    return false;
                }
                
                // ë§ˆìŠ¤í„° ë ˆë²¨ì— ë„ë‹¬í•œ í•­ëª©ì€ ë³µìŠµí•˜ì§€ ì•ŠìŒ
                if (itemProgress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1) {
                    return false;
                }
                
                // ë‹¤ìŒ ë³µìŠµì¼ì´ ì˜¤ëŠ˜ ë˜ëŠ” ì´ì „ì¸ í•­ëª©ë§Œ í¬í•¨
                const nextReviewDate = new Date(itemProgress.nextReviewDate);
                return nextReviewDate <= today;
            });
        }

        // ëª¨ë“  í•™ìŠµí•œ í•­ëª© ë°˜í™˜ (ê°„ê²© ë³µìŠµ ì—°ìŠµìš© - ì‹œê°„ ê°„ê²© ë¬´ì‹œ)
        function getAllStudiedItems() {
            const progress = loadReviewProgress();
            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            return allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                
                // í•™ìŠµí•œ ì ì´ ìˆëŠ” í•­ëª©ë§Œ í¬í•¨ (ì‹œê°„ ê°„ê²©ê³¼ ë§ˆìŠ¤í„° ë ˆë²¨ ë¬´ì‹œ)
                return itemProgress !== undefined;
            });
        }

        // í•™ìŠµ ê¸°ë¡ ì—…ë°ì´íŠ¸
        function recordLearningProgress(item, isCorrect) {
            const progress = loadReviewProgress();
            const itemId = getItemId(item);
            const now = new Date();
            
            if (!progress[itemId]) {
                // ì²« í•™ìŠµ
                progress[itemId] = {
                    studiedAt: now.toISOString(),
                    reviewLevel: 0,
                    correctCount: isCorrect ? 1 : 0,
                    totalAttempts: 1,
                    lastReviewResult: isCorrect
                };
            } else {
                // ë³µìŠµ
                progress[itemId].totalAttempts++;
                if (isCorrect) progress[itemId].correctCount++;
                progress[itemId].lastReviewResult = isCorrect;
            }
            
            // ë‹¤ìŒ ë³µìŠµ ì¼ì • ê³„ì‚°
            const nextReview = calculateNextReviewDate(progress[itemId].reviewLevel, isCorrect);
            progress[itemId].nextReviewDate = nextReview.nextReviewDate.toISOString();
            progress[itemId].reviewLevel = nextReview.reviewLevel;
            
            saveReviewProgress(progress);
            return progress[itemId];
        }

        // --- DOM ìš”ì†Œ ---
        const dashboardScreen = document.getElementById('dashboard-screen');
        const moduleScreen = document.getElementById('module-screen');
        const moduleTitle = document.getElementById('module-title');
        const moduleContent = document.getElementById('module-content');
        
        const reviewCard = document.getElementById('review-card');
        const cheonilmunCard = document.getElementById('cheonilmun-card');
        const patternCard = document.getElementById('pattern-card');
        const academicCard = document.getElementById('academic-card');
        const libraryCard = document.getElementById('library-card');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // --- Plan Mode DOM elements ---
        const startDailyPlanBtn = document.getElementById('start-daily-plan-btn');
        const planSettingsBtn = document.getElementById('plan-settings-btn');
        const planSettingsModal = document.getElementById('plan-settings-modal');
        const savePlanSettingsBtn = document.getElementById('save-plan-settings');
        const cancelPlanSettingsBtn = document.getElementById('cancel-plan-settings');

        // --- Plan Mode: Session State ---
        let planSession = {
            active: false,
            phase: 'review', // 'review', 'new', 'output', 'summary'
            queue: [],
            currentIndex: 0,
            results: {
                review: { correct: 0, total: 0, items: [] },
                new: { correct: 0, total: 0, items: [] },
                output: { correct: 0, total: 0, items: [] }
            }
        };

        // --- Plan Mode: Session Management ---
        function startPlanSession() {
            const plan = generateDailyPlan();
            
            if (plan.review.length === 0 && plan.new.length === 0) {
                alert('ì˜¤ëŠ˜ í•™ìŠµí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤! ğŸ‰');
                return;
            }

            planSession = {
                active: true,
                phase: 'review',
                queue: [...plan.review],
                currentIndex: 0,
                results: {
                    review: { correct: 0, total: plan.review.length, items: [] },
                    new: { correct: 0, total: plan.new.length, items: [] },
                    output: { correct: 0, total: plan.new.length > 0 ? 1 : 0, items: [] }
                },
                newQueue: [...plan.new]
            };

            showModule('plan');
        }

        function nextPlanPhase() {
            if (planSession.phase === 'review' && planSession.newQueue.length > 0) {
                planSession.phase = 'new';
                planSession.queue = [...planSession.newQueue];
                planSession.currentIndex = 0;
                moduleTitle.textContent = 'ğŸ“š ì‹ ê·œ í•™ìŠµ';
                renderQuiz('plan');
            } else if (planSession.phase === 'new' && planSession.results.new.total > 0) {
                planSession.phase = 'output';
                generateOutputExercise();
            } else {
                planSession.phase = 'summary';
                renderPlanSummary();
            }
        }

        function generateOutputExercise() {
            moduleTitle.textContent = 'âœï¸ ë³€í˜• ì—°ìŠµ';
            
            if (planSession.results.new.items.length === 0) {
                nextPlanPhase();
                return;
            }

            const randomNewItem = planSession.results.new.items[
                Math.floor(Math.random() * planSession.results.new.items.length)
            ];

            // Create a paraphrase exercise
            const outputItem = {
                ...randomNewItem,
                isOutput: true,
                originalKo: randomNewItem.ko,
                ko: randomNewItem.ko.replace(/ì„|ë¥¼|ì´|ê°€|ì€|ëŠ”/g, '_') + ' (ì£¼ìš” ì¡°ì‚¬ë¥¼ ë°”ê¿”ì„œ ë‹¤ì‹œ ì¨ë³´ì„¸ìš”)'
            };

            planSession.queue = [outputItem];
            planSession.currentIndex = 0;
            renderQuiz('plan');
        }

        function renderPlanSummary() {
            moduleTitle.textContent = 'ğŸ“Š ì˜¤ëŠ˜ í•™ìŠµ ì™„ë£Œ';
            const { results } = planSession;
            
            const reviewAccuracy = results.review.total > 0 ? 
                Math.round((results.review.correct / results.review.total) * 100) : 0;
            const newAccuracy = results.new.total > 0 ? 
                Math.round((results.new.correct / results.new.total) * 100) : 0;
            
            const totalCorrect = results.review.correct + results.new.correct + results.output.correct;
            const totalItems = results.review.total + results.new.total + results.output.total;
            const overallAccuracy = totalItems > 0 ? Math.round((totalCorrect / totalItems) * 100) : 0;

            moduleContent.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h3 class="text-2xl font-bold text-indigo-700 mb-6">ì˜¤ëŠ˜ í•™ìŠµì„ ì™„ì£¼í–ˆìŠµë‹ˆë‹¤!</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-bold text-red-700">ë³µìŠµ</h4>
                            <p class="text-2xl font-bold">${results.review.correct}/${results.review.total}</p>
                            <p class="text-sm text-red-600">${reviewAccuracy}% ì •í™•ë„</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-green-700">ì‹ ê·œ</h4>
                            <p class="text-2xl font-bold">${results.new.correct}/${results.new.total}</p>
                            <p class="text-sm text-green-600">${newAccuracy}% ì •í™•ë„</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-bold text-yellow-700">ë³€í˜•</h4>
                            <p class="text-2xl font-bold">${results.output.correct}/${results.output.total}</p>
                            <p class="text-sm text-yellow-600">${results.output.total > 0 ? Math.round((results.output.correct / results.output.total) * 100) : 0}% ì™„ì„±ë„</p>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                        <p class="text-lg"><strong>ì „ì²´ ì •í™•ë„:</strong> ${overallAccuracy}%</p>
                        <p class="text-sm text-slate-600">ë‚´ì¼ ë³µìŠµ ì˜ˆì •: ${generateDailyPlan().review.length}ê°œ</p>
                    </div>
                    
                    <button id="finish-plan-btn" class="btn btn-primary">ì™„ë£Œí•˜ê¸°</button>
                </div>
            `;

            // Record today's session in history
            const today = new Date().toISOString().split('T')[0];
            const history = loadPlanHistory();
            history[today] = {
                date: today,
                completed: true,
                results: { ...results },
                accuracy: overallAccuracy,
                timestamp: Date.now()
            };
            savePlanHistory(history);

            // Add event listener for finish button
            document.getElementById('finish-plan-btn').addEventListener('click', () => {
                planSession.active = false;
                showDashboard();
            });
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        reviewCard.addEventListener('click', () => showModule('review'));
        cheonilmunCard.addEventListener('click', () => showModule('cheonilmun'));
        patternCard.addEventListener('click', () => showModule('pattern'));
        academicCard.addEventListener('click', () => showModule('academic'));
        libraryCard.addEventListener('click', () => showModule('library'));
        backToDashboardBtn.addEventListener('click', showDashboard);

        // --- Plan Mode Event Listeners ---
        startDailyPlanBtn.addEventListener('click', startPlanSession);
        planSettingsBtn.addEventListener('click', () => {
            const settings = loadPlanSettings();
            document.getElementById('daily-review-cap').value = settings.dailyReviewCap;
            document.getElementById('daily-new-limit').value = settings.dailyNewLimit;
            document.getElementById('drill-affects-routine').checked = settings.drillAffectsRoutine;
            planSettingsModal.classList.remove('hidden');
        });

        savePlanSettingsBtn.addEventListener('click', () => {
            const settings = {
                dailyReviewCap: parseInt(document.getElementById('daily-review-cap').value),
                dailyNewLimit: parseInt(document.getElementById('daily-new-limit').value),
                drillAffectsRoutine: document.getElementById('drill-affects-routine').checked,
                mode: 'plan'
            };
            savePlanSettings(settings);
            planSettingsModal.classList.add('hidden');
            updateDailyPlanSummary();
            updateReviewCount();
        });

        cancelPlanSettingsBtn.addEventListener('click', () => {
            planSettingsModal.classList.add('hidden');
        });
        
        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            // ì´ˆê¸° ì¹´ìš´íŠ¸ í‘œì‹œ (ë°ì´í„° ë¡œë”© ì „)
            updateReviewCount();
            
            loadOriginalData().then(() => {
                dataLoaded = true;
                
                // Migrate existing data to new structure
                migrateToNewDataStructure();
                
                // Initialize plan UI
                updateDailyPlanSummary();
                updateReviewCount();
                
                // Initialize timeline system
                try {
                    console.log('Initializing timeline system...');
                    renderTimeline();
                    console.log('Timeline initialized successfully');
                } catch (error) {
                    console.error('Timeline initialization failed:', error);
                }
                
                // Page Visibility API setup
                try {
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                    console.log('Visibility change handler added');
                } catch (error) {
                    console.error('Visibility handler failed:', error);
                }
            });
        });

        // --- ì›ë³¸ ë°ì´í„° ë¡œë”© í•¨ìˆ˜ë“¤ ---
        async function loadOriginalData() {
            try {
                // ì²œì¼ë¬¸ ë°ì´í„° ë¡œë“œ
                const cheonilmunResponse = await fetch('./data/cheonilmun_sample.json');
                if (cheonilmunResponse.ok) {
                    const cheonilmunData = await cheonilmunResponse.json();
                    originalData.cheonilmun = [...cheonilmunData];
                    masterData.cheonilmun = [...cheonilmunData];
                }

                // ìƒí™œì˜ì–´ íŒ¨í„´ ë°ì´í„° ë¡œë“œ
                const patternsResponse = await fetch('./data/patterns_numbered.json');
                if (patternsResponse.ok) {
                    const patternsData = await patternsResponse.json();
                    originalData.patterns = [...patternsData];
                    masterData.patterns = [...patternsData];
                }
            } catch (error) {
                console.error('ì›ë³¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì•±ì´ ê³„ì† ì‘ë™í•˜ë„ë¡ í•¨
            }
        }

        function updateReviewCount() {
            // ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ 0ìœ¼ë¡œ í‘œì‹œ
            if (!dataLoaded) {
                document.getElementById('review-count').textContent = '0';
                return;
            }
            
            // ê°„ê²© ë³µìŠµ ì—°ìŠµìš©: ëª¨ë“  í•™ìŠµí•œ í•­ëª© í‘œì‹œ
            const studiedItems = getAllStudiedItems();
            const count = studiedItems.length;
            document.getElementById('review-count').textContent = count;
        }

        // --- í™”ë©´ ì „í™˜ ë¡œì§ ---
        function showDashboard() {
            moduleScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            updateReviewCount();
            renderTimeline();
            updateDailyPlanSummary();
        }

        function showModule(moduleType) {
            dashboardScreen.classList.add('hidden');
            moduleScreen.classList.remove('hidden');

            switch(moduleType) {
                case 'plan':
                    moduleTitle.textContent = planSession.phase === 'review' ? 'ğŸ§  ë³µìŠµ ë‹¨ê³„' : 
                                             planSession.phase === 'new' ? 'ğŸ“š ì‹ ê·œ í•™ìŠµ' :
                                             planSession.phase === 'output' ? 'âœï¸ ë³€í˜• ì—°ìŠµ' : 'ğŸ“Š ì™„ë£Œ';
                    if (planSession.phase !== 'summary') {
                        renderQuiz('plan');
                    }
                    break;
                case 'review':
                    moduleTitle.textContent = 'ğŸ§  ë³µìŠµ ì—°ìŠµ (Drill)';
                    const studiedItems = getAllStudiedItems();
                    sessionState.queue = [...studiedItems].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    if (sessionState.queue.length === 0) {
                        moduleContent.innerHTML = `
                            <div class="text-center p-8">
                                <p class="text-slate-500 mb-4">ë³µìŠµí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤!</p>
                                <p class="text-sm text-slate-400 mb-4">ğŸ’¡ íŒ: ì²œì¼ë¬¸ì´ë‚˜ íŒ¨í„´ í•™ìŠµì„ ì™„ë£Œí•˜ë©´ ë³µìŠµì— ì¶”ê°€ë©ë‹ˆë‹¤.</p>
                                <button id="reset-review-btn" class="btn btn-secondary">ë³µìŠµ ë°ì´í„° ì´ˆê¸°í™”</button>
                            </div>`;
                        const resetBtn = document.getElementById('reset-review-btn');
                        if (resetBtn) {
                            resetBtn.addEventListener('click', () => {
                                if (confirm('ë³µìŠµ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                                    resetReviewData();
                                    showDashboard();
                                }
                            });
                        }
                    } else {
                        renderQuiz('review');
                    }
                    break;
                case 'cheonilmun':
                    moduleTitle.textContent = 'ğŸ—ï¸ ì²œì¼ë¬¸ êµ¬ì¡° ë¶„ì„ (Drill)';
                    sessionState.queue = [...masterData.cheonilmun].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('cheonilmun');
                    break;
                case 'pattern':
                    moduleTitle.textContent = 'ğŸ—£ï¸ ìƒí™œì˜ì–´ íŒ¨í„´ ì²´í™” (Drill)';
                    sessionState.queue = [...masterData.patterns].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('pattern');
                    break;
                case 'academic':
                    moduleTitle.textContent = 'ğŸ”¬ ë‚˜ì˜ ë¬¸ì¥ ë¶„ì„';
                    renderAcademicModule();
                    break;
                case 'library':
                    moduleTitle.textContent = 'ğŸ—‚ï¸ ì „ì²´ ìë£Œì‹¤';
                    renderLibraryModule();
                    break;
            }
        }

        // --- ìƒì„¸ í•´ì„¤ í…œí”Œë¦¿ ---
        function createAnalysisHTML(item) {
            if (!item) return '';
            const analysis = item.analysis || (item.examples && item.examples[0].analysis);
            if (!analysis) return '';

            const vocabHtml = Object.entries(analysis.vocab || {}).map(([word, meaning]) => 
                `<li class="mb-1"><strong class="font-semibold text-slate-800">${word}:</strong> ${meaning}</li>`
            ).join('');

            return `
                <div class="mt-4 p-4 border rounded-lg bg-slate-50 space-y-4">
                    <div>
                        <h4 class="font-bold text-indigo-700">ğŸ“˜ í•µì‹¬ í¬ì¸íŠ¸</h4>
                        <p class="mt-1 text-slate-700">${analysis.point}</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-indigo-700">ğŸ’¡ ìƒì„¸ í•´ì„¤</h4>
                        <p class="mt-1 text-slate-700 leading-relaxed">${analysis.explanation}</p>
                    </div>
                    ${vocabHtml ? `<div>
                        <h4 class="font-bold text-indigo-700">ğŸ“– ì£¼ìš” ì–´íœ˜</h4>
                        <ul class="list-disc list-inside text-slate-700 mt-1">${vocabHtml}</ul>
                    </div>` : ''}
                </div>
            `;
        }

        // --- í€´ì¦ˆ í˜•ì‹ ê²°ì • ë¡œì§ ---
        function getItemQuizFormat(item) {
            // Determine consistent quiz format based on item characteristics
            if (item.type === 'pattern') {
                return 'composition'; // Pattern items always use composition format
            } else if (item.chapter || item.unit) {
                return 'translation'; // Cheonilmun items always use translation format
            } else {
                return 'fill-in-blank'; // Default format
            }
        }

        function createQuizByFormat(item, format) {
            switch(format) {
                case 'fill-in-blank':
                    return createFillInBlankQuiz(item);
                case 'translation':
                    return createTranslationQuiz(item);
                case 'composition':
                    return createCompositionQuiz(item);
                default:
                    return createTranslationQuiz(item);
            }
        }

        // --- í€´ì¦ˆ ë Œë”ë§ ë¡œì§ ---
        function renderQuiz(quizType) {
            // Handle Plan mode differently
            if (quizType === 'plan') {
                const queue = planSession.queue;
                const currentIndex = planSession.currentIndex;
                
                if (queue.length === 0 || currentIndex >= queue.length) {
                    nextPlanPhase();
                    return;
                }

                const item = queue[currentIndex];
                const totalItems = queue.length;
                const progressText = `${planSession.phase} ${currentIndex + 1}/${totalItems}`;

                if (item.pattern) {
                    // Pattern item rendering for Plan mode with Gemini AI integration
                    moduleContent.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500 font-medium">${progressText}</span>
                                <span class="text-indigo-500 text-sm font-medium">Plan ëª¨ë“œ</span>
                            </div>
                            <div class="bg-slate-50 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-indigo-700 mb-3">íŒ¨í„´: ${item.pattern}</h3>
                                <p class="text-slate-600 mb-4">${item.pattern_ko}</p>
                                <div id="pattern-loading" class="text-center py-4">
                                    <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-indigo-500">
                                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        AIê°€ ê°œì¸í™”ëœ í•™ìŠµ ê³¼ì œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                                    </div>
                                </div>
                                <div id="pattern-task-content" class="hidden">
                                    <!-- Dynamic task content will be inserted here -->
                                </div>
                            </div>
                            <div id="feedback-area"></div>
                        </div>
                    `;

                    // Generate dynamic task using Gemini AI
                    generatePatternTaskWithGemini(item.pattern, item.pattern_ko).then(taskData => {
                        const loadingDiv = document.getElementById('pattern-loading');
                        const contentDiv = document.getElementById('pattern-task-content');
                        
                        // Validate taskData has required fields
                        const isValidTaskData = taskData && 
                                              typeof taskData === 'object' && 
                                              taskData.instruction && 
                                              typeof taskData.instruction === 'string' &&
                                              taskData.instruction.trim() !== '';
                        
                        if (isValidTaskData && loadingDiv && contentDiv) {
                            loadingDiv.classList.add('hidden');
                            contentDiv.classList.remove('hidden');
                            
                            contentDiv.innerHTML = `
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">ğŸ“‹ í•™ìŠµ ê³¼ì œ</h4>
                                        <p class="text-blue-700">${taskData.instruction}</p>
                                        ${taskData.example_input && taskData.example_input.trim() ? `<div class="mt-2 p-2 bg-white rounded border-l-4 border-blue-300">
                                            <p class="text-sm text-gray-600">ì˜ˆì‹œ ìƒí™©:</p>
                                            <p class="text-gray-800">${taskData.example_input}</p>
                                        </div>` : ''}
                                    </div>
                                    
                                    ${taskData.hints && Array.isArray(taskData.hints) && taskData.hints.length > 0 ? `<div class="bg-yellow-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-yellow-800 mb-1">ğŸ’¡ íŒíŠ¸</h5>
                                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                            ${taskData.hints.filter(hint => hint && typeof hint === 'string').map(hint => `<li>${hint}</li>`).join('')}
                                        </ul>
                                    </div>` : ''}
                                    
                                    ${taskData.sample_answer && taskData.sample_answer.trim() ? `<div class="bg-green-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-green-800 mb-1">ğŸ’¡ ì˜ˆì‹œ ë‹µì•ˆ</h5>
                                        <p class="text-sm text-green-700">${taskData.sample_answer}</p>
                                    </div>` : ''}
                                    
                                    <div>
                                        <label class="block font-medium text-slate-700 mb-2">ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:</label>
                                        <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  rows="3" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                                    </div>
                                    
                                    <div class="flex gap-3">
                                        <button id="submit-answer-btn" class="btn btn-primary">ì œì¶œ</button>
                                        <button id="skip-answer-btn" class="btn btn-secondary">ê±´ë„ˆë›°ê¸°</button>
                                    </div>
                                </div>
                            `;
                            
                            // Store task data for later evaluation
                            window.currentPatternTask = taskData;
                        } else {
                            // Fallback to enhanced static content if AI fails or returns invalid data
                            console.log('Using fallback content due to invalid AI response:', taskData);
                            loadingDiv.classList.add('hidden');
                            contentDiv.classList.remove('hidden');
                            contentDiv.innerHTML = `
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">ğŸ“‹ í•™ìŠµ ê³¼ì œ</h4>
                                        <p class="text-blue-700">ì´ íŒ¨í„´ "${item.pattern}"ì„(ë¥¼) ì‚¬ìš©í•´ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <p class="font-medium mb-2">ì˜ˆì‹œ:</p>
                                        <p class="text-slate-800">${item.examples[0]?.en || item.pattern + ' example'}</p>
                                        <p class="text-slate-600">${item.examples[0]?.ko || 'ì´ íŒ¨í„´ì„ ì‚¬ìš©í•œ ì˜ˆì‹œì…ë‹ˆë‹¤'}</p>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-yellow-800 mb-1">ğŸ’¡ íŒíŠ¸</h5>
                                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                            <li>ì‹¤ì œ ìƒí™©ì„ ë– ì˜¬ë¦¬ë©° ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</li>
                                            <li>íŒ¨í„´ì˜ ì˜ë¯¸ë¥¼ ìƒê°í•˜ë©° ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•˜ì„¸ìš”</li>
                                            <li>ê°„ë‹¨í•œ ë¬¸ì¥ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <label class="block font-medium text-slate-700 mb-2">ì´ íŒ¨í„´ì„ ì‚¬ìš©í•´ì„œ ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”:</label>
                                        <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  rows="3" placeholder="íŒ¨í„´ì„ í™œìš©í•œ ë¬¸ì¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="submit-answer-btn" class="btn btn-primary">ì œì¶œ</button>
                                        <button id="skip-answer-btn" class="btn btn-secondary">ê±´ë„ˆë›°ê¸°</button>
                                    </div>
                                </div>
                            `;
                            
                            // Set a fallback task data
                            window.currentPatternTask = {
                                task_type: 'creation',
                                instruction: `ì´ íŒ¨í„´ "${item.pattern}"ì„(ë¥¼) ì‚¬ìš©í•´ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.`
                            };
                        }
                        
                        // Add event listeners
                        const submitBtn = document.getElementById('submit-answer-btn');
                        const skipBtn = document.getElementById('skip-answer-btn');
                        
                        if (submitBtn) {
                            submitBtn.addEventListener('click', () => {
                                const userAnswer = document.getElementById('user-answer')?.value || '';
                                handlePlanAnswer(item, userAnswer);
                            });
                        }
                        
                        if (skipBtn) {
                            skipBtn.addEventListener('click', () => handlePlanAnswer(item, ''));
                        }
                    }).catch(error => {
                        console.error('Pattern task generation failed:', error);
                        // Show enhanced fallback content
                        const loadingDiv = document.getElementById('pattern-loading');
                        const contentDiv = document.getElementById('pattern-task-content');
                        
                        if (loadingDiv && contentDiv) {
                            loadingDiv.classList.add('hidden');
                            contentDiv.classList.remove('hidden');
                            contentDiv.innerHTML = `
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">ğŸ“‹ í•™ìŠµ ê³¼ì œ</h4>
                                        <p class="text-blue-700">ì´ íŒ¨í„´ "${item.pattern}"ì„(ë¥¼) ì‚¬ìš©í•´ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <p class="font-medium mb-2">ì˜ˆì‹œ:</p>
                                        <p class="text-slate-800">${item.examples[0]?.en || item.pattern + ' example'}</p>
                                        <p class="text-slate-600">${item.examples[0]?.ko || 'ì´ íŒ¨í„´ì„ ì‚¬ìš©í•œ ì˜ˆì‹œì…ë‹ˆë‹¤'}</p>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-yellow-800 mb-1">ğŸ’¡ íŒíŠ¸</h5>
                                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                            <li>ì‹¤ì œ ìƒí™©ì„ ë– ì˜¬ë¦¬ë©° ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</li>
                                            <li>íŒ¨í„´ì˜ ì˜ë¯¸ë¥¼ ìƒê°í•˜ë©° ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•˜ì„¸ìš”</li>
                                            <li>ê°„ë‹¨í•œ ë¬¸ì¥ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <label class="block font-medium text-slate-700 mb-2">ì´ íŒ¨í„´ì„ ì‚¬ìš©í•´ì„œ ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”:</label>
                                        <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  rows="3" placeholder="íŒ¨í„´ì„ í™œìš©í•œ ë¬¸ì¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="submit-answer-btn" class="btn btn-primary">ì œì¶œ</button>
                                        <button id="skip-answer-btn" class="btn btn-secondary">ê±´ë„ˆë›°ê¸°</button>
                                    </div>
                                </div>
                            `;
                            
                            // Set fallback task data for evaluation
                            window.currentPatternTask = {
                                task_type: 'creation',
                                instruction: `ì´ íŒ¨í„´ "${item.pattern}"ì„(ë¥¼) ì‚¬ìš©í•´ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ ë¬¸ì¥ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.`
                            };
                            
                            // Add event listeners for fallback
                            const submitBtn = document.getElementById('submit-answer-btn');
                            const skipBtn = document.getElementById('skip-answer-btn');
                            
                            if (submitBtn) {
                                submitBtn.addEventListener('click', () => {
                                    const userAnswer = document.getElementById('user-answer')?.value || '';
                                    handlePlanAnswer(item, userAnswer);
                                });
                            }
                            
                            if (skipBtn) {
                                skipBtn.addEventListener('click', () => handlePlanAnswer(item, ''));
                            }
                        }
                    });
                } else {
                    // Grammar/Translation item rendering for Plan mode
                    const itemFormat = getItemQuizFormat(item);
                    
                    if (planSession.phase === 'review') {
                        // Review mode uses consistent format based on item type
                        let reviewContent = '';
                        
                        if (itemFormat === 'translation') {
                            // Use translation format for cheonilmun items
                            reviewContent = `
                                <div class="space-y-6">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-500 font-medium">${progressText}</span>
                                        <span class="text-red-500 text-sm font-medium">ë³µìŠµ</span>
                                    </div>
                                    ${item.chapter ? `<div class="text-sm text-slate-500">${item.chapter} â†’ ${item.unit}</div>` : ''}
                                    <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                                        <p class="mt-1 text-indigo-700">${item.analysis ? item.analysis.explanation : 'ì´ ë¬¸ì¥ì„ ë²ˆì—­í•´ë³´ì„¸ìš”.'}</p>
                                    </div>
                                    <div class="bg-slate-100 p-4 rounded-lg">
                                        <p class="text-lg font-semibold">${item.en}</p>
                                    </div>
                                    <div class="mt-6">
                                        <h4 class="font-semibold text-lg mb-2">ğŸ“ í€´ì¦ˆ: ë¬¸ì¥ ë²ˆì—­í•˜ê¸°</h4>
                                        <textarea id="quiz-input" class="w-full h-24 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  placeholder="ìœ„ ì˜ì–´ ë¬¸ì¥ì„ ìš°ë¦¬ë§ë¡œ ë²ˆì—­í•´ë³´ì„¸ìš”..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="check-answer-btn" class="btn btn-primary">ì •ë‹µ í™•ì¸</button>
                                    </div>
                                    <div id="feedback-area"></div>
                                </div>
                            `;
                        } else {
                            // Use fill-in-the-blank format for other items  
                            const answer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                            const quizHtml = item.en.replace(answer, `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
                            
                            reviewContent = `
                                <div class="space-y-6">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-500 font-medium">${progressText}</span>
                                        <span class="text-red-500 text-sm font-medium">ë³µìŠµ</span>
                                    </div>
                                    ${item.chapter ? `<div class="text-sm text-slate-500">${item.chapter} â†’ ${item.unit}</div>` : ''}
                                    <div class="bg-slate-50 p-6 rounded-lg">
                                        <p class="text-slate-600 mb-3">${item.ko}</p>
                                        <div class="text-lg font-mono">${quizHtml}</div>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="check-answer-btn" class="btn btn-primary">ì •ë‹µ í™•ì¸</button>
                                    </div>
                                    <div id="feedback-area"></div>
                                </div>
                            `;
                        }
                        
                        moduleContent.innerHTML = reviewContent;
                        
                        document.getElementById('check-answer-btn').addEventListener('click', () => {
                            handlePlanAnswer(item);
                        });
                    } else {
                        // New learning mode uses translation
                        moduleContent.innerHTML = `
                            <div class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500 font-medium">${progressText}</span>
                                    <span class="text-green-500 text-sm font-medium">ì‹ ê·œ í•™ìŠµ</span>
                                </div>
                                ${item.chapter ? `<div class="text-sm text-slate-500">${item.chapter} â†’ ${item.unit}</div>` : ''}
                                <div class="bg-slate-50 p-6 rounded-lg">
                                    <p class="text-lg font-medium text-slate-800 mb-4">${item.en}</p>
                                    ${item.answer ? `<p class="text-sm text-slate-500">í•µì‹¬ ë‹¨ì–´: <strong>${item.answer}</strong></p>` : ''}
                                </div>
                                <div>
                                    <label class="block font-medium text-slate-700 mb-2">í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ë³´ì„¸ìš”:</label>
                                    <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                              rows="3" placeholder="ë²ˆì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
                                </div>
                                <div class="flex gap-3">
                                    <button id="submit-answer-btn" class="btn btn-primary">ì œì¶œ</button>
                                </div>
                                <div id="feedback-area"></div>
                            </div>
                        `;
                        
                        // Add event listeners for non-pattern items
                        const submitBtn = document.getElementById('submit-answer-btn');
                        const userAnswerField = document.getElementById('user-answer');

                        if (submitBtn) {
                            submitBtn.addEventListener('click', () => handlePlanAnswer(item));
                        }
                        if (userAnswerField) {
                            userAnswerField.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    handlePlanAnswer(item);
                                }
                            });
                            userAnswerField.focus();
                        }
                    }
                }

                return;
            }

            // Original Drill mode logic
            if (sessionState.queue.length === 0 || sessionState.currentIndex >= sessionState.queue.length) {
                const resetButtonHtml = quizType === 'review' ? 
                    `<div class="mt-4"><button id="reset-review-btn" class="btn btn-secondary">ë³µìŠµ ë°ì´í„° ì´ˆê¸°í™”</button></div>` : '';
                moduleContent.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-slate-500">ëª¨ë“  í•™ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</p>
                        ${resetButtonHtml}
                    </div>`;
                
                if (quizType === 'review') {
                    const resetBtn = document.getElementById('reset-review-btn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            if (confirm('ë³µìŠµ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                                resetReviewData();
                                showDashboard();
                            }
                        });
                    }
                }
                return;
            }

            const item = sessionState.queue[sessionState.currentIndex];
            let header = '';
            let quizContent = '';

            // Determine consistent format based on item characteristics, not quiz type
            const itemFormat = getItemQuizFormat(item);
            
            switch(quizType) {
                case 'review':
                    header = `ë³µìŠµ í€´ì¦ˆ (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createQuizByFormat(item, itemFormat); // Use consistent format
                    break;
                case 'cheonilmun':
                    header = `${item.chapter} - ${item.unit} (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createQuizByFormat(item, itemFormat); // Use consistent format
                    break;
                case 'pattern':
                    header = `íŒ¨í„´ ì‘ìš© í€´ì¦ˆ (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createQuizByFormat(item, itemFormat); // Use consistent format
                    break;
            }

            const resetButtonHtml = quizType === 'review' ? 
                `<button id="reset-review-quiz-btn" class="btn btn-secondary ml-2">ë°ì´í„° ì´ˆê¸°í™”</button>` : '';
            
            moduleContent.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">${header}</h3>
                        ${resetButtonHtml}
                    </div>
                    <div id="quiz-content-area" class="mt-4">${quizContent}</div>
                    <div id="feedback-container" class="mt-4"></div>
                    <div id="quiz-nav" class="flex gap-4 mt-6">
                        <button id="check-answer-btn" class="btn btn-primary w-full">ì •ë‹µ í™•ì¸</button>
                    </div>
                </div>
            `;
            
            document.getElementById('check-answer-btn').addEventListener('click', () => checkAnswer(quizType, item));
            
            if (quizType === 'review') {
                const resetQuizBtn = document.getElementById('reset-review-quiz-btn');
                if (resetQuizBtn) {
                    resetQuizBtn.addEventListener('click', () => {
                        if (confirm('ë³µìŠµ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                            resetReviewData();
                            showDashboard();
                        }
                    });
                }
            }
        }

        function createFillInBlankQuiz(item) {
            let koText, quizHtml, answer;
            if (item.type === 'pattern') {
                const example = item.examples[0];
                koText = example.ko;
                answer = item.pattern;
                const escapedPattern = item.pattern.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                quizHtml = example.en.replace(new RegExp(escapedPattern, 'i'), `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            } else {
                koText = item.ko;
                answer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                quizHtml = item.en.replace(answer, `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            }
            return `<div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-lg">${koText}</p>
                        <div class="mt-2 text-xl font-mono">${quizHtml}</div>
                    </div>`;
        }
        
        function createTranslationQuiz(item) {
            return `
                <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <p class="mt-1 text-indigo-700">${item.analysis.explanation}</p>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg">
                    <p class="text-lg font-semibold">${item.en}</p>
                </div>
                <div class="mt-6">
                    <h4 class="font-semibold text-lg mb-2">ğŸ“ í€´ì¦ˆ: ë¬¸ì¥ ë²ˆì—­í•˜ê¸°</h4>
                    <textarea id="quiz-input" class="w-full h-24 p-3 border rounded-lg" placeholder="ìœ„ ì˜ì–´ ë¬¸ì¥ì„ ìš°ë¦¬ë§ë¡œ ë²ˆì—­í•´ë³´ì„¸ìš”..."></textarea>
                </div>`;
        }

        function createCompositionQuiz(item) {
            return `
                <div class="bg-emerald-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-emerald-800">ğŸ—£ï¸ ì˜¤ëŠ˜ì˜ íŒ¨í„´: <span class="font-bold">${item.pattern}</span></h4>
                    <p class="text-emerald-600">${item.pattern_ko}</p>
                </div>
                <div class="space-y-3 mb-6">
                    ${item.examples.map(ex => `<div class="bg-slate-100 p-3 rounded-md"><p>${ex.en}</p><p class="text-sm text-slate-500">${ex.ko}</p></div>`).join('')}
                </div>
                <div>
                    <h4 class="font-semibold text-lg mb-2">ğŸ“ í€´ì¦ˆ: ì‘ìš© ì‘ë¬¸í•˜ê¸°</h4>
                    <p class="text-slate-600 mb-2">ìƒí™©: ${item.examples[1] ? item.examples[1].ko : 'ììœ ë¡­ê²Œ ì‘ë¬¸í•´ë³´ì„¸ìš”.'}</p>
                    <input type="text" id="quiz-input" class="w-full p-2 border rounded-lg" placeholder="ìœ„ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ì‘ë¬¸í•´ë³´ì„¸ìš”...">
                </div>`;
        }

        function checkAnswer(quizType, item) {
            const feedbackContainer = document.getElementById('feedback-container');
            const quizInput = document.getElementById('quiz-input');
            const userAnswer = quizInput ? quizInput.value.trim() : '';
            let feedbackHtml = '';
            let isCorrect = true; // Default for non-review modes

            switch(quizType) {
                case 'plan':
                    // Plan mode uses different grading system
                    handlePlanAnswer(item, userAnswer);
                    return;
                case 'review':
                    const answer = item.type === 'pattern' ? item.pattern : (item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, ''));
                    isCorrect = userAnswer.toLowerCase() === answer.toLowerCase();
                    
                    // í•™ìŠµ ì§„í–‰ ìƒí™© ê¸°ë¡ (legacy system for Drill mode)
                    const progress = recordLearningProgress(item, isCorrect);
                    
                    // ë‹¤ìŒ ë³µìŠµ ì •ë³´ ìƒì„±
                    const nextReviewDate = new Date(progress.nextReviewDate);
                    const nextReviewText = nextReviewDate.toLocaleDateString('ko-KR');
                    const intervalText = progress.reviewLevel < SPACED_REPETITION_INTERVALS.length - 1 ? 
                        `${SPACED_REPETITION_INTERVALS[progress.reviewLevel]}ì¼ í›„` : 'ë§ˆìŠ¤í„° ì™„ë£Œ';
                    
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                                      <p class="font-bold">${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰' : 'ì•„ì‰¬ì›Œìš”!'}</p>
                                      <p><strong>ì •ë‹µ:</strong> ${answer}</p>
                                      <div class="mt-3 p-3 bg-slate-50 rounded-lg text-sm">
                                          <p><strong>ğŸ“Š ë³µìŠµ ì§„í–‰ë¥ :</strong> ${progress.correctCount}/${progress.totalAttempts} (${Math.round(progress.correctCount/progress.totalAttempts*100)}%)</p>
                                          <p><strong>ğŸ“… ë‹¤ìŒ ë³µìŠµ:</strong> ${progress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1 ? 'ì™„ë£Œë¨ ğŸŠ' : `${nextReviewText} (${intervalText})`}</p>
                                          <p><strong>ğŸ”„ ë³µìŠµ ë‹¨ê³„:</strong> ${progress.reviewLevel + 1}/${SPACED_REPETITION_INTERVALS.length}</p>
                                      </div>
                                  </div>`;
                    break;
                case 'cheonilmun':
                    // ì²œì¼ë¬¸ í•™ìŠµ ì™„ë£Œ ì‹œì—ë„ í•™ìŠµ ê¸°ë¡ ì €ì¥
                    recordLearningProgress(item, true);
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">ëª¨ë²” ë²ˆì—­</p>
                                      <p>${item.ko}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">âœ… ì´ ë¬¸ì¥ì´ ë³µìŠµ ì‹œìŠ¤í…œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                                      </div>
                                  </div>`;
                    break;
                case 'pattern':
                    // íŒ¨í„´ í•™ìŠµ ì™„ë£Œ ì‹œì—ë„ í•™ìŠµ ê¸°ë¡ ì €ì¥
                    recordLearningProgress(item, true);
                    const exampleAnswer = item.examples[1] ? item.examples[1].en : "Great job applying the pattern!";
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">ì¢‹ì€ ì‹œë„ì…ë‹ˆë‹¤!</p>
                                      <p><strong>ëª¨ë²” ë‹µì•ˆ ì˜ˆì‹œ:</strong> ${exampleAnswer}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">âœ… ì´ íŒ¨í„´ì´ ë³µìŠµ ì‹œìŠ¤í…œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                                      </div>
                                  </div>`;
                    break;
            }
            
            feedbackContainer.innerHTML = feedbackHtml + createAnalysisHTML(item);

            const quizNav = document.getElementById('quiz-nav');
            if (sessionState.currentIndex < sessionState.queue.length - 1) {
                quizNav.innerHTML = `<button id="next-quiz-btn" class="btn btn-primary w-full">ë‹¤ìŒ ë¬¸ì œ</button>`;
                document.getElementById('next-quiz-btn').addEventListener('click', () => {
                    sessionState.currentIndex++;
                    renderQuiz(quizType);
                });
            } else {
                const completionMessage = quizType === 'review' ? 'ë³µìŠµ ì™„ë£Œ! ğŸ‰' : 'í•™ìŠµ ì™„ë£Œ';
                quizNav.innerHTML = `<button id="finish-quiz-btn" class="btn btn-secondary w-full">${completionMessage}</button>`;
                document.getElementById('finish-quiz-btn').addEventListener('click', () => {
                    // ë³µìŠµ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    updateReviewCount();
                    showDashboard();
                });
            }
        }

        // --- Plan Mode: Answer Handling ---
        function handlePlanAnswer(item, userAnswer) {
            const itemId = String(getItemId(item));
            
            // Check if this item has already been processed in this session
            const alreadyProcessed = planSession.results[planSession.phase].items.some(
                processedItem => getItemId(processedItem) === getItemId(item)
            );
            
            // Determine grade based on content and user input
            let grade = 3; // Default: good
            let isCorrect = true;
            let result = null;
            
            // For review items, check accuracy
            if (planSession.phase === 'review') {
                // For pattern items, use AI evaluation instead of simple matching
                if (item.type === 'pattern' && item.pattern) {
                    // Handle pattern items with AI evaluation
                    handlePatternReviewAnswer(item, userAnswer, alreadyProcessed);
                    return;
                } else {
                    // For non-pattern items, check format and handle accordingly
                    const itemFormat = getItemQuizFormat(item);
                    const quizInput = document.getElementById('quiz-input');
                    const actualAnswer = quizInput ? quizInput.value.trim() : '';
                    
                    if (!actualAnswer) {
                        grade = 0; // No answer
                        isCorrect = false;
                    } else if (itemFormat === 'translation') {
                        // For translation format, we don't have strict matching
                        // Just check if user provided some answer (lenient grading for translation)
                        if (actualAnswer.length > 0) {
                            grade = 3; // Good - user provided translation
                            isCorrect = true; // Consider it correct since translation can vary
                        } else {
                            grade = 0; // No answer
                            isCorrect = false;
                        }
                    } else {
                        // For fill-in-the-blank format, use strict matching
                        const expectedAnswer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                        if (actualAnswer.toLowerCase() === expectedAnswer.toLowerCase()) {
                            grade = 4; // Easy/correct
                        } else {
                            grade = 1; // Wrong
                            isCorrect = false;
                        }
                    }
                }
            }
            // For new items and output, we assume they tried (grade 3)
            
            // Update SM-2 schedule only if not already processed
            if (!alreadyProcessed) {
                result = calculateNextReview(item, grade);
                
                // Remove from today queue if this was a first exposure
                if (isTodayQueueItem(itemId)) {
                    removeFromTodayQueue(itemId);
                }
                
                // Record result in plan session
                planSession.results[planSession.phase].items.push({
                    ...item,
                    grade,
                    isCorrect,
                    userAnswer
                });
                
                if (isCorrect) {
                    planSession.results[planSession.phase].correct++;
                }
            } else {
                // For already processed items, get current progress for display
                const progress = loadPlanProgress();
                const currentProgress = progress[itemId];
                if (currentProgress) {
                    result = {
                        ...currentProgress,
                        intervalDays: Math.round((currentProgress.next - currentProgress.last) / (24 * 60 * 60 * 1000))
                    };
                }
                console.log('Item already processed in this session, not updating review schedule');
            }
            
            // Show feedback
            let feedbackHtml = '';
            if (planSession.phase === 'review') {
                const itemFormat = getItemQuizFormat(item);
                const nextDate = new Date(result.next).toLocaleDateString('ko-KR');
                
                if (itemFormat === 'translation') {
                    // For translation format, show model translation
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                            <p class="font-bold">${isCorrect ? 'ì¢‹ì€ ë²ˆì—­ì…ë‹ˆë‹¤! ğŸ‰' : 'ë‹¤ì‹œ í•œë²ˆ!'}</p>
                            <p><strong>ëª¨ë²” ë²ˆì—­:</strong> ${item.ko}</p>
                            <div class="mt-2 text-sm text-slate-600">
                                <p>ë‹¤ìŒ ë³µìŠµ: ${nextDate} (${result.intervalDays}ì¼ í›„)</p>
                                <p>EF: ${result.ef.toFixed(1)}, ë‹¨ê³„: ${result.stage + 1}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // For fill-in-blank format, show exact answer
                    const correctAnswer = item.type === 'pattern' ? item.pattern : (item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, ''));
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                            <p class="font-bold">${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰' : 'ë‹¤ì‹œ í•œë²ˆ!'}</p>
                            <p><strong>ì •ë‹µ:</strong> ${correctAnswer}</p>
                            <div class="mt-2 text-sm text-slate-600">
                                <p>ë‹¤ìŒ ë³µìŠµ: ${nextDate} (${result.intervalDays}ì¼ í›„)</p>
                                <p>EF: ${result.ef.toFixed(1)}, ë‹¨ê³„: ${result.stage + 1}</p>
                            </div>
                        </div>
                    `;
                }
            } else if (planSession.phase === 'new') {
                feedbackHtml = `
                    <div class="p-4 border-l-4 rounded-md feedback-correct">
                        <p class="font-bold">ìƒˆë¡œìš´ í•™ìŠµ! ğŸ“š</p>
                        <p><strong>ëª¨ë²” ë²ˆì—­:</strong> ${item.ko}</p>
                        <div class="mt-2 text-sm text-green-600">
                            <p>âœ… ë‚´ì¼ë¶€í„° ë³µìŠµ ì¼ì •ì— ì¶”ê°€ë©ë‹ˆë‹¤!</p>
                        </div>
                    </div>
                `;
            } else if (planSession.phase === 'output') {
                // Check if this is a pattern item and use Gemini AI evaluation
                if (item.pattern && userAnswer && window.currentPatternTask) {
                    // Use Gemini AI to evaluate pattern answer
                    const taskType = window.currentPatternTask.task_type || 'creation';
                    
                    // Show loading feedback first
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md feedback-correct">
                            <div class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="font-bold">AIê°€ ë‹µë³€ì„ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                    
                    // Evaluate with Gemini AI
                    evaluatePatternAnswerWithGemini(item.pattern, item.pattern_ko, userAnswer, taskType).then(evaluation => {
                        if (evaluation && typeof evaluation === 'object') {
                            feedbackHtml = `
                                <div class="p-4 border-l-4 rounded-md ${evaluation.is_correct ? 'feedback-correct' : 'feedback-incorrect'}">
                                    <p class="font-bold">${evaluation.is_correct ? 'í›Œë¥­í•©ë‹ˆë‹¤! ğŸ‰' : 'ì¢‹ì€ ì‹œë„ì…ë‹ˆë‹¤! ğŸ’ª'}</p>
                                    <div class="mt-3 space-y-3">
                                        <div class="bg-white p-3 rounded-lg">
                                            <p class="font-medium text-gray-800">í”¼ë“œë°±:</p>
                                            <p class="text-gray-700">${evaluation.feedback || 'ì¢‹ì€ ì‹œë„ì˜€ìŠµë‹ˆë‹¤!'}</p>
                                        </div>
                                        
                                        ${evaluation.corrected_version && evaluation.corrected_version.trim() ? `
                                            <div class="bg-blue-50 p-3 rounded-lg">
                                                <p class="font-medium text-blue-800">ê°œì„ ëœ ë‹µì•ˆ:</p>
                                                <p class="text-blue-700">${evaluation.corrected_version}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${evaluation.suggestions && Array.isArray(evaluation.suggestions) && evaluation.suggestions.length > 0 ? `
                                            <div class="bg-yellow-50 p-3 rounded-lg">
                                                <p class="font-medium text-yellow-800">ê°œì„  ì œì•ˆ:</p>
                                                <ul class="text-yellow-700 list-disc list-inside space-y-1">
                                                    ${evaluation.suggestions.filter(s => s && typeof s === 'string').map(suggestion => `<li>${suggestion}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        
                                        ${evaluation.detailed_comparison ? `
                                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                                <p class="font-medium text-purple-800 mb-3">ğŸ” ìƒì„¸ ë¹„êµ ë¶„ì„</p>
                                                <div class="space-y-3 text-sm">
                                                    ${evaluation.detailed_comparison.grammar_analysis ? `
                                                        <div class="border-l-4 border-purple-300 pl-3">
                                                            <p class="font-medium text-purple-700">ë¬¸ë²• ë¶„ì„:</p>
                                                            <p class="text-purple-600">${evaluation.detailed_comparison.grammar_analysis}</p>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${evaluation.detailed_comparison.tone_analysis ? `
                                                        <div class="border-l-4 border-purple-300 pl-3">
                                                            <p class="font-medium text-purple-700">í†¤/ë‰˜ì•™ìŠ¤ ë¶„ì„:</p>
                                                            <p class="text-purple-600">${evaluation.detailed_comparison.tone_analysis}</p>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${evaluation.detailed_comparison.usage_analysis ? `
                                                        <div class="border-l-4 border-purple-300 pl-3">
                                                            <p class="font-medium text-purple-700">ì‚¬ìš©ë²• ë¶„ì„:</p>
                                                            <p class="text-purple-600">${evaluation.detailed_comparison.usage_analysis}</p>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="bg-green-50 p-3 rounded-lg text-sm">
                                            <p class="text-green-700">
                                                ğŸ“Š AI í‰ê°€ ì ìˆ˜: ${evaluation.score || 3}/5 | 
                                                âœ… ì´ íŒ¨í„´ì´ ë³µìŠµ ì‹œìŠ¤í…œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Fallback to enhanced feedback with basic comparison if AI fails
                            console.log('AI evaluation failed, using enhanced fallback');
                            feedbackHtml = `
                                <div class="p-4 border-l-4 rounded-md feedback-correct">
                                    <p class="font-bold">íŒ¨í„´ ì—°ìŠµ ì™„ë£Œ! âœï¸</p>
                                    <div class="mt-3 space-y-3">
                                        <div class="bg-white p-3 rounded-lg">
                                            <p class="font-medium text-gray-800">ì‘ì„±í•˜ì‹  ë‹µë³€:</p>
                                            <p class="text-gray-700">"${userAnswer}"</p>
                                        </div>
                                        
                                        <div class="bg-blue-50 p-3 rounded-lg">
                                            <p class="font-medium text-blue-800">íŒ¨í„´:</p>
                                            <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                                        </div>
                                        
                                        ${item.examples && item.examples.length > 0 ? `
                                            <div class="bg-gray-50 p-3 rounded-lg">
                                                <p class="font-medium text-gray-800">ì°¸ê³  ì˜ˆì‹œ:</p>
                                                <p class="text-gray-700">${item.examples[0].en}</p>
                                                <p class="text-gray-600 text-sm">${item.examples[0].ko}</p>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="bg-yellow-50 p-3 rounded-lg">
                                            <p class="font-medium text-yellow-800">ğŸ’¡ í•™ìŠµ íŒ:</p>
                                            <p class="text-yellow-700 text-sm">íŒ¨í„´ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ìƒí™©ì—ì„œ ì´ íŒ¨í„´ì„ í™œìš©í•´ë³´ì„¸ìš”!</p>
                                        </div>
                                        
                                        <div class="bg-green-50 p-3 rounded-lg text-sm">
                                            <p class="text-green-700">âœ… ì´ íŒ¨í„´ì´ ë³µìŠµ ì‹œìŠ¤í…œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                        
                        // Add next button
                        const nextButton = `<button id="next-plan-btn" class="btn btn-primary">ë‹¤ìŒ â†’</button>`;
                        document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                        
                        document.getElementById('next-plan-btn').addEventListener('click', () => {
                            planSession.currentIndex++;
                            renderQuiz('plan');
                        });
                    }).catch(error => {
                        console.error('Pattern evaluation failed:', error);
                        // Enhanced fallback feedback with basic comparison
                        feedbackHtml = `
                            <div class="p-4 border-l-4 rounded-md feedback-correct">
                                <p class="font-bold">íŒ¨í„´ ì—°ìŠµ ì™„ë£Œ! âœï¸</p>
                                <div class="mt-3 space-y-3">
                                    <div class="bg-white p-3 rounded-lg">
                                        <p class="font-medium text-gray-800">ì‘ì„±í•˜ì‹  ë‹µë³€:</p>
                                        <p class="text-gray-700">"${userAnswer}"</p>
                                    </div>
                                    
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <p class="font-medium text-blue-800">íŒ¨í„´:</p>
                                        <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                                    </div>
                                    
                                    ${item.examples && item.examples.length > 0 ? `
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <p class="font-medium text-gray-800">ì°¸ê³  ì˜ˆì‹œ:</p>
                                            <p class="text-gray-700">${item.examples[0].en}</p>
                                            <p class="text-gray-600 text-sm">${item.examples[0].ko}</p>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <p class="font-medium text-yellow-800">ğŸ’¡ í•™ìŠµ íŒ:</p>
                                        <p class="text-yellow-700 text-sm">íŒ¨í„´ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ìƒí™©ì—ì„œ ì´ íŒ¨í„´ì„ í™œìš©í•´ë³´ì„¸ìš”!</p>
                                    </div>
                                    
                                    <div class="bg-green-50 p-3 rounded-lg text-sm">
                                        <p class="text-green-700">âœ… ì´ íŒ¨í„´ì´ ë³µìŠµ ì‹œìŠ¤í…œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                        
                        // Add next button
                        const nextButton = `<button id="next-plan-btn" class="btn btn-primary">ë‹¤ìŒ â†’</button>`;
                        document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                        
                        document.getElementById('next-plan-btn').addEventListener('click', () => {
                            planSession.currentIndex++;
                            renderQuiz('plan');
                        });
                    });
                    
                    // Early return to avoid showing the next button twice
                    return;
                } else {
                    // Regular output phase feedback for non-pattern items
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md feedback-correct">
                            <p class="font-bold">ë³€í˜• ì—°ìŠµ ì™„ë£Œ! âœï¸</p>
                            <p><strong>ì›ë¬¸:</strong> ${item.originalKo || item.ko}</p>
                            <div class="mt-2 text-sm text-yellow-600">
                                <p>ğŸ’ª ì°½ì‘ ì—°ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
            
            // Show next button
            const nextButton = `<button id="next-plan-btn" class="btn btn-primary">ë‹¤ìŒ â†’</button>`;
            document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
            
            document.getElementById('next-plan-btn').addEventListener('click', () => {
                planSession.currentIndex++;
                renderQuiz('plan');
            });
        }

        function renderAcademicModule() {
            moduleContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">ë…¼ë¬¸/ì›ì„œ ë¬¸ì¥ ì…ë ¥</h3>
                <p class="mb-4 text-slate-600">ë¶„ì„í•˜ê³  ì‹¶ì€ ë¬¸ì¥ì„ ì…ë ¥í•˜ë©´, êµ¬ì¡°ì™€ ì–´íœ˜ë¥¼ ë¶„ì„í•˜ê³  ê°œì¸ ë³µìŠµ ë°ì´í„°ì— ì¶”ê°€í•´ ë“œë¦½ë‹ˆë‹¤.</p>
                <textarea id="academic-input" class="w-full h-32 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="ì—¬ê¸°ì— ì˜ì–´ ë¬¸ì¥ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                <div id="analysis-output" class="mt-4"></div>
                <button id="analyze-btn" class="btn btn-secondary w-full py-2 rounded-lg mt-4">ë¶„ì„ ë° ì €ì¥í•˜ê¸°</button>
            `;
            document.getElementById('analyze-btn').addEventListener('click', () => {
                const academicInput = document.getElementById('academic-input');
                if (!academicInput) return;
                const text = academicInput.value.trim();
                if (text) {
                    const now = new Date();
                    const newEntry = {
                        type: 'academic',
                        id: `academic_${Date.now()}`,
                        en: text,
                        ko: '(ì‚¬ìš©ì ì…ë ¥ ë¬¸ì¥)',
                        answer: text.split(' ').pop().replace(/[.,!?]/g, ''),
                        analysis: { point: 'ì‚¬ìš©ì ì…ë ¥ ë¬¸ì¥', explanation: 'ì´ ë¬¸ì¥ì€ ê°œì¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì–´ ì£¼ê¸°ì ìœ¼ë¡œ ë³µìŠµ í€´ì¦ˆì— ì¶œì œë©ë‹ˆë‹¤.', vocab: {} },
                        createdAt: now.toISOString(),
                        createdAtFormatted: now.toLocaleDateString('ko-KR') + ' ' + now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                    };
                    masterData.academic.push(newEntry);
                    
                    // ìë™ìœ¼ë¡œ ì²« ë³µìŠµ ì¼ì • ì„¤ì • (1ì¼ í›„)
                    recordLearningProgress(newEntry, true);
                    
                    document.getElementById('analysis-output').innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800">ğŸ”¬ ì €ì¥ ì™„ë£Œ</h4>
                            <p class="mt-2 text-green-700">ë¬¸ì¥ì´ ê°œì¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            <p class="mt-1 text-green-600 text-sm">ğŸ“… ë‚´ì¼ë¶€í„° ë³µìŠµ í€´ì¦ˆì— í¬í•¨ë©ë‹ˆë‹¤!</p>
                        </div>`;
                    academicInput.value = '';
                    
                    // ë³µìŠµ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    updateReviewCount();
                }
            });
        }

        function renderLibraryModule() {
            const libraryContent = document.createElement('div');
            libraryContent.id = 'library-content';
            libraryContent.className = 'max-h-[50vh] overflow-y-auto custom-scrollbar pr-2';
            
            moduleContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <input type="text" id="library-search-input" class="flex-1 p-3 border rounded-lg mr-4" placeholder="í•™ìŠµí•œ ë‚´ìš© ê²€ìƒ‰í•˜ê¸° (ì˜ˆ: ë¶„ì‚¬êµ¬ë¬¸, was going to)...">
                    <button id="reset-library-btn" class="btn btn-secondary whitespace-nowrap">ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™”</button>
                </div>
            `;
            moduleContent.appendChild(libraryContent);
            
            const searchInput = document.getElementById('library-search-input');
            const resetLibraryBtn = document.getElementById('reset-library-btn');
            
            if (resetLibraryBtn) {
                resetLibraryBtn.addEventListener('click', () => {
                    if (confirm('í•™ìŠµ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                        resetLibraryData();
                        filterAndRender(); // Refresh the display
                        updateReviewCount(); // Update dashboard count
                    }
                });
            }

            function filterAndRender() {
                const searchTerm = searchInput.value.toLowerCase();
                const allData = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
                
                const filteredData = allData.filter(item => {
                    if (item.pattern) {
                        // Pattern data structure
                        const patternMatch = item.pattern.toLowerCase().includes(searchTerm);
                        const examplesMatch = item.examples && item.examples.some(ex => 
                            (ex.ko && ex.ko.toLowerCase().includes(searchTerm)) || 
                            (ex.en && ex.en.toLowerCase().includes(searchTerm))
                        );
                        return patternMatch || examplesMatch;
                    } else {
                        // Cheonilmun or Academic data structure
                        const koMatch = item.ko && item.ko.toLowerCase().includes(searchTerm);
                        const enMatch = item.en && item.en.toLowerCase().includes(searchTerm);
                        const analysisMatch = item.analysis && item.analysis.point && 
                            item.analysis.point.toLowerCase().includes(searchTerm);
                        return koMatch || enMatch || analysisMatch;
                    }
                });

                if (filteredData.length === 0) {
                    libraryContent.innerHTML = `<p class="text-center text-slate-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                libraryContent.innerHTML = filteredData.map(item => {
                    const timestampHtml = item.createdAtFormatted ? 
                        `<p class="text-xs text-slate-400 mt-1">ë“±ë¡ì¼: ${item.createdAtFormatted}</p>` : '';
                    
                    if (item.pattern) {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-emerald-700">${item.pattern}</p>
                                    <p class="text-sm text-slate-600">${item.examples[0].en}</p>
                                    ${timestampHtml}
                                </div>`;
                    } else {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-sky-700">${item.unit || 'ë‚˜ì˜ ë¬¸ì¥'}</p>
                                    <p class="text-sm text-slate-600">${item.en}</p>
                                    ${timestampHtml}
                                </div>`;
                    }
                }).join('');
            }

            searchInput.addEventListener('input', filterAndRender);
            filterAndRender(); // ì´ˆê¸° ë Œë”ë§
        }

        // --- ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ ---
        function resetReviewData() {
            // ë³µìŠµ ì§„í–‰ ìƒí™© ì´ˆê¸°í™” (í•™ìŠµ ê¸°ë¡ ì‚­ì œ)
            localStorage.removeItem('reviewProgress');
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('ë³µìŠµ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìŠµ ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì–´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        function resetLibraryData() {
            // ëª¨ë“  ë°ì´í„° ì‚­ì œ (ì²œì¼ë¬¸, íŒ¨í„´, ì‚¬ìš©ì ì¶”ê°€ ë°ì´í„°)
            masterData.cheonilmun.length = 0;
            masterData.patterns.length = 0;
            masterData.academic.length = 0;
            
            // ì›ë³¸ ë°ì´í„°ë¡œ ë³µì› 
            masterData.cheonilmun = [...originalData.cheonilmun];
            masterData.patterns = [...originalData.patterns];
            
            // ë°ì´í„° ë¡œë”© ìƒíƒœëŠ” ì—¬ì „íˆ ìœ íš¨
            dataLoaded = true;
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    </script>
</body>
</html>




<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트 영어 학습 도우미</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .dashboard-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .feedback-correct { background-color: #dcfce7; border-left-color: #22c55e; }
        .feedback-incorrect { background-color: #fee2e2; border-left-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="container mx-auto p-4 max-w-5xl">
        <header class="text-center my-8">
            <div class="flex justify-between items-center mb-6">
                <button onclick="window.location.href='index.html'" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-300">
                    ← 기본 퀴즈로
                </button>
                <div></div>
            </div>
            <h1 class="text-4xl font-bold text-indigo-700">스마트 영어 학습 도우미</h1>
            <p class="text-slate-600 mt-2">오늘도 목표를 향해 함께 나아가요!</p>
        </header>

        <main id="app-container">
            <!-- 학습 대시보드 화면 -->
            <div id="dashboard-screen">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">🧠</span> 오늘의 복습</h2>
                    <div id="review-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                        <h3 class="font-semibold text-lg text-indigo-800">자동 생성된 복습 퀴즈</h3>
                        <p class="text-slate-600 mt-1">과학적인 간격 반복으로 장기 기억을 강화하세요. 오늘 복습할 항목이 <span id="review-count" class="font-bold text-red-500"></span>개 있습니다.</p>
                    </div>
                </div>
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">📚</span> 새로운 학습</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div id="cheonilmun-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-sky-800">[Input] 천일문 구조 분석</h3>
                            <p class="text-slate-600 mt-1">문법 개념을 이해하고, 문장 구조를 분석하며 독해의 기본기를 다집니다.</p>
                        </div>
                        <div id="pattern-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-emerald-800">[Output] 생활영어 패턴 체화</h3>
                            <p class="text-slate-600 mt-1">핵심 회화 패턴을 응용 작문하며 말하기와 쓰기 순발력을 기릅니다.</p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">🔬</span> 나의 문장</h2>
                        <div id="academic-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-amber-800">논문/원서 문장 추가하기</h3>
                            <p class="text-slate-600 mt-1">실제 접하는 문장을 분석하고, 개인화된 복습 퀴즈로 만들어보세요.</p>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">🗂️</span> 전체 자료실</h2>
                        <div id="library-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-slate-800">학습 라이브러리 탐색</h3>
                            <p class="text-slate-600 mt-1">지금까지 학습한 모든 내용을 자유롭게 검색하고 복습할 수 있습니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 학습 모듈 화면 (동적 생성) -->
            <div id="module-screen" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 id="module-title" class="text-3xl font-bold"></h2>
                    <button id="back-to-dashboard-btn" class="btn btn-secondary">대시보드로</button>
                </div>
                <div id="module-content" class="bg-white p-6 rounded-lg shadow-lg min-h-[60vh]">
                    <!-- 각 모듈의 콘텐츠가 여기에 표시됩니다 -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 데이터베이스 (masterData) ---
        const masterData = {
            cheonilmun: [],
            patterns: [],
            academic: []
        };

        // --- 원본 학습 자료 (삭제 방지용) ---
        const originalData = {
            cheonilmun: [],
            patterns: []
        };

        // --- 앱 상태 관리 ---
        let sessionState = {
            queue: [],
            currentIndex: 0,
        };

        // --- 간격 복습 시스템 ---
        const SPACED_REPETITION_INTERVALS = [
            1,    // 1일 후
            3,    // 3일 후  
            7,    // 1주일 후
            14,   // 2주일 후
            30,   // 1개월 후
            90    // 3개월 후 (마스터 레벨)
        ];

        // 학습 진행 상황을 localStorage에서 로드
        function loadReviewProgress() {
            const saved = localStorage.getItem('reviewProgress');
            return saved ? JSON.parse(saved) : {};
        }

        // 학습 진행 상황을 localStorage에 저장
        function saveReviewProgress(progress) {
            localStorage.setItem('reviewProgress', JSON.stringify(progress));
        }

        // 항목의 고유 ID 생성
        function getItemId(item) {
            if (item.id) return String(item.id);
            if (item.type === 'pattern' && item.pattern) return `pattern_${item.pattern}`;
            if (item.type === 'academic') return item.id;
            return `item_${item.en ? item.en.substring(0, 50) : Math.random()}`;
        }

        // 다음 복습 날짜 계산
        function calculateNextReviewDate(currentLevel, isCorrect) {
            const now = new Date();
            let nextLevel = currentLevel;
            
            if (isCorrect) {
                nextLevel = Math.min(currentLevel + 1, SPACED_REPETITION_INTERVALS.length - 1);
            } else {
                // 틀렸으면 레벨을 뒤로 이동 (최소 0)
                nextLevel = Math.max(0, currentLevel - 1);
            }
            
            const daysToAdd = SPACED_REPETITION_INTERVALS[nextLevel];
            const nextDate = new Date(now.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            
            return {
                nextReviewDate: nextDate,
                reviewLevel: nextLevel
            };
        }

        // 오늘 복습할 항목 필터링
        function getItemsDueForReview() {
            const progress = loadReviewProgress();
            const today = new Date();
            today.setHours(23, 59, 59, 999); // 오늘 끝까지
            
            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            return allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                
                // 아직 학습하지 않은 항목은 복습 대상이 아님
                if (!itemProgress) {
                    return false;
                }
                
                // 마스터 레벨에 도달한 항목은 복습하지 않음
                if (itemProgress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1) {
                    return false;
                }
                
                // 다음 복습일이 오늘 또는 이전인 항목만 포함
                const nextReviewDate = new Date(itemProgress.nextReviewDate);
                return nextReviewDate <= today;
            });
        }

        // 학습 기록 업데이트
        function recordLearningProgress(item, isCorrect) {
            const progress = loadReviewProgress();
            const itemId = getItemId(item);
            const now = new Date();
            
            if (!progress[itemId]) {
                // 첫 학습
                progress[itemId] = {
                    studiedAt: now.toISOString(),
                    reviewLevel: 0,
                    correctCount: isCorrect ? 1 : 0,
                    totalAttempts: 1,
                    lastReviewResult: isCorrect
                };
            } else {
                // 복습
                progress[itemId].totalAttempts++;
                if (isCorrect) progress[itemId].correctCount++;
                progress[itemId].lastReviewResult = isCorrect;
            }
            
            // 다음 복습 일정 계산
            const nextReview = calculateNextReviewDate(progress[itemId].reviewLevel, isCorrect);
            progress[itemId].nextReviewDate = nextReview.nextReviewDate.toISOString();
            progress[itemId].reviewLevel = nextReview.reviewLevel;
            
            saveReviewProgress(progress);
            return progress[itemId];
        }

        // --- DOM 요소 ---
        const dashboardScreen = document.getElementById('dashboard-screen');
        const moduleScreen = document.getElementById('module-screen');
        const moduleTitle = document.getElementById('module-title');
        const moduleContent = document.getElementById('module-content');
        
        const reviewCard = document.getElementById('review-card');
        const cheonilmunCard = document.getElementById('cheonilmun-card');
        const patternCard = document.getElementById('pattern-card');
        const academicCard = document.getElementById('academic-card');
        const libraryCard = document.getElementById('library-card');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // --- 이벤트 리스너 ---
        reviewCard.addEventListener('click', () => showModule('review'));
        cheonilmunCard.addEventListener('click', () => showModule('cheonilmun'));
        patternCard.addEventListener('click', () => showModule('pattern'));
        academicCard.addEventListener('click', () => showModule('academic'));
        libraryCard.addEventListener('click', () => showModule('library'));
        backToDashboardBtn.addEventListener('click', showDashboard);
        
        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadOriginalData().then(() => {
                updateReviewCount();
            });
        });

        // --- 원본 데이터 로딩 함수들 ---
        async function loadOriginalData() {
            try {
                // 천일문 데이터 로드
                const cheonilmunResponse = await fetch('./data/cheonilmun_sample.json');
                if (cheonilmunResponse.ok) {
                    const cheonilmunData = await cheonilmunResponse.json();
                    originalData.cheonilmun = [...cheonilmunData];
                    masterData.cheonilmun = [...cheonilmunData];
                }

                // 생활영어 패턴 데이터 로드
                const patternsResponse = await fetch('./data/patterns_numbered.json');
                if (patternsResponse.ok) {
                    const patternsData = await patternsResponse.json();
                    originalData.patterns = [...patternsData];
                    masterData.patterns = [...patternsData];
                }
            } catch (error) {
                console.error('원본 데이터 로드 실패:', error);
                // 오류가 발생해도 앱이 계속 작동하도록 함
            }
        }

        function updateReviewCount() {
            const dueItems = getItemsDueForReview();
            const count = dueItems.length;
            document.getElementById('review-count').textContent = count;
        }

        // --- 화면 전환 로직 ---
        function showDashboard() {
            moduleScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            updateReviewCount();
        }

        function showModule(moduleType) {
            dashboardScreen.classList.add('hidden');
            moduleScreen.classList.remove('hidden');

            switch(moduleType) {
                case 'review':
                    moduleTitle.textContent = '🧠 오늘의 복습';
                    const dueItems = getItemsDueForReview();
                    sessionState.queue = [...dueItems].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    if (sessionState.queue.length === 0) {
                        moduleContent.innerHTML = `
                            <div class="text-center p-8">
                                <p class="text-slate-500 mb-4">오늘 복습할 내용이 없습니다. 새로운 학습을 시작해보세요!</p>
                                <p class="text-sm text-slate-400 mb-4">💡 팁: 천일문이나 패턴 학습을 완료하면 간격 복습에 자동으로 추가됩니다.</p>
                                <button id="reset-review-btn" class="btn btn-secondary">복습 데이터 초기화</button>
                            </div>`;
                        const resetBtn = document.getElementById('reset-review-btn');
                        if (resetBtn) {
                            resetBtn.addEventListener('click', () => {
                                if (confirm('복습 데이터를 모두 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                                    resetReviewData();
                                    showDashboard();
                                }
                            });
                        }
                    } else {
                        renderQuiz('review');
                    }
                    break;
                case 'cheonilmun':
                    moduleTitle.textContent = '🏗️ 천일문 구조 분석';
                    sessionState.queue = [...masterData.cheonilmun].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('cheonilmun');
                    break;
                case 'pattern':
                    moduleTitle.textContent = '🗣️ 생활영어 패턴 체화';
                    sessionState.queue = [...masterData.patterns].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('pattern');
                    break;
                case 'academic':
                    moduleTitle.textContent = '🔬 나의 문장 분석';
                    renderAcademicModule();
                    break;
                case 'library':
                    moduleTitle.textContent = '🗂️ 전체 자료실';
                    renderLibraryModule();
                    break;
            }
        }

        // --- 상세 해설 템플릿 ---
        function createAnalysisHTML(item) {
            if (!item) return '';
            const analysis = item.analysis || (item.examples && item.examples[0].analysis);
            if (!analysis) return '';

            const vocabHtml = Object.entries(analysis.vocab || {}).map(([word, meaning]) => 
                `<li class="mb-1"><strong class="font-semibold text-slate-800">${word}:</strong> ${meaning}</li>`
            ).join('');

            return `
                <div class="mt-4 p-4 border rounded-lg bg-slate-50 space-y-4">
                    <div>
                        <h4 class="font-bold text-indigo-700">📘 핵심 포인트</h4>
                        <p class="mt-1 text-slate-700">${analysis.point}</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-indigo-700">💡 상세 해설</h4>
                        <p class="mt-1 text-slate-700 leading-relaxed">${analysis.explanation}</p>
                    </div>
                    ${vocabHtml ? `<div>
                        <h4 class="font-bold text-indigo-700">📖 주요 어휘</h4>
                        <ul class="list-disc list-inside text-slate-700 mt-1">${vocabHtml}</ul>
                    </div>` : ''}
                </div>
            `;
        }

        // --- 퀴즈 렌더링 로직 ---
        function renderQuiz(quizType) {
            if (sessionState.queue.length === 0 || sessionState.currentIndex >= sessionState.queue.length) {
                const resetButtonHtml = quizType === 'review' ? 
                    `<div class="mt-4"><button id="reset-review-btn" class="btn btn-secondary">복습 데이터 초기화</button></div>` : '';
                moduleContent.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-slate-500">모든 학습을 완료했습니다!</p>
                        ${resetButtonHtml}
                    </div>`;
                
                if (quizType === 'review') {
                    const resetBtn = document.getElementById('reset-review-btn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            if (confirm('복습 데이터를 모두 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                                resetReviewData();
                                showDashboard();
                            }
                        });
                    }
                }
                return;
            }

            const item = sessionState.queue[sessionState.currentIndex];
            let header = '';
            let quizContent = '';

            switch(quizType) {
                case 'review':
                    header = `복습 퀴즈 (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createFillInBlankQuiz(item);
                    break;
                case 'cheonilmun':
                    header = `${item.chapter} - ${item.unit} (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createTranslationQuiz(item);
                    break;
                case 'pattern':
                    header = `패턴 응용 퀴즈 (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createCompositionQuiz(item);
                    break;
            }

            const resetButtonHtml = quizType === 'review' ? 
                `<button id="reset-review-quiz-btn" class="btn btn-secondary ml-2">데이터 초기화</button>` : '';
            
            moduleContent.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">${header}</h3>
                        ${resetButtonHtml}
                    </div>
                    <div id="quiz-content-area" class="mt-4">${quizContent}</div>
                    <div id="feedback-container" class="mt-4"></div>
                    <div id="quiz-nav" class="flex gap-4 mt-6">
                        <button id="check-answer-btn" class="btn btn-primary w-full">정답 확인</button>
                    </div>
                </div>
            `;
            
            document.getElementById('check-answer-btn').addEventListener('click', () => checkAnswer(quizType, item));
            
            if (quizType === 'review') {
                const resetQuizBtn = document.getElementById('reset-review-quiz-btn');
                if (resetQuizBtn) {
                    resetQuizBtn.addEventListener('click', () => {
                        if (confirm('복습 데이터를 모두 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                            resetReviewData();
                            showDashboard();
                        }
                    });
                }
            }
        }

        function createFillInBlankQuiz(item) {
            let koText, quizHtml, answer;
            if (item.type === 'pattern') {
                const example = item.examples[0];
                koText = example.ko;
                answer = item.pattern;
                const escapedPattern = item.pattern.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                quizHtml = example.en.replace(new RegExp(escapedPattern, 'i'), `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            } else {
                koText = item.ko;
                answer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                quizHtml = item.en.replace(answer, `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            }
            return `<div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-lg">${koText}</p>
                        <div class="mt-2 text-xl font-mono">${quizHtml}</div>
                    </div>`;
        }
        
        function createTranslationQuiz(item) {
            return `
                <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <p class="mt-1 text-indigo-700">${item.analysis.explanation}</p>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg">
                    <p class="text-lg font-semibold">${item.en}</p>
                </div>
                <div class="mt-6">
                    <h4 class="font-semibold text-lg mb-2">📝 퀴즈: 문장 번역하기</h4>
                    <textarea id="quiz-input" class="w-full h-24 p-3 border rounded-lg" placeholder="위 영어 문장을 우리말로 번역해보세요..."></textarea>
                </div>`;
        }

        function createCompositionQuiz(item) {
            return `
                <div class="bg-emerald-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-emerald-800">🗣️ 오늘의 패턴: <span class="font-bold">${item.pattern}</span></h4>
                    <p class="text-emerald-600">${item.pattern_ko}</p>
                </div>
                <div class="space-y-3 mb-6">
                    ${item.examples.map(ex => `<div class="bg-slate-100 p-3 rounded-md"><p>${ex.en}</p><p class="text-sm text-slate-500">${ex.ko}</p></div>`).join('')}
                </div>
                <div>
                    <h4 class="font-semibold text-lg mb-2">📝 퀴즈: 응용 작문하기</h4>
                    <p class="text-slate-600 mb-2">상황: ${item.examples[1] ? item.examples[1].ko : '자유롭게 작문해보세요.'}</p>
                    <input type="text" id="quiz-input" class="w-full p-2 border rounded-lg" placeholder="위 패턴을 사용하여 작문해보세요...">
                </div>`;
        }

        function checkAnswer(quizType, item) {
            const feedbackContainer = document.getElementById('feedback-container');
            const quizInput = document.getElementById('quiz-input');
            const userAnswer = quizInput ? quizInput.value.trim() : '';
            let feedbackHtml = '';
            let isCorrect = true; // Default for non-review modes

            switch(quizType) {
                case 'review':
                    const answer = item.type === 'pattern' ? item.pattern : (item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, ''));
                    isCorrect = userAnswer.toLowerCase() === answer.toLowerCase();
                    
                    // 학습 진행 상황 기록
                    const progress = recordLearningProgress(item, isCorrect);
                    
                    // 다음 복습 정보 생성
                    const nextReviewDate = new Date(progress.nextReviewDate);
                    const nextReviewText = nextReviewDate.toLocaleDateString('ko-KR');
                    const intervalText = progress.reviewLevel < SPACED_REPETITION_INTERVALS.length - 1 ? 
                        `${SPACED_REPETITION_INTERVALS[progress.reviewLevel]}일 후` : '마스터 완료';
                    
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                                      <p class="font-bold">${isCorrect ? '정답입니다! 🎉' : '아쉬워요!'}</p>
                                      <p><strong>정답:</strong> ${answer}</p>
                                      <div class="mt-3 p-3 bg-slate-50 rounded-lg text-sm">
                                          <p><strong>📊 복습 진행률:</strong> ${progress.correctCount}/${progress.totalAttempts} (${Math.round(progress.correctCount/progress.totalAttempts*100)}%)</p>
                                          <p><strong>📅 다음 복습:</strong> ${progress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1 ? '완료됨 🎊' : `${nextReviewText} (${intervalText})`}</p>
                                          <p><strong>🔄 복습 단계:</strong> ${progress.reviewLevel + 1}/${SPACED_REPETITION_INTERVALS.length}</p>
                                      </div>
                                  </div>`;
                    break;
                case 'cheonilmun':
                    // 천일문 학습 완료 시에도 학습 기록 저장
                    recordLearningProgress(item, true);
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">모범 번역</p>
                                      <p>${item.ko}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">✅ 이 문장이 복습 시스템에 추가되었습니다!</p>
                                      </div>
                                  </div>`;
                    break;
                case 'pattern':
                    // 패턴 학습 완료 시에도 학습 기록 저장
                    recordLearningProgress(item, true);
                    const exampleAnswer = item.examples[1] ? item.examples[1].en : "Great job applying the pattern!";
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">좋은 시도입니다!</p>
                                      <p><strong>모범 답안 예시:</strong> ${exampleAnswer}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">✅ 이 패턴이 복습 시스템에 추가되었습니다!</p>
                                      </div>
                                  </div>`;
                    break;
            }
            
            feedbackContainer.innerHTML = feedbackHtml + createAnalysisHTML(item);

            const quizNav = document.getElementById('quiz-nav');
            if (sessionState.currentIndex < sessionState.queue.length - 1) {
                quizNav.innerHTML = `<button id="next-quiz-btn" class="btn btn-primary w-full">다음 문제</button>`;
                document.getElementById('next-quiz-btn').addEventListener('click', () => {
                    sessionState.currentIndex++;
                    renderQuiz(quizType);
                });
            } else {
                const completionMessage = quizType === 'review' ? '복습 완료! 🎉' : '학습 완료';
                quizNav.innerHTML = `<button id="finish-quiz-btn" class="btn btn-secondary w-full">${completionMessage}</button>`;
                document.getElementById('finish-quiz-btn').addEventListener('click', () => {
                    // 복습 카운트 업데이트
                    updateReviewCount();
                    showDashboard();
                });
            }
        }

        function renderAcademicModule() {
            moduleContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">논문/원서 문장 입력</h3>
                <p class="mb-4 text-slate-600">분석하고 싶은 문장을 입력하면, 구조와 어휘를 분석하고 개인 복습 데이터에 추가해 드립니다.</p>
                <textarea id="academic-input" class="w-full h-32 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="여기에 영어 문장을 붙여넣으세요..."></textarea>
                <div id="analysis-output" class="mt-4"></div>
                <button id="analyze-btn" class="btn btn-secondary w-full py-2 rounded-lg mt-4">분석 및 저장하기</button>
            `;
            document.getElementById('analyze-btn').addEventListener('click', () => {
                const academicInput = document.getElementById('academic-input');
                if (!academicInput) return;
                const text = academicInput.value.trim();
                if (text) {
                    const now = new Date();
                    const newEntry = {
                        type: 'academic',
                        id: `academic_${Date.now()}`,
                        en: text,
                        ko: '(사용자 입력 문장)',
                        answer: text.split(' ').pop().replace(/[.,!?]/g, ''),
                        analysis: { point: '사용자 입력 문장', explanation: '이 문장은 개인 데이터베이스에 저장되어 주기적으로 복습 퀴즈에 출제됩니다.', vocab: {} },
                        createdAt: now.toISOString(),
                        createdAtFormatted: now.toLocaleDateString('ko-KR') + ' ' + now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                    };
                    masterData.academic.push(newEntry);
                    
                    // 자동으로 첫 복습 일정 설정 (1일 후)
                    recordLearningProgress(newEntry, true);
                    
                    document.getElementById('analysis-output').innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800">🔬 저장 완료</h4>
                            <p class="mt-2 text-green-700">문장이 개인 데이터베이스에 저장되었습니다.</p>
                            <p class="mt-1 text-green-600 text-sm">📅 내일부터 복습 퀴즈에 포함됩니다!</p>
                        </div>`;
                    academicInput.value = '';
                    
                    // 복습 카운트 업데이트
                    updateReviewCount();
                }
            });
        }

        function renderLibraryModule() {
            const libraryContent = document.createElement('div');
            libraryContent.id = 'library-content';
            libraryContent.className = 'max-h-[50vh] overflow-y-auto custom-scrollbar pr-2';
            
            moduleContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <input type="text" id="library-search-input" class="flex-1 p-3 border rounded-lg mr-4" placeholder="학습한 내용 검색하기 (예: 분사구문, was going to)...">
                    <button id="reset-library-btn" class="btn btn-secondary whitespace-nowrap">라이브러리 초기화</button>
                </div>
            `;
            moduleContent.appendChild(libraryContent);
            
            const searchInput = document.getElementById('library-search-input');
            const resetLibraryBtn = document.getElementById('reset-library-btn');
            
            if (resetLibraryBtn) {
                resetLibraryBtn.addEventListener('click', () => {
                    if (confirm('학습 라이브러리의 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                        resetLibraryData();
                        filterAndRender(); // Refresh the display
                        updateReviewCount(); // Update dashboard count
                    }
                });
            }

            function filterAndRender() {
                const searchTerm = searchInput.value.toLowerCase();
                const allData = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
                
                const filteredData = allData.filter(item => {
                    if (item.pattern) {
                        // Pattern data structure
                        const patternMatch = item.pattern.toLowerCase().includes(searchTerm);
                        const examplesMatch = item.examples && item.examples.some(ex => 
                            (ex.ko && ex.ko.toLowerCase().includes(searchTerm)) || 
                            (ex.en && ex.en.toLowerCase().includes(searchTerm))
                        );
                        return patternMatch || examplesMatch;
                    } else {
                        // Cheonilmun or Academic data structure
                        const koMatch = item.ko && item.ko.toLowerCase().includes(searchTerm);
                        const enMatch = item.en && item.en.toLowerCase().includes(searchTerm);
                        const analysisMatch = item.analysis && item.analysis.point && 
                            item.analysis.point.toLowerCase().includes(searchTerm);
                        return koMatch || enMatch || analysisMatch;
                    }
                });

                if (filteredData.length === 0) {
                    libraryContent.innerHTML = `<p class="text-center text-slate-500">검색 결과가 없습니다.</p>`;
                    return;
                }

                libraryContent.innerHTML = filteredData.map(item => {
                    const timestampHtml = item.createdAtFormatted ? 
                        `<p class="text-xs text-slate-400 mt-1">등록일: ${item.createdAtFormatted}</p>` : '';
                    
                    if (item.pattern) {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-emerald-700">${item.pattern}</p>
                                    <p class="text-sm text-slate-600">${item.examples[0].en}</p>
                                    ${timestampHtml}
                                </div>`;
                    } else {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-sky-700">${item.unit || '나의 문장'}</p>
                                    <p class="text-sm text-slate-600">${item.en}</p>
                                    ${timestampHtml}
                                </div>`;
                    }
                }).join('');
            }

            searchInput.addEventListener('input', filterAndRender);
            filterAndRender(); // 초기 렌더링
        }

        // --- 데이터 초기화 함수들 ---
        function resetReviewData() {
            // 복습 진행 상황 초기화 (학습 기록 삭제)
            localStorage.removeItem('reviewProgress');
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('복습 데이터가 초기화되었습니다. 학습 기록이 모두 삭제되어 처음부터 다시 시작할 수 있습니다.');
        }

        function resetLibraryData() {
            // 모든 데이터 삭제 (천일문, 패턴, 사용자 추가 데이터)
            masterData.cheonilmun.length = 0;
            masterData.patterns.length = 0;
            masterData.academic.length = 0;
            
            // 원본 데이터로 복원 
            masterData.cheonilmun = [...originalData.cheonilmun];
            masterData.patterns = [...originalData.patterns];
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('라이브러리 데이터가 초기화되었습니다.');
        }
    </script>
</body>
</html>




<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì˜ì–´ í•™ìŠµ ë„ìš°ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .dashboard-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .feedback-correct { background-color: #dcfce7; border-left-color: #22c55e; }
        .feedback-incorrect { background-color: #fee2e2; border-left-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="container mx-auto p-4 max-w-5xl">
        <header class="text-center my-8">
            <div class="flex justify-between items-center mb-6">
                <button onclick="window.location.href='index.html'" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition duration-300">
                    â† ê¸°ë³¸ í€´ì¦ˆë¡œ
                </button>
                <div></div>
            </div>
            <h1 class="text-4xl font-bold text-indigo-700">ìŠ¤ë§ˆíŠ¸ ì˜ì–´ í•™ìŠµ ë„ìš°ë¯¸</h1>
            <p class="text-slate-600 mt-2">ì˜¤ëŠ˜ë„ ëª©í‘œë¥¼ í–¥í•´ í•¨ê»˜ ë‚˜ì•„ê°€ìš”!</p>
        </header>

        <main id="app-container">
            <!-- í•™ìŠµ ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
            <div id="dashboard-screen">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">ğŸ§ </span> ì˜¤ëŠ˜ì˜ ë³µìŠµ</h2>
                    <div id="review-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                        <h3 class="font-semibold text-lg text-indigo-800">ìë™ ìƒì„±ëœ ë³µìŠµ í€´ì¦ˆ</h3>
                        <p class="text-slate-600 mt-1">ê³¼í•™ì ì¸ ê°„ê²© ë°˜ë³µìœ¼ë¡œ ì¥ê¸° ê¸°ì–µì„ ê°•í™”í•˜ì„¸ìš”. ì˜¤ëŠ˜ ë³µìŠµí•  í•­ëª©ì´ <span id="review-count" class="font-bold text-red-500"></span>ê°œ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">ğŸ“š</span> ìƒˆë¡œìš´ í•™ìŠµ</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div id="cheonilmun-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-sky-800">[Input] ì²œì¼ë¬¸ êµ¬ì¡° ë¶„ì„</h3>
                            <p class="text-slate-600 mt-1">ë¬¸ë²• ê°œë…ì„ ì´í•´í•˜ê³ , ë¬¸ì¥ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ë©° ë…í•´ì˜ ê¸°ë³¸ê¸°ë¥¼ ë‹¤ì§‘ë‹ˆë‹¤.</p>
                        </div>
                        <div id="pattern-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-emerald-800">[Output] ìƒí™œì˜ì–´ íŒ¨í„´ ì²´í™”</h3>
                            <p class="text-slate-600 mt-1">í•µì‹¬ íšŒí™” íŒ¨í„´ì„ ì‘ìš© ì‘ë¬¸í•˜ë©° ë§í•˜ê¸°ì™€ ì“°ê¸° ìˆœë°œë ¥ì„ ê¸°ë¦…ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">ğŸ”¬</span> ë‚˜ì˜ ë¬¸ì¥</h2>
                        <div id="academic-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-amber-800">ë…¼ë¬¸/ì›ì„œ ë¬¸ì¥ ì¶”ê°€í•˜ê¸°</h3>
                            <p class="text-slate-600 mt-1">ì‹¤ì œ ì ‘í•˜ëŠ” ë¬¸ì¥ì„ ë¶„ì„í•˜ê³ , ê°œì¸í™”ëœ ë³µìŠµ í€´ì¦ˆë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">ğŸ—‚ï¸</span> ì „ì²´ ìë£Œì‹¤</h2>
                        <div id="library-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-slate-800">í•™ìŠµ ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒìƒ‰</h3>
                            <p class="text-slate-600 mt-1">ì§€ê¸ˆê¹Œì§€ í•™ìŠµí•œ ëª¨ë“  ë‚´ìš©ì„ ììœ ë¡­ê²Œ ê²€ìƒ‰í•˜ê³  ë³µìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ìŠµ ëª¨ë“ˆ í™”ë©´ (ë™ì  ìƒì„±) -->
            <div id="module-screen" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 id="module-title" class="text-3xl font-bold"></h2>
                    <button id="back-to-dashboard-btn" class="btn btn-secondary">ëŒ€ì‹œë³´ë“œë¡œ</button>
                </div>
                <div id="module-content" class="bg-white p-6 rounded-lg shadow-lg min-h-[60vh]">
                    <!-- ê° ëª¨ë“ˆì˜ ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- ë°ì´í„°ë² ì´ìŠ¤ (masterData) ---
        const masterData = {
            cheonilmun: [],
            patterns: [],
            academic: []
        };

        // --- ì›ë³¸ í•™ìŠµ ìë£Œ (ì‚­ì œ ë°©ì§€ìš©) ---
        const originalData = {
            cheonilmun: [],
            patterns: []
        };

        // --- ì•± ìƒíƒœ ê´€ë¦¬ ---
        let sessionState = {
            queue: [],
            currentIndex: 0,
        };

        // --- ê°„ê²© ë³µìŠµ ì‹œìŠ¤í…œ ---
        const SPACED_REPETITION_INTERVALS = [
            1,    // 1ì¼ í›„
            3,    // 3ì¼ í›„  
            7,    // 1ì£¼ì¼ í›„
            14,   // 2ì£¼ì¼ í›„
            30,   // 1ê°œì›” í›„
            90    // 3ê°œì›” í›„ (ë§ˆìŠ¤í„° ë ˆë²¨)
        ];

        // í•™ìŠµ ì§„í–‰ ìƒí™©ì„ localStorageì—ì„œ ë¡œë“œ
        function loadReviewProgress() {
            const saved = localStorage.getItem('reviewProgress');
            return saved ? JSON.parse(saved) : {};
        }

        // í•™ìŠµ ì§„í–‰ ìƒí™©ì„ localStorageì— ì €ì¥
        function saveReviewProgress(progress) {
            localStorage.setItem('reviewProgress', JSON.stringify(progress));
        }

        // í•­ëª©ì˜ ê³ ìœ  ID ìƒì„±
        function getItemId(item) {
            if (item.id) return String(item.id);
            if (item.type === 'pattern' && item.pattern) return `pattern_${item.pattern}`;
            if (item.type === 'academic') return item.id;
            return `item_${item.en ? item.en.substring(0, 50) : Math.random()}`;
        }

        // ë‹¤ìŒ ë³µìŠµ ë‚ ì§œ ê³„ì‚°
        function calculateNextReviewDate(currentLevel, isCorrect) {
            const now = new Date();
            let nextLevel = currentLevel;
            
            if (isCorrect) {
                nextLevel = Math.min(currentLevel + 1, SPACED_REPETITION_INTERVALS.length - 1);
            } else {
                // í‹€ë ¸ìœ¼ë©´ ë ˆë²¨ì„ ë’¤ë¡œ ì´ë™ (ìµœì†Œ 0)
                nextLevel = Math.max(0, currentLevel - 1);
            }
            
            const daysToAdd = SPACED_REPETITION_INTERVALS[nextLevel];
            const nextDate = new Date(now.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            
            return {
                nextReviewDate: nextDate,
                reviewLevel: nextLevel
            };
        }

        // ì˜¤ëŠ˜ ë³µìŠµí•  í•­ëª© í•„í„°ë§
        function getItemsDueForReview() {
            const progress = loadReviewProgress();
            const today = new Date();
            today.setHours(23, 59, 59, 999); // ì˜¤ëŠ˜ ëê¹Œì§€
            
            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            return allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                
                // ì•„ì§ í•™ìŠµí•˜ì§€ ì•Šì€ í•­ëª©ì€ ë³µìŠµ ëŒ€ìƒì´ ì•„ë‹˜
                if (!itemProgress) {
                    return false;
                }
                
                // ë§ˆìŠ¤í„° ë ˆë²¨ì— ë„ë‹¬í•œ í•­ëª©ì€ ë³µìŠµí•˜ì§€ ì•ŠìŒ
                if (itemProgress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1) {
                    return false;
                }
                
                // ë‹¤ìŒ ë³µìŠµì¼ì´ ì˜¤ëŠ˜ ë˜ëŠ” ì´ì „ì¸ í•­ëª©ë§Œ í¬í•¨
                const nextReviewDate = new Date(itemProgress.nextReviewDate);
                return nextReviewDate <= today;
            });
        }

        // í•™ìŠµ ê¸°ë¡ ì—…ë°ì´íŠ¸
        function recordLearningProgress(item, isCorrect) {
            const progress = loadReviewProgress();
            const itemId = getItemId(item);
            const now = new Date();
            
            if (!progress[itemId]) {
                // ì²« í•™ìŠµ
                progress[itemId] = {
                    studiedAt: now.toISOString(),
                    reviewLevel: 0,
                    correctCount: isCorrect ? 1 : 0,
                    totalAttempts: 1,
                    lastReviewResult: isCorrect
                };
            } else {
                // ë³µìŠµ
                progress[itemId].totalAttempts++;
                if (isCorrect) progress[itemId].correctCount++;
                progress[itemId].lastReviewResult = isCorrect;
            }
            
            // ë‹¤ìŒ ë³µìŠµ ì¼ì • ê³„ì‚°
            const nextReview = calculateNextReviewDate(progress[itemId].reviewLevel, isCorrect);
            progress[itemId].nextReviewDate = nextReview.nextReviewDate.toISOString();
            progress[itemId].reviewLevel = nextReview.reviewLevel;
            
            saveReviewProgress(progress);
            return progress[itemId];
        }

        // --- DOM ìš”ì†Œ ---
        const dashboardScreen = document.getElementById('dashboard-screen');
        const moduleScreen = document.getElementById('module-screen');
        const moduleTitle = document.getElementById('module-title');
        const moduleContent = document.getElementById('module-content');
        
        const reviewCard = document.getElementById('review-card');
        const cheonilmunCard = document.getElementById('cheonilmun-card');
        const patternCard = document.getElementById('pattern-card');
        const academicCard = document.getElementById('academic-card');
        const libraryCard = document.getElementById('library-card');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        reviewCard.addEventListener('click', () => showModule('review'));
        cheonilmunCard.addEventListener('click', () => showModule('cheonilmun'));
        patternCard.addEventListener('click', () => showModule('pattern'));
        academicCard.addEventListener('click', () => showModule('academic'));
        libraryCard.addEventListener('click', () => showModule('library'));
        backToDashboardBtn.addEventListener('click', showDashboard);
        
        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            loadOriginalData().then(() => {
                updateReviewCount();
            });
        });

        // --- ì›ë³¸ ë°ì´í„° ë¡œë”© í•¨ìˆ˜ë“¤ ---
        async function loadOriginalData() {
            try {
                // ì²œì¼ë¬¸ ë°ì´í„° ë¡œë“œ
                const cheonilmunResponse = await fetch('./data/cheonilmun_sample.json');
                if (cheonilmunResponse.ok) {
                    const cheonilmunData = await cheonilmunResponse.json();
                    originalData.cheonilmun = [...cheonilmunData];
                    masterData.cheonilmun = [...cheonilmunData];
                }

                // ìƒí™œì˜ì–´ íŒ¨í„´ ë°ì´í„° ë¡œë“œ
                const patternsResponse = await fetch('./data/patterns_numbered.json');
                if (patternsResponse.ok) {
                    const patternsData = await patternsResponse.json();
                    originalData.patterns = [...patternsData];
                    masterData.patterns = [...patternsData];
                }
            } catch (error) {
                console.error('ì›ë³¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì•±ì´ ê³„ì† ì‘ë™í•˜ë„ë¡ í•¨
            }
        }

        function updateReviewCount() {
            const dueItems = getItemsDueForReview();
            const count = dueItems.length;
            document.getElementById('review-count').textContent = count;
        }

        // --- í™”ë©´ ì „í™˜ ë¡œì§ ---
        function showDashboard() {
            moduleScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            updateReviewCount();
        }

        function showModule(moduleType) {
            dashboardScreen.classList.add('hidden');
            moduleScreen.classList.remove('hidden');

            switch(moduleType) {
                case 'review':
                    moduleTitle.textContent = 'ğŸ§  ì˜¤ëŠ˜ì˜ ë³µìŠµ';
                    const dueItems = getItemsDueForReview();
                    sessionState.queue = [...dueItems].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    if (sessionState.queue.length === 0) {
                        moduleContent.innerHTML = `
                            <div class="text-center p-8">
                                <p class="text-slate-500 mb-4">ì˜¤ëŠ˜ ë³µìŠµí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í•™ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                                <p class="text-sm text-slate-400 mb-4">ğŸ’¡ íŒ: ì²œì¼ë¬¸ì´ë‚˜ íŒ¨í„´ í•™ìŠµì„ ì™„ë£Œí•˜ë©´ ê°„ê²© ë³µìŠµì— ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
                                <button id="reset-review-btn" class="btn btn-secondary">ë³µìŠµ ë°ì´í„° ì´ˆê¸°í™”</button>
                            </div>`;
                        const resetBtn = document.getElementById('reset-review-btn');
                        if (resetBtn) {
                            resetBtn.addEventListener('click', () => {
                                if (confirm('ë³µìŠµ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                                    resetReviewData();
                                    showDashboard();
                                }
                            });
                        }
                    } else {
                        renderQuiz('review');
                    }
                    break;
                case 'cheonilmun':
                    moduleTitle.textContent = 'ğŸ—ï¸ ì²œì¼ë¬¸ êµ¬ì¡° ë¶„ì„';
                    sessionState.queue = [...masterData.cheonilmun].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('cheonilmun');
                    break;
                case 'pattern':
                    moduleTitle.textContent = 'ğŸ—£ï¸ ìƒí™œì˜ì–´ íŒ¨í„´ ì²´í™”';
                    sessionState.queue = [...masterData.patterns].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('pattern');
                    break;
                case 'academic':
                    moduleTitle.textContent = 'ğŸ”¬ ë‚˜ì˜ ë¬¸ì¥ ë¶„ì„';
                    renderAcademicModule();
                    break;
                case 'library':
                    moduleTitle.textContent = 'ğŸ—‚ï¸ ì „ì²´ ìë£Œì‹¤';
                    renderLibraryModule();
                    break;
            }
        }

        // --- ìƒì„¸ í•´ì„¤ í…œí”Œë¦¿ ---
        function createAnalysisHTML(item) {
            if (!item) return '';
            const analysis = item.analysis || (item.examples && item.examples[0].analysis);
            if (!analysis) return '';

            const vocabHtml = Object.entries(analysis.vocab || {}).map(([word, meaning]) => 
                `<li class="mb-1"><strong class="font-semibold text-slate-800">${word}:</strong> ${meaning}</li>`
            ).join('');

            return `
                <div class="mt-4 p-4 border rounded-lg bg-slate-50 space-y-4">
                    <div>
                        <h4 class="font-bold text-indigo-700">ğŸ“˜ í•µì‹¬ í¬ì¸íŠ¸</h4>
                        <p class="mt-1 text-slate-700">${analysis.point}</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-indigo-700">ğŸ’¡ ìƒì„¸ í•´ì„¤</h4>
                        <p class="mt-1 text-slate-700 leading-relaxed">${analysis.explanation}</p>
                    </div>
                    ${vocabHtml ? `<div>
                        <h4 class="font-bold text-indigo-700">ğŸ“– ì£¼ìš” ì–´íœ˜</h4>
                        <ul class="list-disc list-inside text-slate-700 mt-1">${vocabHtml}</ul>
                    </div>` : ''}
                </div>
            `;
        }

        // --- í€´ì¦ˆ ë Œë”ë§ ë¡œì§ ---
        function renderQuiz(quizType) {
            if (sessionState.queue.length === 0 || sessionState.currentIndex >= sessionState.queue.length) {
                const resetButtonHtml = quizType === 'review' ? 
                    `<div class="mt-4"><button id="reset-review-btn" class="btn btn-secondary">ë³µìŠµ ë°ì´í„° ì´ˆê¸°í™”</button></div>` : '';
                moduleContent.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-slate-500">ëª¨ë“  í•™ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</p>
                        ${resetButtonHtml}
                    </div>`;
                
                if (quizType === 'review') {
                    const resetBtn = document.getElementById('reset-review-btn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            if (confirm('ë³µìŠµ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                                resetReviewData();
                                showDashboard();
                            }
                        });
                    }
                }
                return;
            }

            const item = sessionState.queue[sessionState.currentIndex];
            let header = '';
            let quizContent = '';

            switch(quizType) {
                case 'review':
                    header = `ë³µìŠµ í€´ì¦ˆ (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createFillInBlankQuiz(item);
                    break;
                case 'cheonilmun':
                    header = `${item.chapter} - ${item.unit} (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createTranslationQuiz(item);
                    break;
                case 'pattern':
                    header = `íŒ¨í„´ ì‘ìš© í€´ì¦ˆ (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createCompositionQuiz(item);
                    break;
            }

            const resetButtonHtml = quizType === 'review' ? 
                `<button id="reset-review-quiz-btn" class="btn btn-secondary ml-2">ë°ì´í„° ì´ˆê¸°í™”</button>` : '';
            
            moduleContent.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">${header}</h3>
                        ${resetButtonHtml}
                    </div>
                    <div id="quiz-content-area" class="mt-4">${quizContent}</div>
                    <div id="feedback-container" class="mt-4"></div>
                    <div id="quiz-nav" class="flex gap-4 mt-6">
                        <button id="check-answer-btn" class="btn btn-primary w-full">ì •ë‹µ í™•ì¸</button>
                    </div>
                </div>
            `;
            
            document.getElementById('check-answer-btn').addEventListener('click', () => checkAnswer(quizType, item));
            
            if (quizType === 'review') {
                const resetQuizBtn = document.getElementById('reset-review-quiz-btn');
                if (resetQuizBtn) {
                    resetQuizBtn.addEventListener('click', () => {
                        if (confirm('ë³µìŠµ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                            resetReviewData();
                            showDashboard();
                        }
                    });
                }
            }
        }

        function createFillInBlankQuiz(item) {
            let koText, quizHtml, answer;
            if (item.type === 'pattern') {
                const example = item.examples[0];
                koText = example.ko;
                answer = item.pattern;
                const escapedPattern = item.pattern.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                quizHtml = example.en.replace(new RegExp(escapedPattern, 'i'), `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            } else {
                koText = item.ko;
                answer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                quizHtml = item.en.replace(answer, `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            }
            return `<div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-lg">${koText}</p>
                        <div class="mt-2 text-xl font-mono">${quizHtml}</div>
                    </div>`;
        }
        
        function createTranslationQuiz(item) {
            return `
                <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <p class="mt-1 text-indigo-700">${item.analysis.explanation}</p>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg">
                    <p class="text-lg font-semibold">${item.en}</p>
                </div>
                <div class="mt-6">
                    <h4 class="font-semibold text-lg mb-2">ğŸ“ í€´ì¦ˆ: ë¬¸ì¥ ë²ˆì—­í•˜ê¸°</h4>
                    <textarea id="quiz-input" class="w-full h-24 p-3 border rounded-lg" placeholder="ìœ„ ì˜ì–´ ë¬¸ì¥ì„ ìš°ë¦¬ë§ë¡œ ë²ˆì—­í•´ë³´ì„¸ìš”..."></textarea>
                </div>`;
        }

        function createCompositionQuiz(item) {
            return `
                <div class="bg-emerald-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-emerald-800">ğŸ—£ï¸ ì˜¤ëŠ˜ì˜ íŒ¨í„´: <span class="font-bold">${item.pattern}</span></h4>
                    <p class="text-emerald-600">${item.pattern_ko}</p>
                </div>
                <div class="space-y-3 mb-6">
                    ${item.examples.map(ex => `<div class="bg-slate-100 p-3 rounded-md"><p>${ex.en}</p><p class="text-sm text-slate-500">${ex.ko}</p></div>`).join('')}
                </div>
                <div>
                    <h4 class="font-semibold text-lg mb-2">ğŸ“ í€´ì¦ˆ: ì‘ìš© ì‘ë¬¸í•˜ê¸°</h4>
                    <p class="text-slate-600 mb-2">ìƒí™©: ${item.examples[1] ? item.examples[1].ko : 'ììœ ë¡­ê²Œ ì‘ë¬¸í•´ë³´ì„¸ìš”.'}</p>
                    <input type="text" id="quiz-input" class="w-full p-2 border rounded-lg" placeholder="ìœ„ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ì‘ë¬¸í•´ë³´ì„¸ìš”...">
                </div>`;
        }

        function checkAnswer(quizType, item) {
            const feedbackContainer = document.getElementById('feedback-container');
            const quizInput = document.getElementById('quiz-input');
            const userAnswer = quizInput ? quizInput.value.trim() : '';
            let feedbackHtml = '';
            let isCorrect = true; // Default for non-review modes

            switch(quizType) {
                case 'review':
                    const answer = item.type === 'pattern' ? item.pattern : (item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, ''));
                    isCorrect = userAnswer.toLowerCase() === answer.toLowerCase();
                    
                    // í•™ìŠµ ì§„í–‰ ìƒí™© ê¸°ë¡
                    const progress = recordLearningProgress(item, isCorrect);
                    
                    // ë‹¤ìŒ ë³µìŠµ ì •ë³´ ìƒì„±
                    const nextReviewDate = new Date(progress.nextReviewDate);
                    const nextReviewText = nextReviewDate.toLocaleDateString('ko-KR');
                    const intervalText = progress.reviewLevel < SPACED_REPETITION_INTERVALS.length - 1 ? 
                        `${SPACED_REPETITION_INTERVALS[progress.reviewLevel]}ì¼ í›„` : 'ë§ˆìŠ¤í„° ì™„ë£Œ';
                    
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                                      <p class="font-bold">${isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰' : 'ì•„ì‰¬ì›Œìš”!'}</p>
                                      <p><strong>ì •ë‹µ:</strong> ${answer}</p>
                                      <div class="mt-3 p-3 bg-slate-50 rounded-lg text-sm">
                                          <p><strong>ğŸ“Š ë³µìŠµ ì§„í–‰ë¥ :</strong> ${progress.correctCount}/${progress.totalAttempts} (${Math.round(progress.correctCount/progress.totalAttempts*100)}%)</p>
                                          <p><strong>ğŸ“… ë‹¤ìŒ ë³µìŠµ:</strong> ${progress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1 ? 'ì™„ë£Œë¨ ğŸŠ' : `${nextReviewText} (${intervalText})`}</p>
                                          <p><strong>ğŸ”„ ë³µìŠµ ë‹¨ê³„:</strong> ${progress.reviewLevel + 1}/${SPACED_REPETITION_INTERVALS.length}</p>
                                      </div>
                                  </div>`;
                    break;
                case 'cheonilmun':
                    // ì²œì¼ë¬¸ í•™ìŠµ ì™„ë£Œ ì‹œì—ë„ í•™ìŠµ ê¸°ë¡ ì €ì¥
                    recordLearningProgress(item, true);
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">ëª¨ë²” ë²ˆì—­</p>
                                      <p>${item.ko}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">âœ… ì´ ë¬¸ì¥ì´ ë³µìŠµ ì‹œìŠ¤í…œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                                      </div>
                                  </div>`;
                    break;
                case 'pattern':
                    // íŒ¨í„´ í•™ìŠµ ì™„ë£Œ ì‹œì—ë„ í•™ìŠµ ê¸°ë¡ ì €ì¥
                    recordLearningProgress(item, true);
                    const exampleAnswer = item.examples[1] ? item.examples[1].en : "Great job applying the pattern!";
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">ì¢‹ì€ ì‹œë„ì…ë‹ˆë‹¤!</p>
                                      <p><strong>ëª¨ë²” ë‹µì•ˆ ì˜ˆì‹œ:</strong> ${exampleAnswer}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">âœ… ì´ íŒ¨í„´ì´ ë³µìŠµ ì‹œìŠ¤í…œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                                      </div>
                                  </div>`;
                    break;
            }
            
            feedbackContainer.innerHTML = feedbackHtml + createAnalysisHTML(item);

            const quizNav = document.getElementById('quiz-nav');
            if (sessionState.currentIndex < sessionState.queue.length - 1) {
                quizNav.innerHTML = `<button id="next-quiz-btn" class="btn btn-primary w-full">ë‹¤ìŒ ë¬¸ì œ</button>`;
                document.getElementById('next-quiz-btn').addEventListener('click', () => {
                    sessionState.currentIndex++;
                    renderQuiz(quizType);
                });
            } else {
                const completionMessage = quizType === 'review' ? 'ë³µìŠµ ì™„ë£Œ! ğŸ‰' : 'í•™ìŠµ ì™„ë£Œ';
                quizNav.innerHTML = `<button id="finish-quiz-btn" class="btn btn-secondary w-full">${completionMessage}</button>`;
                document.getElementById('finish-quiz-btn').addEventListener('click', () => {
                    // ë³µìŠµ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    updateReviewCount();
                    showDashboard();
                });
            }
        }

        function renderAcademicModule() {
            moduleContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">ë…¼ë¬¸/ì›ì„œ ë¬¸ì¥ ì…ë ¥</h3>
                <p class="mb-4 text-slate-600">ë¶„ì„í•˜ê³  ì‹¶ì€ ë¬¸ì¥ì„ ì…ë ¥í•˜ë©´, êµ¬ì¡°ì™€ ì–´íœ˜ë¥¼ ë¶„ì„í•˜ê³  ê°œì¸ ë³µìŠµ ë°ì´í„°ì— ì¶”ê°€í•´ ë“œë¦½ë‹ˆë‹¤.</p>
                <textarea id="academic-input" class="w-full h-32 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="ì—¬ê¸°ì— ì˜ì–´ ë¬¸ì¥ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                <div id="analysis-output" class="mt-4"></div>
                <button id="analyze-btn" class="btn btn-secondary w-full py-2 rounded-lg mt-4">ë¶„ì„ ë° ì €ì¥í•˜ê¸°</button>
            `;
            document.getElementById('analyze-btn').addEventListener('click', () => {
                const academicInput = document.getElementById('academic-input');
                if (!academicInput) return;
                const text = academicInput.value.trim();
                if (text) {
                    const now = new Date();
                    const newEntry = {
                        type: 'academic',
                        id: `academic_${Date.now()}`,
                        en: text,
                        ko: '(ì‚¬ìš©ì ì…ë ¥ ë¬¸ì¥)',
                        answer: text.split(' ').pop().replace(/[.,!?]/g, ''),
                        analysis: { point: 'ì‚¬ìš©ì ì…ë ¥ ë¬¸ì¥', explanation: 'ì´ ë¬¸ì¥ì€ ê°œì¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì–´ ì£¼ê¸°ì ìœ¼ë¡œ ë³µìŠµ í€´ì¦ˆì— ì¶œì œë©ë‹ˆë‹¤.', vocab: {} },
                        createdAt: now.toISOString(),
                        createdAtFormatted: now.toLocaleDateString('ko-KR') + ' ' + now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                    };
                    masterData.academic.push(newEntry);
                    
                    // ìë™ìœ¼ë¡œ ì²« ë³µìŠµ ì¼ì • ì„¤ì • (1ì¼ í›„)
                    recordLearningProgress(newEntry, true);
                    
                    document.getElementById('analysis-output').innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800">ğŸ”¬ ì €ì¥ ì™„ë£Œ</h4>
                            <p class="mt-2 text-green-700">ë¬¸ì¥ì´ ê°œì¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            <p class="mt-1 text-green-600 text-sm">ğŸ“… ë‚´ì¼ë¶€í„° ë³µìŠµ í€´ì¦ˆì— í¬í•¨ë©ë‹ˆë‹¤!</p>
                        </div>`;
                    academicInput.value = '';
                    
                    // ë³µìŠµ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    updateReviewCount();
                }
            });
        }

        function renderLibraryModule() {
            const libraryContent = document.createElement('div');
            libraryContent.id = 'library-content';
            libraryContent.className = 'max-h-[50vh] overflow-y-auto custom-scrollbar pr-2';
            
            moduleContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <input type="text" id="library-search-input" class="flex-1 p-3 border rounded-lg mr-4" placeholder="í•™ìŠµí•œ ë‚´ìš© ê²€ìƒ‰í•˜ê¸° (ì˜ˆ: ë¶„ì‚¬êµ¬ë¬¸, was going to)...">
                    <button id="reset-library-btn" class="btn btn-secondary whitespace-nowrap">ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™”</button>
                </div>
            `;
            moduleContent.appendChild(libraryContent);
            
            const searchInput = document.getElementById('library-search-input');
            const resetLibraryBtn = document.getElementById('reset-library-btn');
            
            if (resetLibraryBtn) {
                resetLibraryBtn.addEventListener('click', () => {
                    if (confirm('í•™ìŠµ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                        resetLibraryData();
                        filterAndRender(); // Refresh the display
                        updateReviewCount(); // Update dashboard count
                    }
                });
            }

            function filterAndRender() {
                const searchTerm = searchInput.value.toLowerCase();
                const allData = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
                
                const filteredData = allData.filter(item => {
                    if (item.pattern) {
                        // Pattern data structure
                        const patternMatch = item.pattern.toLowerCase().includes(searchTerm);
                        const examplesMatch = item.examples && item.examples.some(ex => 
                            (ex.ko && ex.ko.toLowerCase().includes(searchTerm)) || 
                            (ex.en && ex.en.toLowerCase().includes(searchTerm))
                        );
                        return patternMatch || examplesMatch;
                    } else {
                        // Cheonilmun or Academic data structure
                        const koMatch = item.ko && item.ko.toLowerCase().includes(searchTerm);
                        const enMatch = item.en && item.en.toLowerCase().includes(searchTerm);
                        const analysisMatch = item.analysis && item.analysis.point && 
                            item.analysis.point.toLowerCase().includes(searchTerm);
                        return koMatch || enMatch || analysisMatch;
                    }
                });

                if (filteredData.length === 0) {
                    libraryContent.innerHTML = `<p class="text-center text-slate-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                libraryContent.innerHTML = filteredData.map(item => {
                    const timestampHtml = item.createdAtFormatted ? 
                        `<p class="text-xs text-slate-400 mt-1">ë“±ë¡ì¼: ${item.createdAtFormatted}</p>` : '';
                    
                    if (item.pattern) {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-emerald-700">${item.pattern}</p>
                                    <p class="text-sm text-slate-600">${item.examples[0].en}</p>
                                    ${timestampHtml}
                                </div>`;
                    } else {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-sky-700">${item.unit || 'ë‚˜ì˜ ë¬¸ì¥'}</p>
                                    <p class="text-sm text-slate-600">${item.en}</p>
                                    ${timestampHtml}
                                </div>`;
                    }
                }).join('');
            }

            searchInput.addEventListener('input', filterAndRender);
            filterAndRender(); // ì´ˆê¸° ë Œë”ë§
        }

        // --- ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ ---
        function resetReviewData() {
            // ë³µìŠµ ì§„í–‰ ìƒí™© ì´ˆê¸°í™” (í•™ìŠµ ê¸°ë¡ ì‚­ì œ)
            localStorage.removeItem('reviewProgress');
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('ë³µìŠµ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìŠµ ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì–´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        function resetLibraryData() {
            // ëª¨ë“  ë°ì´í„° ì‚­ì œ (ì²œì¼ë¬¸, íŒ¨í„´, ì‚¬ìš©ì ì¶”ê°€ ë°ì´í„°)
            masterData.cheonilmun.length = 0;
            masterData.patterns.length = 0;
            masterData.academic.length = 0;
            
            // ì›ë³¸ ë°ì´í„°ë¡œ ë³µì› 
            masterData.cheonilmun = [...originalData.cheonilmun];
            masterData.patterns = [...originalData.patterns];
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    </script>
</body>
</html>




<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트 영어 학습 도우미</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        button { min-height: 44px !important; min-width: 44px; padding: 0.5rem 1rem; }
        .dashboard-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; min-height: 44px; min-width: 44px; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .feedback-correct { background-color: #dcfce7; border-left-color: #22c55e; }
        .feedback-incorrect { background-color: #fee2e2; border-left-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="container mx-auto p-4 max-w-5xl">
        <header class="text-center my-8">
            <div class="flex justify-between items-center mb-6">
                <button onclick="window.location.href='index.html'" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg text-sm transition duration-300" style="min-height: 44px;">
                    ← 기본 퀴즈로
                </button>
                <div></div>
            </div>
            <h1 class="text-4xl font-bold text-indigo-700">스마트 영어 학습 도우미</h1>
            <p class="text-slate-600 mt-2">오늘도 목표를 향해 함께 나아가요!</p>
        </header>

        <main id="app-container">
            <!-- 학습 대시보드 화면 -->
            <div id="dashboard-screen">
                <!-- Plan Mode: Today's Plan -->
                <div class="mb-8 border-2 border-indigo-200 bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-6">
                    <h2 class="text-3xl font-bold mb-4 flex items-center text-indigo-700">
                        <span class="text-4xl mr-3">📅</span> 오늘의 계획 (Plan 모드)
                    </h2>
                    <div id="daily-plan-summary" class="mb-4">
                        <!-- Daily plan summary will be inserted here -->
                    </div>
                    <div class="flex gap-4 mb-4">
                        <button id="start-daily-plan-btn" class="btn btn-primary text-lg px-6 py-3">
                            📚 오늘 학습 시작
                        </button>
                        <button id="plan-settings-btn" class="btn btn-secondary">
                            ⚙️ 계획 설정
                        </button>
                    </div>
                    
                    <!-- Review Timeline Widget -->
                    <div class="mt-6 border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-indigo-700">📋 복습 타임라인</h3>
                            <div class="flex gap-2 text-sm">
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded">복습 <span id="review-now-count">0</span></span>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">예정 <span id="upcoming-count">0</span></span>
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded">신규 <span id="new-items-count">0</span></span>
                            </div>
                        </div>
                        <div id="timeline-container" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar bg-white rounded-lg p-3 border border-indigo-200">
                            <!-- Timeline items will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Drill Mode: Free Study -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-slate-700">
                        <span class="text-3xl mr-3">🎯</span> 자유 학습 (Drill 모드)
                    </h2>
                    <div class="text-sm text-slate-500 mb-4">
                        원하는 내용을 자유롭게 탐색하며 학습하세요. 기본적으로 루틴에 영향을 주지 않습니다.
                    </div>
                </div>
                
                <!-- Legacy Review Card (now part of Drill mode) -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-3 flex items-center"><span class="text-2xl mr-2">🧠</span> 복습 연습</h3>
                    <div id="review-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                        <h3 class="font-semibold text-lg text-indigo-800">간격 복습 연습</h3>
                        <p class="text-slate-600 mt-1">학습한 내용을 자유롭게 복습해보세요. 현재 복습 가능한 항목이 <span id="review-count" class="font-bold text-indigo-500"></span>개 있습니다.</p>
                    </div>
                </div>
                <div class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">📚</span> 새로운 학습</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div id="cheonilmun-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-sky-800">[Input] 천일문 구조 분석</h3>
                            <p class="text-slate-600 mt-1">문법 개념을 이해하고, 문장 구조를 분석하며 독해의 기본기를 다집니다.</p>
                        </div>
                        <div id="pattern-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-emerald-800">[Output] 생활영어 패턴 체화</h3>
                            <p class="text-slate-600 mt-1">핵심 회화 패턴을 응용 작문하며 말하기와 쓰기 순발력을 기릅니다.</p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">🔬</span> 나의 문장</h2>
                        <div id="academic-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-amber-800">논문/원서 문장 추가하기</h3>
                            <p class="text-slate-600 mt-1">실제 접하는 문장을 분석하고, 개인화된 복습 퀴즈로 만들어보세요.</p>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl mr-3">🗂️</span> 전체 자료실</h2>
                        <div id="library-card" class="dashboard-card bg-white p-6 rounded-lg shadow-md cursor-pointer">
                            <h3 class="font-semibold text-lg text-slate-800">학습 라이브러리 탐색</h3>
                            <p class="text-slate-600 mt-1">지금까지 학습한 모든 내용을 자유롭게 검색하고 복습할 수 있습니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 학습 모듈 화면 (동적 생성) -->
            <div id="module-screen" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 id="module-title" class="text-3xl font-bold"></h2>
                    <button id="back-to-dashboard-btn" class="btn btn-secondary">대시보드로</button>
                </div>
                <div id="module-content" class="bg-white p-6 rounded-lg shadow-lg min-h-[60vh]">
                    <!-- 각 모듈의 콘텐츠가 여기에 표시됩니다 -->
                </div>
            </div>
        </main>
    </div>

    <!-- Plan Settings Modal -->
    <div id="plan-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">📋 오늘의 계획 설정</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        일일 복습 목표 (개)
                    </label>
                    <input type="number" id="daily-review-cap" min="5" max="50" value="10" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        일일 신규 학습 목표 (개)
                    </label>
                    <input type="number" id="daily-new-limit" min="2" max="20" value="5" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2">
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="drill-affects-routine" class="mr-2">
                        <span class="text-sm">드릴 학습도 신규 학습으로 등록</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="save-plan-settings" class="btn btn-primary flex-1">저장</button>
                <button id="cancel-plan-settings" class="btn btn-secondary flex-1">취소</button>
            </div>
        </div>
    </div>

    <script>
        // --- 데이터베이스 (masterData) ---
        const masterData = {
            cheonilmun: [],
            patterns: [],
            academic: []
        };

        // --- 원본 학습 자료 (삭제 방지용) ---
        const originalData = {
            cheonilmun: [],
            patterns: []
        };

        // --- 앱 상태 관리 ---
        let sessionState = {
            queue: [],
            currentIndex: 0,
        };
        
        // 데이터 로딩 상태 관리
        let dataLoaded = false;

        // --- 간격 복습 시스템 ---
        const SPACED_REPETITION_INTERVALS = [
            1,    // 1일 후
            3,    // 3일 후  
            7,    // 1주일 후
            14,   // 2주일 후
            30,   // 1개월 후
            60,   // 2개월 후
            120   // 4개월 후
        ];

        // --- Gemini API Integration ---
        // API key should be configured securely - using fallback mode for security
        const GEMINI_API_KEY = null; // Removed for security - implement server-side proxy
        
        async function callGemini(prompt, isJson = true) {
            // Security check - API key removed for client-side security
            if (!GEMINI_API_KEY) {
                console.warn("Gemini API key not configured - using fallback mode");
                return null;
            }
            
            const generationConfig = isJson ? { 
                "responseMimeType": "application/json", 
                "temperature": 0.6 
            } : { 
                "temperature": 0.4 
            };
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }], 
                generationConfig 
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (responseText) {
                    return isJson ? JSON.parse(responseText) : responseText;
                } else { 
                    throw new Error("Invalid response structure from API"); 
                }
            } catch (error) { 
                console.error("Gemini API call failed:", error); 
                return null; 
            }
        }

        async function generatePatternTaskWithGemini(pattern, patternKo) {
            const prompt = `You are an English learning assistant for Korean students. For the pattern "${pattern}" (${patternKo}), create a flexible learning task. 

IMPORTANT: You must return a valid JSON object with ALL required fields. Do not include any markdown formatting or extra text.

Return exactly this JSON structure:
{
  "task_type": "creation",
  "instruction": "Korean instruction explaining what to do",
  "example_input": "Example scenario or context (optional, can be empty string)",
  "sample_answer": "Good example sentence using the pattern",
  "evaluation_criteria": "Korean criteria for good answers",
  "hints": ["Korean hint 1", "Korean hint 2", "Korean hint 3"]
}

Requirements:
- instruction: Must be clear Korean instructions (required)
- example_input: A specific situation or context (can be empty string if not needed)
- sample_answer: Must demonstrate correct usage of "${pattern}"
- hints: Exactly 3 helpful tips in Korean
- Make the task engaging and practical

Example for "${pattern}": Focus on real-life situations where this pattern is commonly used.`;

            return await callGemini(prompt);
        }

        async function evaluatePatternAnswerWithGemini(pattern, patternKo, userAnswer, taskType) {
            const prompt = `You are evaluating a Korean student's use of the English pattern "${pattern}" (${patternKo}). 

Student's answer: "${userAnswer}"
Task type: ${taskType}

Provide constructive feedback with detailed comparison analysis. Return exactly this JSON structure:
{
  "is_correct": true,
  "feedback": "Korean encouraging feedback",
  "suggestions": ["Korean improvement tip 1", "Korean improvement tip 2"],
  "score": 4,
  "corrected_version": "Improved version if needed",
  "detailed_comparison": {
    "grammar_analysis": "Korean explanation of grammar differences",
    "tone_analysis": "Korean explanation of tone/nuance differences", 
    "usage_analysis": "Korean explanation of usage appropriateness"
  }
}

Requirements:
- is_correct: boolean indicating proper pattern usage
- feedback: Encouraging feedback in Korean (required)
- suggestions: Array of 1-2 specific improvements in Korean
- score: Number 1-5 indicating quality (required)
- corrected_version: Better version if applicable (empty string if not needed)
- detailed_comparison: Must include grammar, tone, and usage analysis in Korean

Be encouraging but provide specific detailed analysis comparing the student's answer with optimal usage. Focus on explaining WHY differences matter for natural English communication.`;

            return await callGemini(prompt);
        }

        // Handle pattern items in review mode with AI evaluation
        async function handlePatternReviewAnswer(item, userAnswer, alreadyProcessed) {
            const itemId = String(getItemId(item));
            
            // Show loading feedback first
            let feedbackHtml = `
                <div class="p-4 border-l-4 rounded-md feedback-correct">
                    <div class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="font-bold">AI가 패턴 사용을 평가하고 있습니다...</p>
                    </div>
                </div>
            `;
            
            document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
            
            try {
                // Evaluate with Gemini AI
                const evaluation = await evaluatePatternAnswerWithGemini(item.pattern, item.pattern_ko, userAnswer, 'review');
                
                let grade = 3; // Default: good
                let isCorrect = true;
                let result = null;
                
                if (evaluation && typeof evaluation === 'object') {
                    // Use AI evaluation to determine correctness and grade
                    isCorrect = evaluation.is_correct || false;
                    
                    // Convert AI score (1-5) to SM-2 grade (0-4)
                    const aiScore = evaluation.score || 3;
                    if (!userAnswer || userAnswer.trim() === '') {
                        grade = 0; // No answer
                        isCorrect = false;
                    } else if (isCorrect && aiScore >= 4) {
                        grade = 4; // Easy/correct
                    } else if (isCorrect && aiScore >= 3) {
                        grade = 3; // Good
                    } else if (aiScore >= 2) {
                        grade = 2; // Hard but acceptable
                    } else {
                        grade = 1; // Wrong
                        isCorrect = false;
                    }
                } else {
                    // Fallback: assume they tried
                    grade = 3;
                    isCorrect = true;
                }
                
                // Update SM-2 schedule only if not already processed
                if (!alreadyProcessed) {
                    result = calculateNextReview(item, grade);
                    
                    // Remove from today queue if this was a first exposure
                    if (isTodayQueueItem(itemId)) {
                        removeFromTodayQueue(itemId);
                    }
                    
                    // Record result in plan session
                    planSession.results[planSession.phase].items.push({
                        ...item,
                        grade,
                        isCorrect,
                        userAnswer
                    });
                    
                    if (isCorrect) {
                        planSession.results[planSession.phase].correct++;
                    }
                } else {
                    // For already processed items, get current progress for display
                    const progress = loadPlanProgress();
                    const currentProgress = progress[itemId];
                    if (currentProgress) {
                        result = {
                            ...currentProgress,
                            intervalDays: Math.round((currentProgress.next - currentProgress.last) / (24 * 60 * 60 * 1000))
                        };
                    }
                    console.log('Item already processed in this session, not updating review schedule');
                }
                
                // Show AI-powered feedback
                if (evaluation && typeof evaluation === 'object') {
                    const nextDate = result ? new Date(result.next).toLocaleDateString('ko-KR') : '계산 중';
                    
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                            <p class="font-bold">${evaluation.is_correct ? '훌륭합니다! 🎉' : '좋은 시도입니다! 💪'}</p>
                            <div class="mt-3 space-y-3">
                                <div class="bg-white p-3 rounded-lg">
                                    <p class="font-medium text-gray-800">AI 피드백:</p>
                                    <p class="text-gray-700">${evaluation.feedback || '좋은 시도였습니다!'}</p>
                                </div>
                                
                                ${evaluation.corrected_version && evaluation.corrected_version.trim() ? `
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <p class="font-medium text-blue-800">개선된 답안:</p>
                                        <p class="text-blue-700">${evaluation.corrected_version}</p>
                                    </div>
                                ` : ''}
                                
                                ${evaluation.suggestions && Array.isArray(evaluation.suggestions) && evaluation.suggestions.length > 0 ? `
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <p class="font-medium text-yellow-800">개선 제안:</p>
                                        <ul class="text-yellow-700 list-disc list-inside space-y-1">
                                            ${evaluation.suggestions.filter(s => s && typeof s === 'string').map(suggestion => `<li>${suggestion}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <div class="mt-2 text-sm text-slate-600">
                                    <p>📊 AI 평가 점수: ${evaluation.score || 3}/5</p>
                                    <p>다음 복습: ${nextDate}${result ? ` (${result.intervalDays}일 후)` : ''}</p>
                                    ${result ? `<p>EF: ${result.ef.toFixed(1)}, 단계: ${result.stage + 1}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Enhanced fallback feedback
                    const nextDate = result ? new Date(result.next).toLocaleDateString('ko-KR') : '계산 중';
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md feedback-correct">
                            <p class="font-bold">패턴 복습 완료! ✍️</p>
                            <div class="mt-3 space-y-3">
                                <div class="bg-white p-3 rounded-lg">
                                    <p class="font-medium text-gray-800">작성하신 답변:</p>
                                    <p class="text-gray-700">"${userAnswer}"</p>
                                </div>
                                
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <p class="font-medium text-blue-800">복습한 패턴:</p>
                                    <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                                </div>
                                
                                <div class="mt-2 text-sm text-slate-600">
                                    <p>다음 복습: ${nextDate}${result ? ` (${result.intervalDays}일 후)` : ''}</p>
                                    ${result ? `<p>EF: ${result.ef.toFixed(1)}, 단계: ${result.stage + 1}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                
                // Add next button
                const nextButton = `<button id="next-plan-btn" class="btn btn-primary">다음 →</button>`;
                document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                
                document.getElementById('next-plan-btn').addEventListener('click', () => {
                    planSession.currentIndex++;
                    renderQuiz('plan');
                });
                
            } catch (error) {
                console.error('Pattern evaluation failed:', error);
                
                // Fallback with basic processing
                let grade = 3; // Default: good
                let isCorrect = true;
                let result = null;
                
                // Update SM-2 schedule only if not already processed
                if (!alreadyProcessed) {
                    result = calculateNextReview(item, grade);
                    
                    // Remove from today queue if this was a first exposure
                    if (isTodayQueueItem(itemId)) {
                        removeFromTodayQueue(itemId);
                    }
                    
                    // Record result in plan session
                    planSession.results[planSession.phase].items.push({
                        ...item,
                        grade,
                        isCorrect,
                        userAnswer
                    });
                    
                    if (isCorrect) {
                        planSession.results[planSession.phase].correct++;
                    }
                }
                
                // Show fallback feedback
                const nextDate = result ? new Date(result.next).toLocaleDateString('ko-KR') : '계산 중';
                feedbackHtml = `
                    <div class="p-4 border-l-4 rounded-md feedback-correct">
                        <p class="font-bold">패턴 복습 완료! ✍️</p>
                        <div class="mt-3 space-y-3">
                            <div class="bg-white p-3 rounded-lg">
                                <p class="font-medium text-gray-800">작성하신 답변:</p>
                                <p class="text-gray-700">"${userAnswer}"</p>
                            </div>
                            
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <p class="font-medium text-blue-800">복습한 패턴:</p>
                                <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                            </div>
                            
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <p class="font-medium text-yellow-800">💡 참고:</p>
                                <p class="text-yellow-700 text-sm">AI 평가가 일시적으로 사용할 수 없어 기본 처리되었습니다.</p>
                            </div>
                            
                            <div class="mt-2 text-sm text-slate-600">
                                <p>다음 복습: ${nextDate}${result ? ` (${result.intervalDays}일 후)` : ''}</p>
                                ${result ? `<p>EF: ${result.ef.toFixed(1)}, 단계: ${result.stage + 1}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                
                // Add next button
                const nextButton = `<button id="next-plan-btn" class="btn btn-primary">다음 →</button>`;
                document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                
                document.getElementById('next-plan-btn').addEventListener('click', () => {
                    planSession.currentIndex++;
                    renderQuiz('plan');
                });
            }
        }

        // --- Plan Mode: New interval progression system ---
        const BASE_INTERVALS_HOURS = [6, 12]; // 6h, 12h
        const BASE_INTERVALS_DAYS = [1, 3, 7, 14, 30, 60, 120]; // 1d, 3d, 7d, 14d, 30d, 60d, 120d
        const INITIAL_EF = 2.5;
        const MIN_EF = 1.3;
        const MAX_EF = 2.8; // Updated max as per requirement

        // --- Plan Mode: Settings ---
        const DEFAULT_SETTINGS = {
            dailyReviewCap: 10,      // 60-70% of daily goal
            dailyNewLimit: 5,        // 20-30% of daily goal
            drillAffectsRoutine: false,
            mode: 'plan'             // 'plan' or 'drill'
        };

        // --- Data structure migration and management ---
        function migrateToNewDataStructure() {
            const oldProgress = loadReviewProgress();
            const newProgress = loadPlanProgress();
            
            // Check if migration is needed
            if (Object.keys(oldProgress).length > 0 && Object.keys(newProgress).length === 0) {
                console.log('Migrating data to new structure...');
                const migrated = {};
                
                for (const [itemId, oldData] of Object.entries(oldProgress)) {
                    migrated[itemId] = {
                        reps: oldData.correctCount || 0,
                        lapses: oldData.totalAttempts ? (oldData.totalAttempts - oldData.correctCount) : 0,
                        ef: INITIAL_EF,
                        stage: Math.max(0, oldData.reviewLevel || 0),
                        last: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() - (SPACED_REPETITION_INTERVALS[oldData.reviewLevel || 0] * 24 * 60 * 60 * 1000) : null,
                        next: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() : null,
                        source: 'legacy'
                    };
                }
                
                savePlanProgress(migrated);
                console.log(`Migrated ${Object.keys(migrated).length} items to new structure`);
            }
        }

        // --- Today Queue Management ---
        function loadTodayQueue() {
            try {
                const today = new Date().toDateString();
                const saved = localStorage.getItem('eng.todayQueue.v1');
                const data = saved ? JSON.parse(saved) : {};
                
                // Check if it's a new day - reset if so
                if (data.date !== today) {
                    const newQueue = { date: today, items: [] };
                    saveTodayQueue(newQueue);
                    return newQueue;
                }
                
                return data;
            } catch (error) {
                console.error('Failed to load today queue:', error);
                const today = new Date().toDateString();
                return { date: today, items: [] };
            }
        }

        function saveTodayQueue(queueData) {
            try {
                localStorage.setItem('eng.todayQueue.v1', JSON.stringify(queueData));
                // Trigger storage event for cross-tab sync
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'eng.todayQueue.v1',
                    newValue: JSON.stringify(queueData),
                    storageArea: localStorage
                }));
            } catch (error) {
                console.error('Failed to save today queue:', error);
            }
        }

        function addToTodayQueue(itemId) {
            const queue = loadTodayQueue();
            const strId = String(itemId);
            if (!queue.items.includes(strId)) {
                queue.items.push(strId);
                saveTodayQueue(queue);
            }
        }

        function removeFromTodayQueue(itemId) {
            const queue = loadTodayQueue();
            const strId = String(itemId);
            const index = queue.items.indexOf(strId);
            if (index > -1) {
                queue.items.splice(index, 1);
                saveTodayQueue(queue);
            }
        }

        function isTodayQueueItem(itemId) {
            const queue = loadTodayQueue();
            return queue.items.includes(String(itemId));
        }

        // --- Data Consolidation System ---
        function loadProgressMerged() {
            try {
                const newProgress = loadPlanProgress();
                const oldProgress = loadReviewProgress();
                const merged = { ...newProgress };
                
                // Merge legacy data if not already present in new system
                for (const [itemId, oldData] of Object.entries(oldProgress)) {
                    const strId = String(itemId);
                    if (!merged[strId]) {
                        merged[strId] = {
                            reps: oldData.correctCount || 0,
                            lapses: oldData.totalAttempts ? (oldData.totalAttempts - oldData.correctCount) : 0,
                            ef: INITIAL_EF,
                            stage: Math.max(0, oldData.reviewLevel || 0),
                            last: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() - (oldData.reviewLevel * 24 * 60 * 60 * 1000) : null,
                            next: oldData.nextReviewDate ? new Date(oldData.nextReviewDate).getTime() : null,
                            source: 'legacy'
                        };
                    }
                }
                
                return merged;
            } catch (error) {
                console.error('Failed to load merged progress:', error);
                return {};
            }
        }

        // --- Timeline Calculation Engine ---
        function getCountdown(nextISO) {
            const now = Date.now();
            const nextTime = nextISO ? new Date(nextISO).getTime() : null;
            
            if (!nextTime || isNaN(nextTime)) {
                return { status: 'later', label: '—', deltaMs: Infinity };
            }
            
            const deltaMs = nextTime - now;
            
            if (deltaMs < 0) {
                // Overdue
                return { status: 'overdue', label: `+${formatDuration(-deltaMs)}`, deltaMs };
            } else if (deltaMs === 0) {
                // Due now
                return { status: 'due', label: '00:00', deltaMs: 0 };
            } else if (deltaMs <= 86400000) {
                // Within 24 hours
                return { status: 'upcoming', label: `남은 ${formatDuration(deltaMs)}`, deltaMs };
            } else {
                // Later than 24 hours
                return { status: 'later', label: formatDateTime(nextTime), deltaMs };
            }
        }

        function formatDuration(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}시간 ${minutes.toString().padStart(2, '0')}분`;
            } else {
                return `${minutes}분`;
            }
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) {
                return `오늘 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return `내일 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            } else {
                return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
        }

        // Utility function to remove duplicates by ID
        function dedupeById(items) {
            const seen = new Set();
            return items.filter(item => {
                const id = getItemId(item);
                if (seen.has(id)) {
                    return false;
                }
                seen.add(id);
                return true;
            });
        }

        function calculateReviewCounts() {
            try {
                const progress = loadProgressMerged();
                const todayQueue = loadTodayQueue();
                const now = Date.now();
                const todayEnd = new Date().setHours(23, 59, 59, 999);
                const tomorrowEnd = todayEnd + 86400000;
                
                const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
                
                // Get items with their timeline status
                const itemsWithStatus = allItems.map(item => {
                    const itemId = String(getItemId(item));
                    const itemProgress = progress[itemId];
                    const inTodayQueue = todayQueue.items.includes(itemId);
                    
                    let status = 'new';
                    let next = null;
                    let countdown = { status: 'later', label: '—', deltaMs: Infinity };
                    
                    if (inTodayQueue) {
                        status = 'todayQueue';
                        countdown = { status: 'due', label: '00:00', deltaMs: 0 };
                    } else if (itemProgress && itemProgress.next && itemProgress.stage >= 0) {
                        next = itemProgress.next;
                        countdown = getCountdown(new Date(next).toISOString());
                        
                        if (next <= now) {
                            status = 'overdue';
                        } else if (next <= todayEnd) {
                            status = 'due';
                        } else if (next <= tomorrowEnd) {
                            status = 'upcoming';
                        } else {
                            status = 'later';
                        }
                    }
                    
                    return {
                        item,
                        itemId,
                        status,
                        next,
                        countdown,
                        progress: itemProgress
                    };
                });
                
                // Categorize for timeline
                const reviewNow = itemsWithStatus.filter(x => 
                    x.status === 'overdue' || x.status === 'due' || x.status === 'todayQueue'
                );
                const upcoming = itemsWithStatus.filter(x => x.status === 'upcoming');
                const later = itemsWithStatus.filter(x => 
                    x.status === 'later' && x.progress && x.progress.stage >= 0
                );
                const newItems = itemsWithStatus.filter(x => x.status === 'new');
                
                return {
                    reviewNow: dedupeById(reviewNow.map(x => x.item)),
                    upcoming: dedupeById(upcoming.map(x => x.item)),
                    later: dedupeById(later.map(x => x.item)),
                    newItems: dedupeById(newItems.map(x => x.item)),
                    timeline: itemsWithStatus.filter(x => x.progress || x.status === 'todayQueue'),
                    counts: {
                        reviewNow: reviewNow.length,
                        upcoming: upcoming.length,
                        later: later.length,
                        new: newItems.length
                    }
                };
            } catch (error) {
                console.error('Failed to calculate review counts:', error);
                return {
                    reviewNow: [],
                    upcoming: [],
                    later: [],
                    newItems: [],
                    timeline: [],
                    counts: { reviewNow: 0, upcoming: 0, later: 0, new: 0 }
                };
            }
        }

        // --- Timeline Widget Rendering ---
        function renderTimeline() {
            console.log('renderTimeline called');
            const timelineContainer = document.getElementById('timeline-container');
            const reviewNowCountEl = document.getElementById('review-now-count');
            const upcomingCountEl = document.getElementById('upcoming-count');
            const newItemsCountEl = document.getElementById('new-items-count');
            
            if (!timelineContainer) {
                console.log('Timeline container not found');
                return;
            }
            
            try {
                const reviewData = calculateReviewCounts();
                const counts = reviewData.counts;
                
                // Update count badges
                if (reviewNowCountEl) reviewNowCountEl.textContent = counts.reviewNow;
                if (upcomingCountEl) upcomingCountEl.textContent = counts.upcoming;
                if (newItemsCountEl) newItemsCountEl.textContent = counts.new;
                
                // Simple message for now
                timelineContainer.innerHTML = '<div class="text-center text-slate-500 py-4"><p>📝 타임라인 시스템이 활성화되었습니다</p><p class="text-sm">복습: ' + counts.reviewNow + ' | 예정: ' + counts.upcoming + ' | 신규: ' + counts.new + '</p></div>';
                
                console.log('Timeline rendered successfully:', counts);
                
            } catch (error) {
                console.error('Failed to render timeline:', error);
                timelineContainer.innerHTML = '<div class="text-center text-red-500 py-4"><p>⚠️ 타임라인을 불러올 수 없습니다</p></div>';
            }
        }

        function getItemDisplayName(item) {
            if (item.ko && item.en) {
                // Truncate long sentences
                const ko = item.ko.length > 30 ? item.ko.substring(0, 30) + '...' : item.ko;
                return ko;
            } else if (item.pattern_ko) {
                return item.pattern_ko;
            } else if (item.pattern) {
                return item.pattern;
            } else {
                return 'Unknown Item';
            }
        }

        function getItemSource(item) {
            if (masterData.cheonilmun && masterData.cheonilmun.includes(item)) return '천일문';
            if (masterData.patterns && masterData.patterns.includes(item)) return '패턴';
            if (masterData.academic && masterData.academic.includes(item)) return '논문';
            return item.type || '기타';
        }

        function pullForwardReview(itemId) {
            try {
                const progress = loadPlanProgress();
                const strId = String(itemId);
                
                if (progress[strId]) {
                    // Update next review time to now
                    progress[strId].next = Date.now();
                    savePlanProgress(progress);
                }
                
                // Add to today queue for immediate availability
                addToTodayQueue(strId);
                
                // Refresh timeline
                renderTimeline();
                updateDailyPlanSummary();
                
                console.log('Pulled forward item for review:', strId);
            } catch (error) {
                console.error('Error pulling forward review:', error);
            }
        }

        // --- Real-time Update System ---
        let countdownInterval = null;
        let updateFrequency = 60000; // 1 minute default

        function startRealTimeUpdates() {
            stopRealTimeUpdates(); // Clear any existing interval
            
            function updateCountdowns() {
                const countdownElements = document.querySelectorAll('.timeline-countdown[data-next]');
                let hasChanges = false;
                
                countdownElements.forEach(element => {
                    const nextTime = element.dataset.next;
                    if (nextTime) {
                        const countdown = getCountdown(new Date(parseInt(nextTime)).toISOString());
                        const newLabel = countdown.label;
                        
                        if (element.textContent !== newLabel) {
                            element.textContent = newLabel;
                            hasChanges = true;
                            
                            // Update color based on status change
                            element.className = element.className.replace(/text-\w+-\d+/g, '');
                            const countdownColors = {
                                'overdue': 'text-red-600 font-semibold',
                                'due': 'text-orange-600 font-semibold', 
                                'upcoming': 'text-blue-600',
                                'later': 'text-gray-500'
                            };
                            element.className += ` ${countdownColors[countdown.status] || countdownColors['later']}`;
                        }
                    }
                });
                
                // If status boundaries were crossed, re-render timeline
                if (hasChanges) {
                    const now = Date.now();
                    const shouldRerender = Array.from(countdownElements).some(element => {
                        const nextTime = parseInt(element.dataset.next);
                        const timeDiff = nextTime - now;
                        // Check if we crossed major boundaries (due/upcoming/later)
                        return Math.abs(timeDiff) < updateFrequency;
                    });
                    
                    if (shouldRerender) {
                        renderTimeline();
                    }
                }
            }
            
            // Initial update
            updateCountdowns();
            
            // Set up recurring updates
            countdownInterval = setInterval(updateCountdowns, updateFrequency);
        }

        function stopRealTimeUpdates() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // Page Visibility API for performance optimization
        function handleVisibilityChange() {
            if (document.hidden) {
                // Tab became inactive - reduce update frequency
                updateFrequency = 300000; // 5 minutes
                if (countdownInterval) {
                    stopRealTimeUpdates();
                    startRealTimeUpdates();
                }
            } else {
                // Tab became active - restore normal frequency and update immediately
                updateFrequency = 60000; // 1 minute
                renderTimeline(); // Full refresh when tab becomes active
                startRealTimeUpdates();
            }
        }

        // Cross-tab synchronization
        function setupCrossTabSync() {
            window.addEventListener('storage', (e) => {
                if (e.key === 'eng.progress.v1' || e.key === 'eng.todayQueue.v1') {
                    console.log('Storage changed in another tab, refreshing timeline');
                    renderTimeline();
                    updateDailyPlanSummary();
                }
            });
        }

        // Page Visibility API for performance optimization  
        function handleVisibilityChange() {
            if (document.hidden) {
                console.log('Tab became inactive');
            } else {
                console.log('Tab became active');
            }
        }

        // --- Plan Mode: Data management ---
        function loadPlanProgress() {
            const saved = localStorage.getItem('eng.progress.v1');
            return saved ? JSON.parse(saved) : {};
        }

        function savePlanProgress(progress) {
            localStorage.setItem('eng.progress.v1', JSON.stringify(progress));
        }

        function loadPlanSettings() {
            const saved = localStorage.getItem('eng.settings.v1');
            return saved ? { ...DEFAULT_SETTINGS, ...JSON.parse(saved) } : DEFAULT_SETTINGS;
        }

        function savePlanSettings(settings) {
            localStorage.setItem('eng.settings.v1', JSON.stringify(settings));
        }

        function loadPlanHistory() {
            const saved = localStorage.getItem('eng.history.v1');
            return saved ? JSON.parse(saved) : {};
        }

        function savePlanHistory(history) {
            localStorage.setItem('eng.history.v1', JSON.stringify(history));
        }

        // --- Plan Mode: Enhanced Scheduler with 6h start ---
        function calculateNextReview(item, grade) {
            // grade: 0-1=wrong, 2=hard, 3=good, 4-5=easy
            const progress = loadPlanProgress();
            const itemId = getItemId(item);
            const strId = String(itemId);
            const current = progress[strId] || {
                reps: 0,
                lapses: 0,
                ef: INITIAL_EF,
                stage: -1,  // -1 = new, 0+ = learning stages
                last: null,
                next: null,
                source: item.type || 'unknown'
            };

            const now = Date.now();
            let newEf = current.ef;
            let newStage = current.stage;
            let intervalMs;

            if (grade <= 1) {
                // Grade 0-1: Wrong answer - back to 6h, reduce EF, add to session requeue
                current.lapses++;
                newEf = Math.max(MIN_EF, current.ef - 0.15);
                newStage = Math.max(0, current.stage); // Don't go below stage 0
                intervalMs = 6 * 60 * 60 * 1000; // 6 hours
                // Note: Session re-queue should be handled by the session manager
            } else if (grade === 2) {
                // Grade 2: Hard - reduce interval to 70% of current, reduce EF slightly
                newEf = Math.max(MIN_EF, current.ef - 0.05);
                if (current.stage === -1) {
                    intervalMs = 6 * 60 * 60 * 1000; // First time: 6h
                } else if (current.stage < BASE_INTERVALS_HOURS.length) {
                    // Still in hour-based intervals
                    const baseHours = BASE_INTERVALS_HOURS[current.stage];
                    intervalMs = Math.max(6 * 60 * 60 * 1000, Math.round(baseHours * 0.7 * 60 * 60 * 1000));
                } else {
                    // Day-based intervals
                    const dayStage = current.stage - BASE_INTERVALS_HOURS.length;
                    const baseDays = BASE_INTERVALS_DAYS[Math.min(dayStage, BASE_INTERVALS_DAYS.length - 1)];
                    intervalMs = Math.max(6 * 60 * 60 * 1000, Math.round(baseDays * 0.7 * 24 * 60 * 60 * 1000));
                }
            } else if (grade === 3) {
                // Grade 3: Good - normal progression, maintain scheduled intervals
                current.reps++;
                if (current.stage === -1) {
                    // First completion: start with 6h interval
                    newStage = 0;
                    intervalMs = BASE_INTERVALS_HOURS[0] * 60 * 60 * 1000; // 6h
                } else {
                    // Advance to next stage
                    newStage = current.stage + 1;
                    if (newStage < BASE_INTERVALS_HOURS.length) {
                        // Still in hour-based intervals (6h, 12h)
                        intervalMs = BASE_INTERVALS_HOURS[newStage] * 60 * 60 * 1000;
                    } else {
                        // Move to day-based intervals (1d, 3d, 7d, ...)
                        const dayStage = newStage - BASE_INTERVALS_HOURS.length;
                        const dayInterval = BASE_INTERVALS_DAYS[Math.min(dayStage, BASE_INTERVALS_DAYS.length - 1)];
                        intervalMs = dayInterval * 24 * 60 * 60 * 1000;
                    }
                }
            } else {
                // Grade 4-5: Easy - advance stage and apply EF multiplier
                current.reps++;
                newEf = Math.min(MAX_EF, current.ef + 0.1);
                
                if (current.stage === -1) {
                    // First completion with easy: start with 6h but boost slightly
                    newStage = 0;
                    intervalMs = BASE_INTERVALS_HOURS[0] * 60 * 60 * 1000; // Still 6h for first
                } else {
                    newStage = current.stage + 1;
                    let baseIntervalMs;
                    
                    if (newStage < BASE_INTERVALS_HOURS.length) {
                        // Hour-based intervals
                        baseIntervalMs = BASE_INTERVALS_HOURS[newStage] * 60 * 60 * 1000;
                    } else {
                        // Day-based intervals
                        const dayStage = newStage - BASE_INTERVALS_HOURS.length;
                        const dayInterval = BASE_INTERVALS_DAYS[Math.min(dayStage, BASE_INTERVALS_DAYS.length - 1)];
                        baseIntervalMs = dayInterval * 24 * 60 * 60 * 1000;
                    }
                    
                    // Apply EF multiplier only to day-based intervals
                    if (newStage >= BASE_INTERVALS_HOURS.length) {
                        intervalMs = Math.round(baseIntervalMs * newEf);
                    } else {
                        intervalMs = baseIntervalMs;
                    }
                }
            }

            const nextReviewDate = now + intervalMs;

            const updated = {
                ...current,
                ef: newEf,
                stage: newStage,
                last: now,
                next: nextReviewDate
            };

            progress[strId] = updated;
            savePlanProgress(progress);

            // Add to today queue if newly completed (stage was -1)
            if (current.stage === -1) {
                addToTodayQueue(strId);
            }

            return {
                ...updated,
                intervalMs,
                intervalDays: Math.round(intervalMs / (24 * 60 * 60 * 1000)),
                grade
            };
        }

        // --- Plan Mode: Queue Generation ---
        function generateDailyPlan() {
            const settings = loadPlanSettings();
            const progress = loadPlanProgress();
            const now = Date.now();
            const todayEnd = new Date().setHours(23, 59, 59, 999);

            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            // Get due items (review queue)
            const dueItems = allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                return itemProgress && itemProgress.next && itemProgress.next <= todayEnd && itemProgress.stage >= 0;
            }).slice(0, settings.dailyReviewCap);

            // Get new items (never studied before)
            const newItems = allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                return !itemProgress || itemProgress.stage === -1;
            });

            // Select new items by source
            const newCheonilmun = newItems.filter(item => item.type === 'grammar' || masterData.cheonilmun.includes(item))
                .slice(0, Math.ceil(settings.dailyNewLimit * 0.7));
            const newPatterns = newItems.filter(item => item.type === 'pattern' || masterData.patterns.includes(item))
                .slice(0, Math.floor(settings.dailyNewLimit * 0.3));

            const selectedNew = [...newCheonilmun, ...newPatterns].slice(0, settings.dailyNewLimit);

            return {
                review: dueItems,
                new: selectedNew,
                summary: {
                    reviewCount: dueItems.length,
                    newCount: selectedNew.length,
                    cheonilmunNew: newCheonilmun.length,
                    patternNew: newPatterns.length,
                    estimatedMinutes: Math.ceil((dueItems.length + selectedNew.length) * 1.2) // ~1.2 min per item
                }
            };
        }

        // --- Plan Mode: UI Updates ---
        function updateDailyPlanSummary() {
            const plan = generateDailyPlan();
            const summaryElement = document.getElementById('daily-plan-summary');
            
            if (summaryElement) {
                const { summary } = plan;
                summaryElement.innerHTML = `
                    <div class="bg-white rounded-lg p-4 border border-indigo-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-lg font-semibold text-indigo-700">오늘의 학습 계획</span>
                            <span class="text-sm text-slate-500">예상 ${summary.estimatedMinutes}분</span>
                        </div>
                        <div class="flex gap-4 text-sm">
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-red-400 rounded-full mr-2"></span>
                                <span>복습 ${summary.reviewCount}개</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>
                                <span>신규 ${summary.newCount}개</span>
                                ${summary.cheonilmunNew > 0 ? `<span class="text-slate-500 ml-1">(천일문 ${summary.cheonilmunNew})</span>` : ''}
                                ${summary.patternNew > 0 ? `<span class="text-slate-500 ml-1">(회화 ${summary.patternNew})</span>` : ''}
                            </div>
                            ${summary.newCount > 0 ? '<div class="flex items-center"><span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span><span>변형 1개</span></div>' : ''}
                        </div>
                        ${summary.reviewCount === 0 && summary.newCount === 0 ? 
                            '<div class="mt-2 text-slate-500 text-sm">🎉 오늘 할 일이 없습니다! 드릴 모드로 자유 학습을 해보세요.</div>' : ''}
                    </div>
                `;
            }
        }

        // 학습 진행 상황을 localStorage에서 로드
        function loadReviewProgress() {
            const saved = localStorage.getItem('reviewProgress');
            return saved ? JSON.parse(saved) : {};
        }

        // 학습 진행 상황을 localStorage에 저장
        function saveReviewProgress(progress) {
            localStorage.setItem('reviewProgress', JSON.stringify(progress));
        }

        // 항목의 고유 ID 생성
        function getItemId(item) {
            if (item.id) return String(item.id);
            if (item.type === 'pattern' && item.pattern) return `pattern_${item.pattern}`;
            if (item.type === 'academic') return item.id;
            return `item_${item.en ? item.en.substring(0, 50) : Math.random()}`;
        }

        // 다음 복습 날짜 계산
        function calculateNextReviewDate(currentLevel, isCorrect) {
            const now = new Date();
            let nextLevel = currentLevel;
            
            // Use current level's interval for scheduling, then update level
            const daysToAdd = SPACED_REPETITION_INTERVALS[currentLevel];
            const nextDate = new Date(now.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            
            if (isCorrect) {
                nextLevel = Math.min(currentLevel + 1, SPACED_REPETITION_INTERVALS.length - 1);
            } else {
                // 틀렸으면 레벨을 뒤로 이동 (최소 0)
                nextLevel = Math.max(0, currentLevel - 1);
            }
            
            return {
                nextReviewDate: nextDate,
                reviewLevel: nextLevel
            };
        }

        // 오늘 복습할 항목 필터링 (Plan 모드용 - 기존 로직)
        function getItemsDueForReview() {
            const progress = loadReviewProgress();
            const today = new Date();
            today.setHours(23, 59, 59, 999); // 오늘 끝까지
            
            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            return allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                
                // 아직 학습하지 않은 항목은 복습 대상이 아님
                if (!itemProgress) {
                    return false;
                }
                
                // 마스터 레벨에 도달한 항목은 복습하지 않음
                if (itemProgress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1) {
                    return false;
                }
                
                // 다음 복습일이 오늘 또는 이전인 항목만 포함
                const nextReviewDate = new Date(itemProgress.nextReviewDate);
                return nextReviewDate <= today;
            });
        }

        // 모든 학습한 항목 반환 (간격 복습 연습용 - 시간 간격 무시)
        function getAllStudiedItems() {
            const progress = loadReviewProgress();
            const allItems = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
            
            return allItems.filter(item => {
                const itemId = getItemId(item);
                const itemProgress = progress[itemId];
                
                // 학습한 적이 있는 항목만 포함 (시간 간격과 마스터 레벨 무시)
                return itemProgress !== undefined;
            });
        }

        // 학습 기록 업데이트
        function recordLearningProgress(item, isCorrect) {
            const progress = loadReviewProgress();
            const itemId = getItemId(item);
            const now = new Date();
            
            if (!progress[itemId]) {
                // 첫 학습
                progress[itemId] = {
                    studiedAt: now.toISOString(),
                    reviewLevel: 0,
                    correctCount: isCorrect ? 1 : 0,
                    totalAttempts: 1,
                    lastReviewResult: isCorrect
                };
            } else {
                // 복습
                progress[itemId].totalAttempts++;
                if (isCorrect) progress[itemId].correctCount++;
                progress[itemId].lastReviewResult = isCorrect;
            }
            
            // 다음 복습 일정 계산
            const nextReview = calculateNextReviewDate(progress[itemId].reviewLevel, isCorrect);
            progress[itemId].nextReviewDate = nextReview.nextReviewDate.toISOString();
            progress[itemId].reviewLevel = nextReview.reviewLevel;
            
            saveReviewProgress(progress);
            return progress[itemId];
        }

        // --- DOM 요소 ---
        const dashboardScreen = document.getElementById('dashboard-screen');
        const moduleScreen = document.getElementById('module-screen');
        const moduleTitle = document.getElementById('module-title');
        const moduleContent = document.getElementById('module-content');
        
        const reviewCard = document.getElementById('review-card');
        const cheonilmunCard = document.getElementById('cheonilmun-card');
        const patternCard = document.getElementById('pattern-card');
        const academicCard = document.getElementById('academic-card');
        const libraryCard = document.getElementById('library-card');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

        // --- Plan Mode DOM elements ---
        const startDailyPlanBtn = document.getElementById('start-daily-plan-btn');
        const planSettingsBtn = document.getElementById('plan-settings-btn');
        const planSettingsModal = document.getElementById('plan-settings-modal');
        const savePlanSettingsBtn = document.getElementById('save-plan-settings');
        const cancelPlanSettingsBtn = document.getElementById('cancel-plan-settings');

        // --- Plan Mode: Session State ---
        let planSession = {
            active: false,
            phase: 'review', // 'review', 'new', 'output', 'summary'
            queue: [],
            currentIndex: 0,
            results: {
                review: { correct: 0, total: 0, items: [] },
                new: { correct: 0, total: 0, items: [] },
                output: { correct: 0, total: 0, items: [] }
            }
        };

        // --- Plan Mode: Session Management ---
        function startPlanSession() {
            const plan = generateDailyPlan();
            
            if (plan.review.length === 0 && plan.new.length === 0) {
                alert('오늘 학습할 내용이 없습니다! 🎉');
                return;
            }

            planSession = {
                active: true,
                phase: 'review',
                queue: [...plan.review],
                currentIndex: 0,
                results: {
                    review: { correct: 0, total: plan.review.length, items: [] },
                    new: { correct: 0, total: plan.new.length, items: [] },
                    output: { correct: 0, total: plan.new.length > 0 ? 1 : 0, items: [] }
                },
                newQueue: [...plan.new]
            };

            showModule('plan');
        }

        function nextPlanPhase() {
            if (planSession.phase === 'review' && planSession.newQueue.length > 0) {
                planSession.phase = 'new';
                planSession.queue = [...planSession.newQueue];
                planSession.currentIndex = 0;
                moduleTitle.textContent = '📚 신규 학습';
                renderQuiz('plan');
            } else if (planSession.phase === 'new' && planSession.results.new.total > 0) {
                planSession.phase = 'output';
                generateOutputExercise();
            } else {
                planSession.phase = 'summary';
                renderPlanSummary();
            }
        }

        function generateOutputExercise() {
            moduleTitle.textContent = '✍️ 변형 연습';
            
            if (planSession.results.new.items.length === 0) {
                nextPlanPhase();
                return;
            }

            const randomNewItem = planSession.results.new.items[
                Math.floor(Math.random() * planSession.results.new.items.length)
            ];

            // Create a paraphrase exercise
            const outputItem = {
                ...randomNewItem,
                isOutput: true,
                originalKo: randomNewItem.ko,
                ko: randomNewItem.ko.replace(/을|를|이|가|은|는/g, '_') + ' (주요 조사를 바꿔서 다시 써보세요)'
            };

            planSession.queue = [outputItem];
            planSession.currentIndex = 0;
            renderQuiz('plan');
        }

        function renderPlanSummary() {
            moduleTitle.textContent = '📊 오늘 학습 완료';
            const { results } = planSession;
            
            const reviewAccuracy = results.review.total > 0 ? 
                Math.round((results.review.correct / results.review.total) * 100) : 0;
            const newAccuracy = results.new.total > 0 ? 
                Math.round((results.new.correct / results.new.total) * 100) : 0;
            
            const totalCorrect = results.review.correct + results.new.correct + results.output.correct;
            const totalItems = results.review.total + results.new.total + results.output.total;
            const overallAccuracy = totalItems > 0 ? Math.round((totalCorrect / totalItems) * 100) : 0;

            moduleContent.innerHTML = `
                <div class="text-center p-8">
                    <div class="text-6xl mb-4">🎉</div>
                    <h3 class="text-2xl font-bold text-indigo-700 mb-6">오늘 학습을 완주했습니다!</h3>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-bold text-red-700">복습</h4>
                            <p class="text-2xl font-bold">${results.review.correct}/${results.review.total}</p>
                            <p class="text-sm text-red-600">${reviewAccuracy}% 정확도</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-green-700">신규</h4>
                            <p class="text-2xl font-bold">${results.new.correct}/${results.new.total}</p>
                            <p class="text-sm text-green-600">${newAccuracy}% 정확도</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-bold text-yellow-700">변형</h4>
                            <p class="text-2xl font-bold">${results.output.correct}/${results.output.total}</p>
                            <p class="text-sm text-yellow-600">${results.output.total > 0 ? Math.round((results.output.correct / results.output.total) * 100) : 0}% 완성도</p>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                        <p class="text-lg"><strong>전체 정확도:</strong> ${overallAccuracy}%</p>
                        <p class="text-sm text-slate-600">내일 복습 예정: ${generateDailyPlan().review.length}개</p>
                    </div>
                    
                    <button id="finish-plan-btn" class="btn btn-primary">완료하기</button>
                </div>
            `;

            // Record today's session in history
            const today = new Date().toISOString().split('T')[0];
            const history = loadPlanHistory();
            history[today] = {
                date: today,
                completed: true,
                results: { ...results },
                accuracy: overallAccuracy,
                timestamp: Date.now()
            };
            savePlanHistory(history);

            // Add event listener for finish button
            document.getElementById('finish-plan-btn').addEventListener('click', () => {
                planSession.active = false;
                showDashboard();
            });
        }

        // --- 이벤트 리스너 ---
        reviewCard.addEventListener('click', () => showModule('review'));
        cheonilmunCard.addEventListener('click', () => showModule('cheonilmun'));
        patternCard.addEventListener('click', () => showModule('pattern'));
        academicCard.addEventListener('click', () => showModule('academic'));
        libraryCard.addEventListener('click', () => showModule('library'));
        backToDashboardBtn.addEventListener('click', showDashboard);

        // --- Plan Mode Event Listeners ---
        startDailyPlanBtn.addEventListener('click', startPlanSession);
        planSettingsBtn.addEventListener('click', () => {
            const settings = loadPlanSettings();
            document.getElementById('daily-review-cap').value = settings.dailyReviewCap;
            document.getElementById('daily-new-limit').value = settings.dailyNewLimit;
            document.getElementById('drill-affects-routine').checked = settings.drillAffectsRoutine;
            planSettingsModal.classList.remove('hidden');
        });

        savePlanSettingsBtn.addEventListener('click', () => {
            const settings = {
                dailyReviewCap: parseInt(document.getElementById('daily-review-cap').value),
                dailyNewLimit: parseInt(document.getElementById('daily-new-limit').value),
                drillAffectsRoutine: document.getElementById('drill-affects-routine').checked,
                mode: 'plan'
            };
            savePlanSettings(settings);
            planSettingsModal.classList.add('hidden');
            updateDailyPlanSummary();
            updateReviewCount();
        });

        cancelPlanSettingsBtn.addEventListener('click', () => {
            planSettingsModal.classList.add('hidden');
        });
        
        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 초기 카운트 표시 (데이터 로딩 전)
            updateReviewCount();
            
            loadOriginalData().then(() => {
                dataLoaded = true;
                
                // Migrate existing data to new structure
                migrateToNewDataStructure();
                
                // Initialize plan UI
                updateDailyPlanSummary();
                updateReviewCount();
                
                // Initialize timeline system
                try {
                    console.log('Initializing timeline system...');
                    renderTimeline();
                    console.log('Timeline initialized successfully');
                } catch (error) {
                    console.error('Timeline initialization failed:', error);
                }
                
                // Page Visibility API setup
                try {
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                    console.log('Visibility change handler added');
                } catch (error) {
                    console.error('Visibility handler failed:', error);
                }
            });
        });

        // --- 원본 데이터 로딩 함수들 ---
        async function loadOriginalData() {
            try {
                // 천일문 데이터 로드
                const cheonilmunResponse = await fetch('./data/cheonilmun_sample.json');
                if (cheonilmunResponse.ok) {
                    const cheonilmunData = await cheonilmunResponse.json();
                    originalData.cheonilmun = [...cheonilmunData];
                    masterData.cheonilmun = [...cheonilmunData];
                }

                // 생활영어 패턴 데이터 로드
                const patternsResponse = await fetch('./data/patterns_numbered.json');
                if (patternsResponse.ok) {
                    const patternsData = await patternsResponse.json();
                    originalData.patterns = [...patternsData];
                    masterData.patterns = [...patternsData];
                }
            } catch (error) {
                console.error('원본 데이터 로드 실패:', error);
                // 오류가 발생해도 앱이 계속 작동하도록 함
            }
        }

        function updateReviewCount() {
            // 데이터가 로드되지 않았으면 0으로 표시
            if (!dataLoaded) {
                document.getElementById('review-count').textContent = '0';
                return;
            }
            
            // 간격 복습 연습용: 모든 학습한 항목 표시
            const studiedItems = getAllStudiedItems();
            const count = studiedItems.length;
            document.getElementById('review-count').textContent = count;
        }

        // --- 화면 전환 로직 ---
        function showDashboard() {
            moduleScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            updateReviewCount();
            renderTimeline();
            updateDailyPlanSummary();
        }

        function showModule(moduleType) {
            dashboardScreen.classList.add('hidden');
            moduleScreen.classList.remove('hidden');

            switch(moduleType) {
                case 'plan':
                    moduleTitle.textContent = planSession.phase === 'review' ? '🧠 복습 단계' : 
                                             planSession.phase === 'new' ? '📚 신규 학습' :
                                             planSession.phase === 'output' ? '✍️ 변형 연습' : '📊 완료';
                    if (planSession.phase !== 'summary') {
                        renderQuiz('plan');
                    }
                    break;
                case 'review':
                    moduleTitle.textContent = '🧠 복습 연습 (Drill)';
                    const studiedItems = getAllStudiedItems();
                    sessionState.queue = [...studiedItems].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    if (sessionState.queue.length === 0) {
                        moduleContent.innerHTML = `
                            <div class="text-center p-8">
                                <p class="text-slate-500 mb-4">복습할 내용이 없습니다!</p>
                                <p class="text-sm text-slate-400 mb-4">💡 팁: 천일문이나 패턴 학습을 완료하면 복습에 추가됩니다.</p>
                                <button id="reset-review-btn" class="btn btn-secondary">복습 데이터 초기화</button>
                            </div>`;
                        const resetBtn = document.getElementById('reset-review-btn');
                        if (resetBtn) {
                            resetBtn.addEventListener('click', () => {
                                if (confirm('복습 데이터를 모두 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                                    resetReviewData();
                                    showDashboard();
                                }
                            });
                        }
                    } else {
                        renderQuiz('review');
                    }
                    break;
                case 'cheonilmun':
                    moduleTitle.textContent = '🏗️ 천일문 구조 분석 (Drill)';
                    sessionState.queue = [...masterData.cheonilmun].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('cheonilmun');
                    break;
                case 'pattern':
                    moduleTitle.textContent = '🗣️ 생활영어 패턴 체화 (Drill)';
                    sessionState.queue = [...masterData.patterns].sort(() => 0.5 - Math.random());
                    sessionState.currentIndex = 0;
                    renderQuiz('pattern');
                    break;
                case 'academic':
                    moduleTitle.textContent = '🔬 나의 문장 분석';
                    renderAcademicModule();
                    break;
                case 'library':
                    moduleTitle.textContent = '🗂️ 전체 자료실';
                    renderLibraryModule();
                    break;
            }
        }

        // --- 상세 해설 템플릿 ---
        function createAnalysisHTML(item) {
            if (!item) return '';
            const analysis = item.analysis || (item.examples && item.examples[0].analysis);
            if (!analysis) return '';

            const vocabHtml = Object.entries(analysis.vocab || {}).map(([word, meaning]) => 
                `<li class="mb-1"><strong class="font-semibold text-slate-800">${word}:</strong> ${meaning}</li>`
            ).join('');

            return `
                <div class="mt-4 p-4 border rounded-lg bg-slate-50 space-y-4">
                    <div>
                        <h4 class="font-bold text-indigo-700">📘 핵심 포인트</h4>
                        <p class="mt-1 text-slate-700">${analysis.point}</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-indigo-700">💡 상세 해설</h4>
                        <p class="mt-1 text-slate-700 leading-relaxed">${analysis.explanation}</p>
                    </div>
                    ${vocabHtml ? `<div>
                        <h4 class="font-bold text-indigo-700">📖 주요 어휘</h4>
                        <ul class="list-disc list-inside text-slate-700 mt-1">${vocabHtml}</ul>
                    </div>` : ''}
                </div>
            `;
        }

        // --- 퀴즈 형식 결정 로직 ---
        function getItemQuizFormat(item) {
            // Determine consistent quiz format based on item characteristics
            if (item.type === 'pattern') {
                return 'composition'; // Pattern items always use composition format
            } else if (item.chapter || item.unit) {
                return 'translation'; // Cheonilmun items always use translation format
            } else {
                return 'fill-in-blank'; // Default format
            }
        }

        function createQuizByFormat(item, format) {
            switch(format) {
                case 'fill-in-blank':
                    return createFillInBlankQuiz(item);
                case 'translation':
                    return createTranslationQuiz(item);
                case 'composition':
                    return createCompositionQuiz(item);
                default:
                    return createTranslationQuiz(item);
            }
        }

        // --- 퀴즈 렌더링 로직 ---
        function renderQuiz(quizType) {
            // Handle Plan mode differently
            if (quizType === 'plan') {
                const queue = planSession.queue;
                const currentIndex = planSession.currentIndex;
                
                if (queue.length === 0 || currentIndex >= queue.length) {
                    nextPlanPhase();
                    return;
                }

                const item = queue[currentIndex];
                const totalItems = queue.length;
                const progressText = `${planSession.phase} ${currentIndex + 1}/${totalItems}`;

                if (item.pattern) {
                    // Pattern item rendering for Plan mode with Gemini AI integration
                    moduleContent.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500 font-medium">${progressText}</span>
                                <span class="text-indigo-500 text-sm font-medium">Plan 모드</span>
                            </div>
                            <div class="bg-slate-50 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-indigo-700 mb-3">패턴: ${item.pattern}</h3>
                                <p class="text-slate-600 mb-4">${item.pattern_ko}</p>
                                <div id="pattern-loading" class="text-center py-4">
                                    <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-indigo-500">
                                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        AI가 개인화된 학습 과제를 생성하고 있습니다...
                                    </div>
                                </div>
                                <div id="pattern-task-content" class="hidden">
                                    <!-- Dynamic task content will be inserted here -->
                                </div>
                            </div>
                            <div id="feedback-area"></div>
                        </div>
                    `;

                    // Generate dynamic task using Gemini AI
                    generatePatternTaskWithGemini(item.pattern, item.pattern_ko).then(taskData => {
                        const loadingDiv = document.getElementById('pattern-loading');
                        const contentDiv = document.getElementById('pattern-task-content');
                        
                        // Validate taskData has required fields
                        const isValidTaskData = taskData && 
                                              typeof taskData === 'object' && 
                                              taskData.instruction && 
                                              typeof taskData.instruction === 'string' &&
                                              taskData.instruction.trim() !== '';
                        
                        if (isValidTaskData && loadingDiv && contentDiv) {
                            loadingDiv.classList.add('hidden');
                            contentDiv.classList.remove('hidden');
                            
                            contentDiv.innerHTML = `
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">📋 학습 과제</h4>
                                        <p class="text-blue-700">${taskData.instruction}</p>
                                        ${taskData.example_input && taskData.example_input.trim() ? `<div class="mt-2 p-2 bg-white rounded border-l-4 border-blue-300">
                                            <p class="text-sm text-gray-600">예시 상황:</p>
                                            <p class="text-gray-800">${taskData.example_input}</p>
                                        </div>` : ''}
                                    </div>
                                    
                                    ${taskData.hints && Array.isArray(taskData.hints) && taskData.hints.length > 0 ? `<div class="bg-yellow-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-yellow-800 mb-1">💡 힌트</h5>
                                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                            ${taskData.hints.filter(hint => hint && typeof hint === 'string').map(hint => `<li>${hint}</li>`).join('')}
                                        </ul>
                                    </div>` : ''}
                                    
                                    ${taskData.sample_answer && taskData.sample_answer.trim() ? `<div class="bg-green-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-green-800 mb-1">💡 예시 답안</h5>
                                        <p class="text-sm text-green-700">${taskData.sample_answer}</p>
                                    </div>` : ''}
                                    
                                    <div>
                                        <label class="block font-medium text-slate-700 mb-2">답변을 작성해주세요:</label>
                                        <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  rows="3" placeholder="여기에 답변을 작성해주세요..."></textarea>
                                    </div>
                                    
                                    <div class="flex gap-3">
                                        <button id="submit-answer-btn" class="btn btn-primary">제출</button>
                                        <button id="skip-answer-btn" class="btn btn-secondary">건너뛰기</button>
                                    </div>
                                </div>
                            `;
                            
                            // Store task data for later evaluation
                            window.currentPatternTask = taskData;
                        } else {
                            // Fallback to enhanced static content if AI fails or returns invalid data
                            console.log('Using fallback content due to invalid AI response:', taskData);
                            loadingDiv.classList.add('hidden');
                            contentDiv.classList.remove('hidden');
                            contentDiv.innerHTML = `
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">📋 학습 과제</h4>
                                        <p class="text-blue-700">이 패턴 "${item.pattern}"을(를) 사용해서 자연스러운 영어 문장을 만들어보세요.</p>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <p class="font-medium mb-2">예시:</p>
                                        <p class="text-slate-800">${item.examples[0]?.en || item.pattern + ' example'}</p>
                                        <p class="text-slate-600">${item.examples[0]?.ko || '이 패턴을 사용한 예시입니다'}</p>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-yellow-800 mb-1">💡 힌트</h5>
                                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                            <li>실제 상황을 떠올리며 문장을 만들어보세요</li>
                                            <li>패턴의 의미를 생각하며 자연스럽게 작성하세요</li>
                                            <li>간단한 문장부터 시작해보세요</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <label class="block font-medium text-slate-700 mb-2">이 패턴을 사용해서 문장을 만들어보세요:</label>
                                        <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  rows="3" placeholder="패턴을 활용한 문장을 작성해주세요..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="submit-answer-btn" class="btn btn-primary">제출</button>
                                        <button id="skip-answer-btn" class="btn btn-secondary">건너뛰기</button>
                                    </div>
                                </div>
                            `;
                            
                            // Set a fallback task data
                            window.currentPatternTask = {
                                task_type: 'creation',
                                instruction: `이 패턴 "${item.pattern}"을(를) 사용해서 자연스러운 영어 문장을 만들어보세요.`
                            };
                        }
                        
                        // Add event listeners
                        const submitBtn = document.getElementById('submit-answer-btn');
                        const skipBtn = document.getElementById('skip-answer-btn');
                        
                        if (submitBtn) {
                            submitBtn.addEventListener('click', () => {
                                const userAnswer = document.getElementById('user-answer')?.value || '';
                                handlePlanAnswer(item, userAnswer);
                            });
                        }
                        
                        if (skipBtn) {
                            skipBtn.addEventListener('click', () => handlePlanAnswer(item, ''));
                        }
                    }).catch(error => {
                        console.error('Pattern task generation failed:', error);
                        // Show enhanced fallback content
                        const loadingDiv = document.getElementById('pattern-loading');
                        const contentDiv = document.getElementById('pattern-task-content');
                        
                        if (loadingDiv && contentDiv) {
                            loadingDiv.classList.add('hidden');
                            contentDiv.classList.remove('hidden');
                            contentDiv.innerHTML = `
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">📋 학습 과제</h4>
                                        <p class="text-blue-700">이 패턴 "${item.pattern}"을(를) 사용해서 자연스러운 영어 문장을 만들어보세요.</p>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg">
                                        <p class="font-medium mb-2">예시:</p>
                                        <p class="text-slate-800">${item.examples[0]?.en || item.pattern + ' example'}</p>
                                        <p class="text-slate-600">${item.examples[0]?.ko || '이 패턴을 사용한 예시입니다'}</p>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <h5 class="font-medium text-yellow-800 mb-1">💡 힌트</h5>
                                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                            <li>실제 상황을 떠올리며 문장을 만들어보세요</li>
                                            <li>패턴의 의미를 생각하며 자연스럽게 작성하세요</li>
                                            <li>간단한 문장부터 시작해보세요</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <label class="block font-medium text-slate-700 mb-2">이 패턴을 사용해서 문장을 만들어보세요:</label>
                                        <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  rows="3" placeholder="패턴을 활용한 문장을 작성해주세요..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="submit-answer-btn" class="btn btn-primary">제출</button>
                                        <button id="skip-answer-btn" class="btn btn-secondary">건너뛰기</button>
                                    </div>
                                </div>
                            `;
                            
                            // Set fallback task data for evaluation
                            window.currentPatternTask = {
                                task_type: 'creation',
                                instruction: `이 패턴 "${item.pattern}"을(를) 사용해서 자연스러운 영어 문장을 만들어보세요.`
                            };
                            
                            // Add event listeners for fallback
                            const submitBtn = document.getElementById('submit-answer-btn');
                            const skipBtn = document.getElementById('skip-answer-btn');
                            
                            if (submitBtn) {
                                submitBtn.addEventListener('click', () => {
                                    const userAnswer = document.getElementById('user-answer')?.value || '';
                                    handlePlanAnswer(item, userAnswer);
                                });
                            }
                            
                            if (skipBtn) {
                                skipBtn.addEventListener('click', () => handlePlanAnswer(item, ''));
                            }
                        }
                    });
                } else {
                    // Grammar/Translation item rendering for Plan mode
                    const itemFormat = getItemQuizFormat(item);
                    
                    if (planSession.phase === 'review') {
                        // Review mode uses consistent format based on item type
                        let reviewContent = '';
                        
                        if (itemFormat === 'translation') {
                            // Use translation format for cheonilmun items
                            reviewContent = `
                                <div class="space-y-6">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-500 font-medium">${progressText}</span>
                                        <span class="text-red-500 text-sm font-medium">복습</span>
                                    </div>
                                    ${item.chapter ? `<div class="text-sm text-slate-500">${item.chapter} → ${item.unit}</div>` : ''}
                                    <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                                        <p class="mt-1 text-indigo-700">${item.analysis ? item.analysis.explanation : '이 문장을 번역해보세요.'}</p>
                                    </div>
                                    <div class="bg-slate-100 p-4 rounded-lg">
                                        <p class="text-lg font-semibold">${item.en}</p>
                                    </div>
                                    <div class="mt-6">
                                        <h4 class="font-semibold text-lg mb-2">📝 퀴즈: 문장 번역하기</h4>
                                        <textarea id="quiz-input" class="w-full h-24 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                                  placeholder="위 영어 문장을 우리말로 번역해보세요..."></textarea>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="check-answer-btn" class="btn btn-primary">정답 확인</button>
                                    </div>
                                    <div id="feedback-area"></div>
                                </div>
                            `;
                        } else {
                            // Use fill-in-the-blank format for other items  
                            const answer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                            const quizHtml = item.en.replace(answer, `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
                            
                            reviewContent = `
                                <div class="space-y-6">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-500 font-medium">${progressText}</span>
                                        <span class="text-red-500 text-sm font-medium">복습</span>
                                    </div>
                                    ${item.chapter ? `<div class="text-sm text-slate-500">${item.chapter} → ${item.unit}</div>` : ''}
                                    <div class="bg-slate-50 p-6 rounded-lg">
                                        <p class="text-slate-600 mb-3">${item.ko}</p>
                                        <div class="text-lg font-mono">${quizHtml}</div>
                                    </div>
                                    <div class="flex gap-3">
                                        <button id="check-answer-btn" class="btn btn-primary">정답 확인</button>
                                    </div>
                                    <div id="feedback-area"></div>
                                </div>
                            `;
                        }
                        
                        moduleContent.innerHTML = reviewContent;
                        
                        document.getElementById('check-answer-btn').addEventListener('click', () => {
                            handlePlanAnswer(item);
                        });
                    } else {
                        // New learning mode uses translation
                        moduleContent.innerHTML = `
                            <div class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500 font-medium">${progressText}</span>
                                    <span class="text-green-500 text-sm font-medium">신규 학습</span>
                                </div>
                                ${item.chapter ? `<div class="text-sm text-slate-500">${item.chapter} → ${item.unit}</div>` : ''}
                                <div class="bg-slate-50 p-6 rounded-lg">
                                    <p class="text-lg font-medium text-slate-800 mb-4">${item.en}</p>
                                    ${item.answer ? `<p class="text-sm text-slate-500">핵심 단어: <strong>${item.answer}</strong></p>` : ''}
                                </div>
                                <div>
                                    <label class="block font-medium text-slate-700 mb-2">한국어로 번역해보세요:</label>
                                    <textarea id="user-answer" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                              rows="3" placeholder="번역을 입력해주세요..."></textarea>
                                </div>
                                <div class="flex gap-3">
                                    <button id="submit-answer-btn" class="btn btn-primary">제출</button>
                                </div>
                                <div id="feedback-area"></div>
                            </div>
                        `;
                        
                        // Add event listeners for non-pattern items
                        const submitBtn = document.getElementById('submit-answer-btn');
                        const userAnswerField = document.getElementById('user-answer');

                        if (submitBtn) {
                            submitBtn.addEventListener('click', () => handlePlanAnswer(item));
                        }
                        if (userAnswerField) {
                            userAnswerField.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    handlePlanAnswer(item);
                                }
                            });
                            userAnswerField.focus();
                        }
                    }
                }

                return;
            }

            // Original Drill mode logic
            if (sessionState.queue.length === 0 || sessionState.currentIndex >= sessionState.queue.length) {
                const resetButtonHtml = quizType === 'review' ? 
                    `<div class="mt-4"><button id="reset-review-btn" class="btn btn-secondary">복습 데이터 초기화</button></div>` : '';
                moduleContent.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-slate-500">모든 학습을 완료했습니다!</p>
                        ${resetButtonHtml}
                    </div>`;
                
                if (quizType === 'review') {
                    const resetBtn = document.getElementById('reset-review-btn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            if (confirm('복습 데이터를 모두 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                                resetReviewData();
                                showDashboard();
                            }
                        });
                    }
                }
                return;
            }

            const item = sessionState.queue[sessionState.currentIndex];
            let header = '';
            let quizContent = '';

            // Determine consistent format based on item characteristics, not quiz type
            const itemFormat = getItemQuizFormat(item);
            
            switch(quizType) {
                case 'review':
                    header = `복습 퀴즈 (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createQuizByFormat(item, itemFormat); // Use consistent format
                    break;
                case 'cheonilmun':
                    header = `${item.chapter} - ${item.unit} (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createQuizByFormat(item, itemFormat); // Use consistent format
                    break;
                case 'pattern':
                    header = `패턴 응용 퀴즈 (${sessionState.currentIndex + 1} / ${sessionState.queue.length})`;
                    quizContent = createQuizByFormat(item, itemFormat); // Use consistent format
                    break;
            }

            const resetButtonHtml = quizType === 'review' ? 
                `<button id="reset-review-quiz-btn" class="btn btn-secondary ml-2">데이터 초기화</button>` : '';
            
            moduleContent.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">${header}</h3>
                        ${resetButtonHtml}
                    </div>
                    <div id="quiz-content-area" class="mt-4">${quizContent}</div>
                    <div id="feedback-container" class="mt-4"></div>
                    <div id="quiz-nav" class="flex gap-4 mt-6">
                        <button id="check-answer-btn" class="btn btn-primary w-full">정답 확인</button>
                    </div>
                </div>
            `;
            
            document.getElementById('check-answer-btn').addEventListener('click', () => checkAnswer(quizType, item));
            
            if (quizType === 'review') {
                const resetQuizBtn = document.getElementById('reset-review-quiz-btn');
                if (resetQuizBtn) {
                    resetQuizBtn.addEventListener('click', () => {
                        if (confirm('복습 데이터를 모두 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                            resetReviewData();
                            showDashboard();
                        }
                    });
                }
            }
        }

        function createFillInBlankQuiz(item) {
            let koText, quizHtml, answer;
            if (item.type === 'pattern') {
                const example = item.examples[0];
                koText = example.ko;
                answer = item.pattern;
                const escapedPattern = item.pattern.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                quizHtml = example.en.replace(new RegExp(escapedPattern, 'i'), `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            } else {
                koText = item.ko;
                answer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                quizHtml = item.en.replace(answer, `<input type="text" id="quiz-input" class="w-40 border-b-2 border-slate-400 focus:border-indigo-500 outline-none text-center bg-transparent">`);
            }
            return `<div class="bg-slate-100 p-4 rounded-lg">
                        <p class="text-lg">${koText}</p>
                        <div class="mt-2 text-xl font-mono">${quizHtml}</div>
                    </div>`;
        }
        
        function createTranslationQuiz(item) {
            return `
                <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <p class="mt-1 text-indigo-700">${item.analysis.explanation}</p>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg">
                    <p class="text-lg font-semibold">${item.en}</p>
                </div>
                <div class="mt-6">
                    <h4 class="font-semibold text-lg mb-2">📝 퀴즈: 문장 번역하기</h4>
                    <textarea id="quiz-input" class="w-full h-24 p-3 border rounded-lg" placeholder="위 영어 문장을 우리말로 번역해보세요..."></textarea>
                </div>`;
        }

        function createCompositionQuiz(item) {
            return `
                <div class="bg-emerald-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-emerald-800">🗣️ 오늘의 패턴: <span class="font-bold">${item.pattern}</span></h4>
                    <p class="text-emerald-600">${item.pattern_ko}</p>
                </div>
                <div class="space-y-3 mb-6">
                    ${item.examples.map(ex => `<div class="bg-slate-100 p-3 rounded-md"><p>${ex.en}</p><p class="text-sm text-slate-500">${ex.ko}</p></div>`).join('')}
                </div>
                <div>
                    <h4 class="font-semibold text-lg mb-2">📝 퀴즈: 응용 작문하기</h4>
                    <p class="text-slate-600 mb-2">상황: ${item.examples[1] ? item.examples[1].ko : '자유롭게 작문해보세요.'}</p>
                    <input type="text" id="quiz-input" class="w-full p-2 border rounded-lg" placeholder="위 패턴을 사용하여 작문해보세요...">
                </div>`;
        }

        function checkAnswer(quizType, item) {
            const feedbackContainer = document.getElementById('feedback-container');
            const quizInput = document.getElementById('quiz-input');
            const userAnswer = quizInput ? quizInput.value.trim() : '';
            let feedbackHtml = '';
            let isCorrect = true; // Default for non-review modes

            switch(quizType) {
                case 'plan':
                    // Plan mode uses different grading system
                    handlePlanAnswer(item, userAnswer);
                    return;
                case 'review':
                    const answer = item.type === 'pattern' ? item.pattern : (item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, ''));
                    isCorrect = userAnswer.toLowerCase() === answer.toLowerCase();
                    
                    // 학습 진행 상황 기록 (legacy system for Drill mode)
                    const progress = recordLearningProgress(item, isCorrect);
                    
                    // 다음 복습 정보 생성
                    const nextReviewDate = new Date(progress.nextReviewDate);
                    const nextReviewText = nextReviewDate.toLocaleDateString('ko-KR');
                    const intervalText = progress.reviewLevel < SPACED_REPETITION_INTERVALS.length - 1 ? 
                        `${SPACED_REPETITION_INTERVALS[progress.reviewLevel]}일 후` : '마스터 완료';
                    
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                                      <p class="font-bold">${isCorrect ? '정답입니다! 🎉' : '아쉬워요!'}</p>
                                      <p><strong>정답:</strong> ${answer}</p>
                                      <div class="mt-3 p-3 bg-slate-50 rounded-lg text-sm">
                                          <p><strong>📊 복습 진행률:</strong> ${progress.correctCount}/${progress.totalAttempts} (${Math.round(progress.correctCount/progress.totalAttempts*100)}%)</p>
                                          <p><strong>📅 다음 복습:</strong> ${progress.reviewLevel >= SPACED_REPETITION_INTERVALS.length - 1 ? '완료됨 🎊' : `${nextReviewText} (${intervalText})`}</p>
                                          <p><strong>🔄 복습 단계:</strong> ${progress.reviewLevel + 1}/${SPACED_REPETITION_INTERVALS.length}</p>
                                      </div>
                                  </div>`;
                    break;
                case 'cheonilmun':
                    // 천일문 학습 완료 시에도 학습 기록 저장
                    recordLearningProgress(item, true);
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">모범 번역</p>
                                      <p>${item.ko}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">✅ 이 문장이 복습 시스템에 추가되었습니다!</p>
                                      </div>
                                  </div>`;
                    break;
                case 'pattern':
                    // 패턴 학습 완료 시에도 학습 기록 저장
                    recordLearningProgress(item, true);
                    const exampleAnswer = item.examples[1] ? item.examples[1].en : "Great job applying the pattern!";
                    feedbackHtml = `<div class="p-4 border-l-4 rounded-md feedback-correct">
                                      <p class="font-bold">좋은 시도입니다!</p>
                                      <p><strong>모범 답안 예시:</strong> ${exampleAnswer}</p>
                                      <div class="mt-3 p-3 bg-green-50 rounded-lg text-sm">
                                          <p class="text-green-700">✅ 이 패턴이 복습 시스템에 추가되었습니다!</p>
                                      </div>
                                  </div>`;
                    break;
            }
            
            feedbackContainer.innerHTML = feedbackHtml + createAnalysisHTML(item);

            const quizNav = document.getElementById('quiz-nav');
            if (sessionState.currentIndex < sessionState.queue.length - 1) {
                quizNav.innerHTML = `<button id="next-quiz-btn" class="btn btn-primary w-full">다음 문제</button>`;
                document.getElementById('next-quiz-btn').addEventListener('click', () => {
                    sessionState.currentIndex++;
                    renderQuiz(quizType);
                });
            } else {
                const completionMessage = quizType === 'review' ? '복습 완료! 🎉' : '학습 완료';
                quizNav.innerHTML = `<button id="finish-quiz-btn" class="btn btn-secondary w-full">${completionMessage}</button>`;
                document.getElementById('finish-quiz-btn').addEventListener('click', () => {
                    // 복습 카운트 업데이트
                    updateReviewCount();
                    showDashboard();
                });
            }
        }

        // --- Plan Mode: Answer Handling ---
        function handlePlanAnswer(item, userAnswer) {
            const itemId = String(getItemId(item));
            
            // Check if this item has already been processed in this session
            const alreadyProcessed = planSession.results[planSession.phase].items.some(
                processedItem => getItemId(processedItem) === getItemId(item)
            );
            
            // Determine grade based on content and user input
            let grade = 3; // Default: good
            let isCorrect = true;
            let result = null;
            
            // For review items, check accuracy
            if (planSession.phase === 'review') {
                // For pattern items, use AI evaluation instead of simple matching
                if (item.type === 'pattern' && item.pattern) {
                    // Handle pattern items with AI evaluation
                    handlePatternReviewAnswer(item, userAnswer, alreadyProcessed);
                    return;
                } else {
                    // For non-pattern items, check format and handle accordingly
                    const itemFormat = getItemQuizFormat(item);
                    const quizInput = document.getElementById('quiz-input');
                    const actualAnswer = quizInput ? quizInput.value.trim() : '';
                    
                    if (!actualAnswer) {
                        grade = 0; // No answer
                        isCorrect = false;
                    } else if (itemFormat === 'translation') {
                        // For translation format, we don't have strict matching
                        // Just check if user provided some answer (lenient grading for translation)
                        if (actualAnswer.length > 0) {
                            grade = 3; // Good - user provided translation
                            isCorrect = true; // Consider it correct since translation can vary
                        } else {
                            grade = 0; // No answer
                            isCorrect = false;
                        }
                    } else {
                        // For fill-in-the-blank format, use strict matching
                        const expectedAnswer = item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, '');
                        if (actualAnswer.toLowerCase() === expectedAnswer.toLowerCase()) {
                            grade = 4; // Easy/correct
                        } else {
                            grade = 1; // Wrong
                            isCorrect = false;
                        }
                    }
                }
            }
            // For new items and output, we assume they tried (grade 3)
            
            // Update SM-2 schedule only if not already processed
            if (!alreadyProcessed) {
                result = calculateNextReview(item, grade);
                
                // Remove from today queue if this was a first exposure
                if (isTodayQueueItem(itemId)) {
                    removeFromTodayQueue(itemId);
                }
                
                // Record result in plan session
                planSession.results[planSession.phase].items.push({
                    ...item,
                    grade,
                    isCorrect,
                    userAnswer
                });
                
                if (isCorrect) {
                    planSession.results[planSession.phase].correct++;
                }
            } else {
                // For already processed items, get current progress for display
                const progress = loadPlanProgress();
                const currentProgress = progress[itemId];
                if (currentProgress) {
                    result = {
                        ...currentProgress,
                        intervalDays: Math.round((currentProgress.next - currentProgress.last) / (24 * 60 * 60 * 1000))
                    };
                }
                console.log('Item already processed in this session, not updating review schedule');
            }
            
            // Show feedback
            let feedbackHtml = '';
            if (planSession.phase === 'review') {
                const itemFormat = getItemQuizFormat(item);
                const nextDate = new Date(result.next).toLocaleDateString('ko-KR');
                
                if (itemFormat === 'translation') {
                    // For translation format, show model translation
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                            <p class="font-bold">${isCorrect ? '좋은 번역입니다! 🎉' : '다시 한번!'}</p>
                            <p><strong>모범 번역:</strong> ${item.ko}</p>
                            <div class="mt-2 text-sm text-slate-600">
                                <p>다음 복습: ${nextDate} (${result.intervalDays}일 후)</p>
                                <p>EF: ${result.ef.toFixed(1)}, 단계: ${result.stage + 1}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // For fill-in-blank format, show exact answer
                    const correctAnswer = item.type === 'pattern' ? item.pattern : (item.answer || item.en.split(' ').pop().replace(/[.,!?]/g, ''));
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                            <p class="font-bold">${isCorrect ? '정답입니다! 🎉' : '다시 한번!'}</p>
                            <p><strong>정답:</strong> ${correctAnswer}</p>
                            <div class="mt-2 text-sm text-slate-600">
                                <p>다음 복습: ${nextDate} (${result.intervalDays}일 후)</p>
                                <p>EF: ${result.ef.toFixed(1)}, 단계: ${result.stage + 1}</p>
                            </div>
                        </div>
                    `;
                }
            } else if (planSession.phase === 'new') {
                feedbackHtml = `
                    <div class="p-4 border-l-4 rounded-md feedback-correct">
                        <p class="font-bold">새로운 학습! 📚</p>
                        <p><strong>모범 번역:</strong> ${item.ko}</p>
                        <div class="mt-2 text-sm text-green-600">
                            <p>✅ 내일부터 복습 일정에 추가됩니다!</p>
                        </div>
                    </div>
                `;
            } else if (planSession.phase === 'output') {
                // Check if this is a pattern item and use Gemini AI evaluation
                if (item.pattern && userAnswer && window.currentPatternTask) {
                    // Use Gemini AI to evaluate pattern answer
                    const taskType = window.currentPatternTask.task_type || 'creation';
                    
                    // Show loading feedback first
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md feedback-correct">
                            <div class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="font-bold">AI가 답변을 평가하고 있습니다...</p>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                    
                    // Evaluate with Gemini AI
                    evaluatePatternAnswerWithGemini(item.pattern, item.pattern_ko, userAnswer, taskType).then(evaluation => {
                        if (evaluation && typeof evaluation === 'object') {
                            feedbackHtml = `
                                <div class="p-4 border-l-4 rounded-md ${evaluation.is_correct ? 'feedback-correct' : 'feedback-incorrect'}">
                                    <p class="font-bold">${evaluation.is_correct ? '훌륭합니다! 🎉' : '좋은 시도입니다! 💪'}</p>
                                    <div class="mt-3 space-y-3">
                                        <div class="bg-white p-3 rounded-lg">
                                            <p class="font-medium text-gray-800">피드백:</p>
                                            <p class="text-gray-700">${evaluation.feedback || '좋은 시도였습니다!'}</p>
                                        </div>
                                        
                                        ${evaluation.corrected_version && evaluation.corrected_version.trim() ? `
                                            <div class="bg-blue-50 p-3 rounded-lg">
                                                <p class="font-medium text-blue-800">개선된 답안:</p>
                                                <p class="text-blue-700">${evaluation.corrected_version}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${evaluation.suggestions && Array.isArray(evaluation.suggestions) && evaluation.suggestions.length > 0 ? `
                                            <div class="bg-yellow-50 p-3 rounded-lg">
                                                <p class="font-medium text-yellow-800">개선 제안:</p>
                                                <ul class="text-yellow-700 list-disc list-inside space-y-1">
                                                    ${evaluation.suggestions.filter(s => s && typeof s === 'string').map(suggestion => `<li>${suggestion}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        
                                        ${evaluation.detailed_comparison ? `
                                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                                <p class="font-medium text-purple-800 mb-3">🔍 상세 비교 분석</p>
                                                <div class="space-y-3 text-sm">
                                                    ${evaluation.detailed_comparison.grammar_analysis ? `
                                                        <div class="border-l-4 border-purple-300 pl-3">
                                                            <p class="font-medium text-purple-700">문법 분석:</p>
                                                            <p class="text-purple-600">${evaluation.detailed_comparison.grammar_analysis}</p>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${evaluation.detailed_comparison.tone_analysis ? `
                                                        <div class="border-l-4 border-purple-300 pl-3">
                                                            <p class="font-medium text-purple-700">톤/뉘앙스 분석:</p>
                                                            <p class="text-purple-600">${evaluation.detailed_comparison.tone_analysis}</p>
                                                        </div>
                                                    ` : ''}
                                                    
                                                    ${evaluation.detailed_comparison.usage_analysis ? `
                                                        <div class="border-l-4 border-purple-300 pl-3">
                                                            <p class="font-medium text-purple-700">사용법 분석:</p>
                                                            <p class="text-purple-600">${evaluation.detailed_comparison.usage_analysis}</p>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="bg-green-50 p-3 rounded-lg text-sm">
                                            <p class="text-green-700">
                                                📊 AI 평가 점수: ${evaluation.score || 3}/5 | 
                                                ✅ 이 패턴이 복습 시스템에 추가되었습니다!
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Fallback to enhanced feedback with basic comparison if AI fails
                            console.log('AI evaluation failed, using enhanced fallback');
                            feedbackHtml = `
                                <div class="p-4 border-l-4 rounded-md feedback-correct">
                                    <p class="font-bold">패턴 연습 완료! ✍️</p>
                                    <div class="mt-3 space-y-3">
                                        <div class="bg-white p-3 rounded-lg">
                                            <p class="font-medium text-gray-800">작성하신 답변:</p>
                                            <p class="text-gray-700">"${userAnswer}"</p>
                                        </div>
                                        
                                        <div class="bg-blue-50 p-3 rounded-lg">
                                            <p class="font-medium text-blue-800">패턴:</p>
                                            <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                                        </div>
                                        
                                        ${item.examples && item.examples.length > 0 ? `
                                            <div class="bg-gray-50 p-3 rounded-lg">
                                                <p class="font-medium text-gray-800">참고 예시:</p>
                                                <p class="text-gray-700">${item.examples[0].en}</p>
                                                <p class="text-gray-600 text-sm">${item.examples[0].ko}</p>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="bg-yellow-50 p-3 rounded-lg">
                                            <p class="font-medium text-yellow-800">💡 학습 팁:</p>
                                            <p class="text-yellow-700 text-sm">패턴을 자연스럽게 사용하는 것이 중요합니다. 다양한 상황에서 이 패턴을 활용해보세요!</p>
                                        </div>
                                        
                                        <div class="bg-green-50 p-3 rounded-lg text-sm">
                                            <p class="text-green-700">✅ 이 패턴이 복습 시스템에 추가되었습니다!</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                        
                        // Add next button
                        const nextButton = `<button id="next-plan-btn" class="btn btn-primary">다음 →</button>`;
                        document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                        
                        document.getElementById('next-plan-btn').addEventListener('click', () => {
                            planSession.currentIndex++;
                            renderQuiz('plan');
                        });
                    }).catch(error => {
                        console.error('Pattern evaluation failed:', error);
                        // Enhanced fallback feedback with basic comparison
                        feedbackHtml = `
                            <div class="p-4 border-l-4 rounded-md feedback-correct">
                                <p class="font-bold">패턴 연습 완료! ✍️</p>
                                <div class="mt-3 space-y-3">
                                    <div class="bg-white p-3 rounded-lg">
                                        <p class="font-medium text-gray-800">작성하신 답변:</p>
                                        <p class="text-gray-700">"${userAnswer}"</p>
                                    </div>
                                    
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <p class="font-medium text-blue-800">패턴:</p>
                                        <p class="text-blue-700">${item.pattern} - ${item.pattern_ko}</p>
                                    </div>
                                    
                                    ${item.examples && item.examples.length > 0 ? `
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <p class="font-medium text-gray-800">참고 예시:</p>
                                            <p class="text-gray-700">${item.examples[0].en}</p>
                                            <p class="text-gray-600 text-sm">${item.examples[0].ko}</p>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="bg-yellow-50 p-3 rounded-lg">
                                        <p class="font-medium text-yellow-800">💡 학습 팁:</p>
                                        <p class="text-yellow-700 text-sm">패턴을 자연스럽게 사용하는 것이 중요합니다. 다양한 상황에서 이 패턴을 활용해보세요!</p>
                                    </div>
                                    
                                    <div class="bg-green-50 p-3 rounded-lg text-sm">
                                        <p class="text-green-700">✅ 이 패턴이 복습 시스템에 추가되었습니다!</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
                        
                        // Add next button
                        const nextButton = `<button id="next-plan-btn" class="btn btn-primary">다음 →</button>`;
                        document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
                        
                        document.getElementById('next-plan-btn').addEventListener('click', () => {
                            planSession.currentIndex++;
                            renderQuiz('plan');
                        });
                    });
                    
                    // Early return to avoid showing the next button twice
                    return;
                } else {
                    // Regular output phase feedback for non-pattern items
                    feedbackHtml = `
                        <div class="p-4 border-l-4 rounded-md feedback-correct">
                            <p class="font-bold">변형 연습 완료! ✍️</p>
                            <p><strong>원문:</strong> ${item.originalKo || item.ko}</p>
                            <div class="mt-2 text-sm text-yellow-600">
                                <p>💪 창작 연습이 완료되었습니다!</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('feedback-area').innerHTML = feedbackHtml + createAnalysisHTML(item);
            
            // Show next button
            const nextButton = `<button id="next-plan-btn" class="btn btn-primary">다음 →</button>`;
            document.getElementById('feedback-area').innerHTML += `<div class="mt-4">${nextButton}</div>`;
            
            document.getElementById('next-plan-btn').addEventListener('click', () => {
                planSession.currentIndex++;
                renderQuiz('plan');
            });
        }

        function renderAcademicModule() {
            moduleContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">논문/원서 문장 입력</h3>
                <p class="mb-4 text-slate-600">분석하고 싶은 문장을 입력하면, 구조와 어휘를 분석하고 개인 복습 데이터에 추가해 드립니다.</p>
                <textarea id="academic-input" class="w-full h-32 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="여기에 영어 문장을 붙여넣으세요..."></textarea>
                <div id="analysis-output" class="mt-4"></div>
                <button id="analyze-btn" class="btn btn-secondary w-full py-2 rounded-lg mt-4">분석 및 저장하기</button>
            `;
            document.getElementById('analyze-btn').addEventListener('click', () => {
                const academicInput = document.getElementById('academic-input');
                if (!academicInput) return;
                const text = academicInput.value.trim();
                if (text) {
                    const now = new Date();
                    const newEntry = {
                        type: 'academic',
                        id: `academic_${Date.now()}`,
                        en: text,
                        ko: '(사용자 입력 문장)',
                        answer: text.split(' ').pop().replace(/[.,!?]/g, ''),
                        analysis: { point: '사용자 입력 문장', explanation: '이 문장은 개인 데이터베이스에 저장되어 주기적으로 복습 퀴즈에 출제됩니다.', vocab: {} },
                        createdAt: now.toISOString(),
                        createdAtFormatted: now.toLocaleDateString('ko-KR') + ' ' + now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                    };
                    masterData.academic.push(newEntry);
                    
                    // 자동으로 첫 복습 일정 설정 (1일 후)
                    recordLearningProgress(newEntry, true);
                    
                    document.getElementById('analysis-output').innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800">🔬 저장 완료</h4>
                            <p class="mt-2 text-green-700">문장이 개인 데이터베이스에 저장되었습니다.</p>
                            <p class="mt-1 text-green-600 text-sm">📅 내일부터 복습 퀴즈에 포함됩니다!</p>
                        </div>`;
                    academicInput.value = '';
                    
                    // 복습 카운트 업데이트
                    updateReviewCount();
                }
            });
        }

        function renderLibraryModule() {
            const libraryContent = document.createElement('div');
            libraryContent.id = 'library-content';
            libraryContent.className = 'max-h-[50vh] overflow-y-auto custom-scrollbar pr-2';
            
            moduleContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <input type="text" id="library-search-input" class="flex-1 p-3 border rounded-lg mr-4" placeholder="학습한 내용 검색하기 (예: 분사구문, was going to)...">
                    <button id="reset-library-btn" class="btn btn-secondary whitespace-nowrap">라이브러리 초기화</button>
                </div>
            `;
            moduleContent.appendChild(libraryContent);
            
            const searchInput = document.getElementById('library-search-input');
            const resetLibraryBtn = document.getElementById('reset-library-btn');
            
            if (resetLibraryBtn) {
                resetLibraryBtn.addEventListener('click', () => {
                    if (confirm('학습 라이브러리의 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                        resetLibraryData();
                        filterAndRender(); // Refresh the display
                        updateReviewCount(); // Update dashboard count
                    }
                });
            }

            function filterAndRender() {
                const searchTerm = searchInput.value.toLowerCase();
                const allData = [...masterData.cheonilmun, ...masterData.patterns, ...masterData.academic];
                
                const filteredData = allData.filter(item => {
                    if (item.pattern) {
                        // Pattern data structure
                        const patternMatch = item.pattern.toLowerCase().includes(searchTerm);
                        const examplesMatch = item.examples && item.examples.some(ex => 
                            (ex.ko && ex.ko.toLowerCase().includes(searchTerm)) || 
                            (ex.en && ex.en.toLowerCase().includes(searchTerm))
                        );
                        return patternMatch || examplesMatch;
                    } else {
                        // Cheonilmun or Academic data structure
                        const koMatch = item.ko && item.ko.toLowerCase().includes(searchTerm);
                        const enMatch = item.en && item.en.toLowerCase().includes(searchTerm);
                        const analysisMatch = item.analysis && item.analysis.point && 
                            item.analysis.point.toLowerCase().includes(searchTerm);
                        return koMatch || enMatch || analysisMatch;
                    }
                });

                if (filteredData.length === 0) {
                    libraryContent.innerHTML = `<p class="text-center text-slate-500">검색 결과가 없습니다.</p>`;
                    return;
                }

                libraryContent.innerHTML = filteredData.map(item => {
                    const timestampHtml = item.createdAtFormatted ? 
                        `<p class="text-xs text-slate-400 mt-1">등록일: ${item.createdAtFormatted}</p>` : '';
                    
                    if (item.pattern) {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-emerald-700">${item.pattern}</p>
                                    <p class="text-sm text-slate-600">${item.examples[0].en}</p>
                                    ${timestampHtml}
                                </div>`;
                    } else {
                        return `<div class="p-3 mb-2 border rounded-md bg-slate-50">
                                    <p class="font-semibold text-sky-700">${item.unit || '나의 문장'}</p>
                                    <p class="text-sm text-slate-600">${item.en}</p>
                                    ${timestampHtml}
                                </div>`;
                    }
                }).join('');
            }

            searchInput.addEventListener('input', filterAndRender);
            filterAndRender(); // 초기 렌더링
        }

        // --- 데이터 초기화 함수들 ---
        function resetReviewData() {
            // 복습 진행 상황 초기화 (학습 기록 삭제)
            localStorage.removeItem('reviewProgress');
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('복습 데이터가 초기화되었습니다. 학습 기록이 모두 삭제되어 처음부터 다시 시작할 수 있습니다.');
        }

        function resetLibraryData() {
            // 모든 데이터 삭제 (천일문, 패턴, 사용자 추가 데이터)
            masterData.cheonilmun.length = 0;
            masterData.patterns.length = 0;
            masterData.academic.length = 0;
            
            // 원본 데이터로 복원 
            masterData.cheonilmun = [...originalData.cheonilmun];
            masterData.patterns = [...originalData.patterns];
            
            // 데이터 로딩 상태는 여전히 유효
            dataLoaded = true;
            
            // Update the dashboard count
            updateReviewCount();
            
            // Show success message
            alert('라이브러리 데이터가 초기화되었습니다.');
        }
    </script>
</body>
</html>

